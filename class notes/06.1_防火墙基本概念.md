# 01_防火墙基本概念

### 1.防火墙基础知识

防火墙属于网络安全设备，其主要作用是通过各种配置，拒绝非授权的访问，保护网络安全。防火墙作为一个独立的硬件设备，可以通过访问控制、身份验证、数据加密、`vpn`技术等安全功能，形成一个信息进出的“屏障”。

防火墙不仅可以确保内部网络安全地访问互联网，同时还可以保护内部网络的安全。

![image-20250902151040442](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250902151040472.png)

#### 1.1.防火墙的发展历史 

![image-20250902152730898](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250902152730929.png)

**包过滤防火墙**

包过滤防火墙属于第一代防火墙。这种防火墙通过配置访问控制列表对数据报文进行过滤，并根据策略转发或丢弃数据报文，其设计简单且易于实现。但是包过滤不检查会话状态且不分析数据，攻击者可以使用假冒地址进行欺骗，然后通过防火墙。

**代理防火墙**

代理防火墙属于第二代防火墙。代理检查来自用户的请求，匹配安全策略后代表外部用户与真正的服务器建立连接，转发外部用户请求。代理防火墙安全性较高，但软件限制处理速度，同时需要为每一种应用开发对应的代理服务，开发周期长且升级困难。

**状态检测防火墙**

状态检测防火墙属于第三代防火墙。状态检测属于包过滤技术的延申，对基于连接状态的数据报文进行检查时，它会考虑数据报文前后的关系，这意味着每个数据报文都不是独立存在的，而是前后有状态联系的。基于这样的状态联系，发展出了状态检测技术。状态检测防火墙通过动态分析激活的`TCP`会话和`UDP`会话状态采取动作，处理速度快且安全性高。

**统一威胁管理管理防火墙**

统一威胁管理（`United Threat Management,UTM`）防火墙属于新一代防火墙。除了具备基本防火墙功能外，它还将入侵检测、访问控制、防病毒、`URL`过滤等功能继承于一身，实现全面的安全防护功能。

**下一代防火墙**

下一代防火墙（`Next Generation Firewall,NFGW`）最初的目的是解决`UTM`防火墙运行多个功能后性能下降的问题。`2009`年`Gartner`对下一代防火墙重新进行了定义，明确了下一代防火墙除了具有`UTM`防火墙功能外，还可以基于用户、应用、内容进行管控。

------

#### 1.2.ensp中防火墙Web界面

**导入防火墙镜像：**在`ensp`中选择`USG6000v`设备，右键运行会出现如下弹框，点击浏览选择我分享的镜像即可。

![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250912162447940.png)

**拓扑：**

![image-20250912162428369](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250912162428431.png)

**设置Cloud：**

![image-20250912162348329](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250912162348400.png)

**防火墙默认密码：**`Admin@123`

![image-20250912162752317](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250912162752383.png)

**配置管理口：**

```
interface GigabitEthernet0/0/0
 undo shutdown
 ip binding vpn-instance default	# 绑定虚拟系统（VPN实例）
 ip address 192.168.10.100 255.255.255.0	# 地址，与你的cloud配置一个网段
 alias GE0/METH	# 别名，为物理端口设置了一个易于识别和记忆的别名。
 service-manage http permit
 service-manage https permit
 service-manage ping permit
 service-manage ssh permit
 service-manage snmp permit
 service-manage telnet permit
```

**网页访问：**`https://<ip>:8443`

------

### 2.防火墙安全策略

#### 2.1.安全区域

防火墙不仅仅是一个入口的屏障，更应该是多个网络的接入控制点。所有进出内网的数据流都应该首先经过防火墙，形成一个信息进出的关口。

如下图，此时以防火墙为中心，网络拓扑其实分为三个区域：内网、服务器区、外网。那么防火墙此时的作用就是控制不同区域之间的流量通行。

![image-20250902171013244](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250902171013266.png)

我们现在根据上图，可以很轻松的做出规划，例如市场部不允许访问服务器区。但是，防火墙是怎么知道该数据包是从哪来，访问哪里的呢？此时，需要用到区域的概念。

------

##### 2.1.1.区域的基本概念

安全区域（`Security Zone`），它是一个或多个接口的集合，是防火墙区别于路由器的主要特征，防火墙通过安全区域来划分网络、标识报文流动的”路线“。防火墙需要提前将接口划分到某个安全区域，然后再配合**安全策略**实现流量控制。

**一般来说，同一区域间的数据报文不使用安全策略进行控制，只有当数据报文在不同区域间传送时才会使用安全策略进行控制。如果你需要对同区域的流量进行控制，就需要配置区域内的安全策略**

华为`USG`防火墙默认保留`4`个安全区域：

- 本地`Local`区域：该区域代表防火墙本身，默认安全级别为`100`。
- 信任`Trust`区域：该区域一般用于定义内部网络，默认安全级别为`85`。
- 非信任`Untrust`区域：该区域一般用于定义非内部网络或互联网，默认安全级别为`5`。
- 隔离区域`DMZ`：该区域一般用于定义内部服务器所在的网络，默认安全级别为`50`。

在生产环境中，可以根据实际情况定义多个区域，如果是较小的生产环境，可以直接使用默认的安全区域。华为`USG`防火墙每个安全区域（包括自定义）都有一个级别，该级别是唯一的，用数字`1-100`进行表示，数字越大，表示该区域的可信度越高。

![image-20250903140020419](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903140020455.png)

------

##### 2.1.2.本地区域

其他厂商的防火墙可能不存在**本地区域**的概念，而华为`USG`防火墙提供本地区域，代表防火墙本身。

凡是由防火墙主动发出的报文均认为是`Local`区域发出的，凡是需要防火墙相应并处理（非转发）的报文均认为是由`Local`区域接收。

防火墙上所有业务接口本身都属于`Local`区域，`Local`区域中不能认为添加

**注意：**

如下图，你有没有产生一个疑问，假设我在`FW`上将`G1/0/0`接口划分到`Trust`区域，`G1/0/1`接口划分到`Untrust`区域。那么现在`G1/0/0`接口和`G1/0/1`接口到底属于**本地区域**呢？还是`Trust、Untrust`区域呢？

![image-20250903141531398](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903141531424.png)

解决这个问题你得搞清楚**流量**：

- 如果你当前这个流量的始发或目的是防火墙本身，那`G1/0/0`接口的身份就是`Local`区域。
  - 例如`AR1`访问`USG`的`G1/0/1`的流量，此时这条流量的目的安全区域为`Local`。
- 如果当前防火墙的作用是**转发**，也就是说流量是经过防火墙，而不以防火墙为始发或目的，那么它就是`Trust`。
  - 例如`AR1`访问`AR2`的流量，此时`USG`的`G1/0/1`接口身份为`Untrust`，`G1/0/0`接口身份为`Trust`。

------

##### 2.1.3.安全级别

![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903144701333.png)

每个安全区域包括自定义区域都有一个值——安全级别。安全级别的作用除了用来区分安全程度之外，还可以用来判断**安全区域之间流量的走向**：

1. **入方向：**数据报文从低级别安全区域向高级别安全区域流动时为入方向。
2. **出方向：**数据报文从高级别安全区域向低级别安全区域流动时为出方向。

华为`USG`防火墙最多支持`32`个安全区域。

**注意：**只能为自定义的安全区域设定安全级别。若新建的安全区域没有设定安全级别，该安全区域不可用。安全级别一旦设定，不允许更改。

------

##### 2.1.4.实验

![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903141838250.png)

**实验一：将接口划入安全区域**

将`USG`的`G1/0/0`接口划入`Trust`区域：

```
[USG]firewall zone trust
[USG-zone-trust]add interface G1/0/0
[USG-zone-trust]quit
```

![image-20250903141957744](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903141957776.png)

**实验二：自定义区域**

1. 创建区域

```
[USG]firewall zone ?    # 需要加上name参数，代表新建区域。
  dmz      Specify dmz security zone
  local    Specify local security zone
  name     Indicate a security zone name to be created or deleted
  trust    Specify trust security zone
  untrust  Specify untrust security zone

[USG]firewall zone name newzone ?	# id为区域标识符，每个安全区域需要分配一个4-99范围内的唯一数字ID，用于系统内部识别和管理不同区域。若不指定则自动分配。
  id    Indicate security zone id
  <cr>
  
[USG]firewall zone name newzone
```

2. 设置新区域的安全级别，划分接口

```
[USG]firewall zone newzone
[USG-zone-newzone]set priority 60
[USG-zone-newzone]description newzone	# 区域说明，无实际作用
[USG-zone-newzone]add interface g1/0/1	# 将G1/0/1接口加入该区域
```

3. 验证

![image-20250903144232449](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903144232489.png)

------

#### 2.2.安全策略

##### 2.2.1.安全策略的基本概念

防火墙的基本作用是对区域与区域之间的访问行为进行控制，保护特定网络免受**不信任**网络的攻击，但同时还必须允许区域之间的合法通信。防火墙使用**安全策略**实现上述功能。

安全策略和`Router-Policy`很像是由**匹配条件**（五元组、用户、时间段等）和**动作**（允许、不允许）组成的控制规则，防火墙收到流量后，对流量的属性（五元组、用户、时间段等）进行识别，并将流量的属性与安全策略的匹配条件进行匹配，最终决定该流量是否放行。

> [!NOTE]
>
> **五元组：**源`IP`地址、目标`IP`地址、源端口、目标端口、传输协议（`TCP/UDP`）

![image-20250903153311335](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903153311366.png)

------

##### 2.2.2.安全域间与报文流动方向

**安全域间**用来描述流量的传输通告，它是两个`zone`之间的唯一道路。如下图中，当一段流量需要从`Trust`区域到达`Untrust`区域时，此时就出现了**安全域间**，如果需要对这条通告的流量进行检测，就必须在**防火墙**上配置对应的**安全策略**，用来允许流量的同行。

![image-20250903153530065](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903153530096.png)

**安全域间**的数据流动具有**方向性**：

- **入方向**（`Inbound`）：安全级别低的区域去往安全级别高的区域的流量。
- **出方向**（`Outbound`）：安全级别高的区域去往安全级别低的区域的流量。

------

##### 2.2.3.安全策略的匹配过程

防火墙作为一台网络**安全**设备，最基本的设计原则一般是**没有明确允许的流量默认都会被禁止**，这样能够去背啊防火墙一旦介入网络就能保护网络的安全。

当你需要放行某条流量时，需要创建一条相应的安全策略。一般针对不同的业务流量，设备上会配置多条安全策略。安全策略之间是**有顺序的**，自上而下的进行匹配（编号从小到大），在这个过程中如果流量已经被某一条安全策略匹配上了，则不会再继续向下匹配，如果所有自定义的安全策略都没有匹配上该流量，则被默认策略拒绝。

![image-20250903155243330](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903155243374.png)

------

##### 2.2.4.安全策略实验

![image-20250903162324455](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903162324495.png)

当前内网有两台`PC`地址分别是`192.168.1.1、192.168.1.2`，它们的网关是防火墙的`G1/0/0`接口地址为`192.168.1.254`。外网有一台`PC`机地址是`192.168.2.1`，网关为防火墙的`G1/0/1`接口，地址为`192.168.2.254`。

其中防火墙的`G1/0/0`接口划分为`Tust`区域，`G1/0/1`接口划分为`Untrust`区域。

**要求：**`192.168.1.0/24`能够访问`PC3`，`192.168.1.1`拒绝访问`PC3`。

**安全策略配置思路：**

1. 管理员应首先明确需要划分哪几个安全区域，接口如何连接，分别加入哪些安全区域；
2. 管理员选择可以根据哪种条件区分流量；
3. 管理员决定策略的最终动作，允许或拒绝；
4. 将以上步骤规划出的安全策略的参数一一列出，并将所有安全策略**按照先精确（条件细化的、特殊的策略）再宽泛（条件为大范围测策略）的顺序排序**。在配置安全策略时需要按照此顺序进行配置。

![image-20250903183518468](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903183518512.png)

**准备工作：**

1. 为三台`PC`机配置`IP`地址：

   ```
   VPCS> ip 192.168.1.1 24 192.168.1.254
   Checking for duplicate address...
   VPCS : 192.168.1.1 255.255.255.0 gateway 192.168.1.254
   
   VPCS> ip 192.168.1.2 24 192.168.1.254
   Checking for duplicate address...
   VPCS : 192.168.1.2 255.255.255.0 gateway 192.168.1.254
   
   VPCS> ip 192.168.2.1 24 192.168.2.254
   Checking for duplicate address...
   VPCS : 192.168.2.1 255.255.255.0 gateway 192.168.2.254
   ```

2. 为防火墙接口划分安全区域：

   ```
   [USG]firewall zone trust
   [USG-zone-trust]add interface g1/0/0
   [USG-zone-trust]quit
   
   [USG]firewall zone untrust
   [USG-zone-untrust]add interface g1/0/1
   [USG-zone-untrust]quit
   ```

![image-20250903162911405](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903162911450.png)

3. 为防火墙的两个接口配置`IP`地址：

   ```
   [USG]int g1/0/0
   [USG-GigabitEthernet1/0/0]ip add 192.168.1.254 24
   [USG-GigabitEthernet1/0/0]quit
   
   [USG]int g1/0/1
   [USG-GigabitEthernet1/0/1]ip add 192.168.2.254 24
   [USG-GigabitEthernet1/0/1]quit
   ```

**要求：**

要求`192.168.1.0/24`网段能够访问`PC3`，而`PC1`禁止访问`PC3`。

1. 测试当前`PC2`是否能够访问`PC3`：

   - 由于`FW`的默认策略为拒绝，所以现在是无法`ping`通的。

   ![image-20250903163425303](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903163425336.png)

2. 在防火墙上根据要求配置**安全策略**：

   ```
   [USG]security-policy	#进入安全策略视图
   [USG-policy-security]rule name deny_PC1_to_PC3	# 创建规则
   [USG-policy-security-rule-deny_PC1_to_PC3]source-zone trust	# 指定源区域
   [USG-policy-security-rule-deny_PC1_to_PC3]destination-zone untrust	# 指定目标区域
   [USG-policy-security-rule-deny_PC1_to_PC3]source-address 192.168.1.1 32	# 指定源地址
   [USG-policy-security-rule-deny_PC1_to_PC3]destination-address 192.168.2.1 32 #指定目标地址
   [USG-policy-security-rule-deny_PC1_to_PC3]action deny  # 指定动作
   [USG-policy-security-rule-deny_PC1_to_PC3]quit
   [USG-policy-security]rule name permit_1.0_to_pc3
   [USG-policy-security-rule-permit_1.0_to_pc3]source-zone trust
   [USG-policy-security-rule-permit_1.0_to_pc3]destination-zone untrust 
   [USG-policy-security-rule-permit_1.0_to_pc3]source-address 192.168.1.0 24
   [USG-policy-security-rule-permit_1.0_to_pc3]destination-address 192.168.2.1 32
   [USG-policy-security-rule-permit_1.0_to_pc3]action permit
   [USG-policy-security-rule-permit_1.0_to_pc3]quit
   ```

此时，在`PC2`上测试，成功`ping`通`PC3`，而`PC1`仍无法`ping`通`PC3`。

![image-20250903164039667](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903164039705.png)

![image-20250903164117559](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903164117599.png)

------

**安全策略查看方式：**

![image-20250903165026201](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903165026246.png)

上图中是当前在防火墙上配置的策略详情：

- `display security-policy rule name <name>`：查看单条策略详细内容。
- `display security-policy rule all`：查看防火墙当前全部策略及先后顺序。

**注解：**

- 查看单条策略时，`matched`代表当前策略被匹配数量。
- 查看全部策略时，`HITS`代表当前策略被匹配数量。

- 为什么现在都是`5`呢？因为默认`ping`命令会发送`5`个`ICMP`数据包。

------

**做法与现象分析：**

因为题目要求，在允许`192.168.1.0/24`访问`PC3`的前提下拒绝`192.168.1.1`访问`PC3`，所以需要有两条安全策略，一条允许，一条拒绝。

但是，顺序非常非常重要，因为**安全策略**默认是从上往下匹配的，所以你必须将`deny`的策略写在上面，`permit`的策略写在下面。如果你的顺序不对，那就会导致`192.168.1.1`的流量直接匹配到`permit`，永远匹配不到`deny`，那么现象就不对了。

综上所述，在写安全策略时书写顺序是非常非常重要的，建议提前规划好。

![image-20250903162324455](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903165606844.png)

------

**删除安全策略：**

```
[USG-policy-security]undo rule all	#删除全部安全策略
[USG-policy-security]undo rule name < name > # 根据策略名指定删除安全策略
```

------

**调整安全策略的顺序：**

刚刚已经和大家介绍了**安全策略顺序**的重要性，虽然提前规划可以避免问题的出现，但是现网中安全策略的变化可能非常大，还是无法完全避免需要调整顺序的情况出现。此时我们就可以通过命令来调整安全策略的顺序。

在`security`视图下通过`rule move`即可实现调整策略顺序的需求，有如下几种动作：

- `after`：将源规则移动到指定规则之后。
- `before`：将源规则移动到指定规则之前。
- `top`：将源规则移动到整个策略列表的最顶端。
- `bottom`：将源规则移动到整个策略列表的最底部。
- `up`：将源规则向上移动一位。
- `down`：将源规则向下移动一位。

假设防火墙上有如下五条安全策略：

![image-20250903182013838](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903182013893.png)

**需求一：**使用`after`将`rule 1`调整到`rule 3`之后：

```
[USG-policy-security]rule move 1 after 3
```

![image-20250903182203511](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903182203552.png)

**需求二：**使用`before`将`rule1`调整到`rule2`之前：

```
[USG-policy-security]display security-policy rule all
```

![image-20250903182303351](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903182303400.png)

**需求三：**使用`top`将`rule 5`调整到当前列表的最顶端：

```
[USG-policy-security]rule move 5 top
```

![image-20250903182354750](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903182354799.png)

**需求四：**使用`bottom`将`rule 2`调整到当前列表的最末端：

```
[USG-policy-security]rule move 2 bottom 
```

![image-20250903182450353](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903182450403.png)

**需求五：**使用`up`将`rule 3`向上调整一位：

```
[USG-policy-security]rule move 3 up
```

![image-20250903182536999](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903182537051.png)

**需求六：**使用`down`将`rule 5`向下调整一位：

```
[USG-policy-security]rule move 5 down
```

![image-20250903182614532](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250903182614582.png)

------

最后关于**安全策略**还有一个非常重要的内容，如果你针对某个条件没有要求，那么你就可以忽略不写。比如，我现在要求所有目标地址是`192.168.100.100/32`的流量全都拒绝同行，策略如下：

```
rule name deny
	destination-address 192.168.100.100 32
```

这条策略没有写任何其他条件，比如源地址、源目端口、区域等。你如果没有明确书写具体条件的值，则意味该条件任何值都被匹配。

------

#### 2.3.状态检测与会话机制

状态检测和会话机制是从第三代防火墙——状态检测防火墙开始才拥有的功能。

状态检测防火墙使用基于连接状态的检测机制，将通信双方之间交互的属于同一连接的所有报文都作为整个数据流来对待。在状态检测防火墙看来，同一个数据流内的报文不再是孤立的个体，而是存在联系的。

状态检测机制开启状态下，只有首包通过设备才能建立会话表项，后续包直接匹配会话表现进行转发。

##### 2.3.1.背景

如下图，`PC`和`Server`位于不同的网络，分别与防火墙相连，收到防火墙的管控。当前`PC`需要访问`Server`的`80`端口实现`Web`服务。

![image-20250904135643234](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250904142920925.png)

此时需要在防火墙上配置第一条规则，该规则中**源端口**为`any`，因为`PC`在访问`Web`服务器时它的操作系统决定了使用的源端口，一般是一个随机高端口，在`Windows`中范围是`1024-65535`。

| 编号 | 源地址      | 源端口 | 目的地址   | 目的端口 | 动作     |
| ---- | ----------- | ------ | ---------- | -------- | -------- |
| 1    | 192.168.0.1 | ANY    | 172.16.0.1 | 80       | 允许通过 |

另外，流量一定是有来有回的，所以还得在防火墙上再写第二条规则，用来方向`Server`回复`PC`的流量。此时规则表如下：

| 编号 | 源地址      | 源端口 | 目的地址    | 目的端口 | 动作     |
| ---- | ----------- | ------ | ----------- | -------- | -------- |
| 1    | 192.168.0.1 | ANY    | 172.16.0.1  | 80       | 允许通过 |
| 2    | 172.16.0.1  | 80     | 192.168.0.1 | ANY      | 允许通过 |

现在分析这两条规则，第一条规则代表允许`PC`的任何端口访问`Server`的`80`端口，第二条规则代表允许`Server`的`80`端口访问`PC`的任何端口。

这样配置规则会带来很大的安全问题，如果有外部的恶意攻击者伪装成`Web`服务器，就可以畅通无阻地穿过防火墙，`PC`将会面临严重的安全风险。

------

**状态检测防火墙的解决方法**

![image-20250904135643234](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250904143928954.png)

依旧是该场景，如果是状态检测防火墙只需要配置一条策略，用来允许`PC`访问`Server`的流量：

| 编号 | 源地址      | 源端口 | 目的地址   | 目的端口 | 动作     |
| ---- | ----------- | ------ | ---------- | -------- | -------- |
| 1    | 192.168.0.1 | ANY    | 172.16.0.1 | 80       | 允许通过 |

当`PC`访问`Server`的流量经过防火墙时，防火墙会根据策略允许报文通过，并针对该流量建立会话（`session`），会话中包含`PC`发出的报文信息入地址和端口等。

![image-20250904192924837](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250904192924890.png)

当`Server`的汇报到达防火墙后，防火墙会把报文中的信息与会话中的信息进行比对。如果发现报文中的信息与会话中的信息相匹配，并且该报文符合`HTTP`协议规范的规定，则认为这个报文属于`PC`访问`Server`的后续回应报文，直接允许这个报文通过。

举个例子，当我以访客的身份到某学校参与学习交流，在大门口我会被保安要求做访客登记，将我的个人信息填写在该表格上，我才能顺利进入。当我要从该学校出去的时候，保安也可以要求我再次填写登记表，两次对比一致我就可以顺利出去。

当`Server`主动发送数据包访问`PC`时，就不会被防火墙允许通过了，因为没有对应的策略，也没有对应的会话。

![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250904171026104.png)

**总结**

包过滤防火墙只根据设定好的静态规则来判断是否允许报文通过，他认为报文都是无状态的孤立个体，不关注报文产生的前因后果。这就要求包过滤防火墙必须针对每一个方向上的报文都配置一条规则，转发效率低下且容易带来安全风险。

状态检测防火墙使用基于连接状态的检测机制，将通信双方之间交互的属于同一连接的所有报文都作为整体的数据流来对待。在状态检测防火墙看来，同一个数据流内的报文不再是孤立的个体，而是存在联系的。

例如，为数据流的第一个报文建立会话，数据流内的后续报文就会直接匹配会话转发，不需要再进行规则的检查，提高了转发效率。

------

##### 2.3.2.会话机制

防火墙将属于同一连接的所有报文作为一个整体的数据流（会话）来对待。会话表是用来记录`TCP、UDP、ICMP`等协议连接状态的表项，是防火墙转发报文的重要依据。

![image-20250904170951408](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250904170951467.png)

会话是通信双方的连接在防火墙上的具体表现，代表两者的连接状态，一条会话就表示通信双方的一个连接。

- 通过会话中的五元组信息可以唯一确定通信双方的一条连接；
- 防火墙将要删除会话的时间称为会话的老化时间；
- 一条会话表示通信双方的一个连接，多条会话的集合叫做会话表。

![image-20250904171314177](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250904171314230.png)

- `http`：此时显示的是应用层协议。
- `1.1.1.1`：源地址。
- `2049`：源端口
- `2.2.2.2`：目的地址。
- `80`：目的端口

会话表使用`-->`代表方向，该符号的前面是源，符号后面的是目的。

五元组是会话的重要信息，只要五元组相同的报文即可认为属于同一条流，在防火墙上通过无原则可以唯一确定一条连接。

还有一些协议它们的报文中没有端口信息，比如`ICMP`协议，防火墙此时会把`ICMP`报文头中`ID`字段值作为`ICMP`会话的源端口，会以固定值`2048`作为`ICMP`会话的目的端口。而`IPSec`中的`AS`和`ESP`，也没有端口信息，防火墙会直接将这两个协议的会话中的源和目的端口都记录为`0`。

------

在防火墙上通过`display firewall session table`命令可以看到正常建立的会话：

![image-20250904192924837](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250904193056245.png)

在防火墙上通过`display firewall session table verbose`可以显示会话表详细信息。

![image-20250904193049648](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250904193049709.png)

------

#### 2.4.ASPF

##### 2.4.1.技术背景

在`TCP/IP`模型中，应用层提供常见的网络应用服务，如`Telnet、HTTP、FTP`等协议。而应用层协议根据占用的端口数量可以分为单通道应用层协议与多通道应用层协议。

- **单通道应用层协议：**通信过程中只需占用一个端口的协议。
  - 例如：`Telnet`只需占用`23`端口，`HTTP`只需占用`80`端口。
- **多通道应用层协议：**通信过程中需要占用两个或两个以上端口的协议。
  - 例如：`FTP`被动模式下需要占用`21`端口以及一个随机端口。

单通道应用层协议使用状态检测与会话机制已经能够满足基本的安全需求与通信需求，而多通道应用层协议仅使用状态检测机制的话并不足够。

以`FTP`为例：

- **控制通道：**客户端使用端口`21`连接到服务器，发送`LIST、GET`等命令。
- **数据通道：**当需要传输文件或列表时，服务器会动态告诉客户端：使用你的某个端口，连接到我的某个端口来获取数据。这个数据端口都是**临时协商**的。

那根据**状态检测和会话机制**的原理，客户端与`FTP`服务器文件传输时产生的数据包都会被防火墙过滤掉，导致`FTP`传输失败。

------

##### 2.4.2.ASPF介绍

`ASPF(Application Specific Packet Filter)`是针对应用层的包过滤。通过检测协商报文的应用层携带的地址和端口信息，自动生成相应的`Server-map`表，当数据通道的首包经过防火墙时，防火墙根据`Server-map`生成一条`session`，用于放行后续数据通道的报文。

相当于自动创建了一条精细的“安全策略”。对于特定应用协议的所有连接，每一个连接状态信息都将被`ASPF`维护并用于动态的决定数据包是否被允许通过防火墙。

![image-20250905145218673](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905145218742.png)

------

##### 2.4.3.Server-map表

1. 防火墙根据`ASPF`技术，获取客户端与服务端在控制通道协商的**数据通道信息（端口）**。
2. 防火墙将该信息放入`Server-map`表中。
3. 当防火墙收到报文先检查是否命中会话表，如果没有命中则检查是否命中`Server-map`表。
4. 命中`Server-map`表的报文不受安全策略控制，防火墙为命中`Server-map`的数据创建会话表。
5. 该数据流的后续报文会命中会话表被放心。



![image-20250905145848970](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905145849032.png)

所以，`Server-map`表记录的并不是当前的连接信息，而是防火墙对当前连接分析后得到的即将到来的报文的预测。最终，报文能够被防火墙放行，其实依赖的还是会话表。`Server-map`的作用是创建**会话表**。

------

##### 2.4.4.FTP概述

`FTP`是一款基于`TCP`的文件传输协议，有两个工作模式**主动模式（`POST`）**与**被动模式（`PASV`）**。`FTP`是多通道协议，一个数据端口和一个控制端口。通常控制端口为`21`，数据端口为`20`，但根据工作模式的不同，数据端口也会改变。

**主动模式：**

客户端连接到服务器的`21`端口，发送用户名和密码登录，登录成功后当客户端需要读取数据时，客户端随机开放一个端口（`1024`以上）。发送`PORT`命令到服务器，告诉服务器客户端采用主动模式并开放端口。`FTP`服务器收到`PORT`命令和端口号后，通过服务器的`20`端口和客户端开放的端口连接并发送数据。

![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905151829954.jpeg)

**被动模式：**

客户端连接到服务器的`21`端口，发送用户名和密码登录，登录成功后当客户端需要读取数据时，发送`PASV`命令到服务器。服务器在本地随机开放一个端口（1024以上），然后把开放的端口告诉客户端，客户端再连接到服务器开放的端口进行数据传输。

![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905152022969.jpeg)

------

##### 2.4.5.实验分析

如下图，`Server1`充当`FTP`服务器使用主动模式，`Client`为`FTP`客户端。防火墙的`G1/0/0`接口为`Trust`区域，`G1/0/1`接口为`DMZ`区域。

![image-20250905153149315](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905153149372.png)

防火墙配置如下：

```
[USG]firewall zone trust
[USG-zone-trust]add interface g1/0/0
[USG-zone-trust]quit

[USG]firewall zone dmz
[USG-zone-dmz]add interface g1/0/1
[USG-zone-dmz]quit

[USG]int g1/0/0
[USG-GigabitEthernet1/0/0]ip add 192.168.10.254 24
[USG-GigabitEthernet1/0/0]quit

[USG]int g1/0/1
[USG-GigabitEthernet1/0/1]ip add 192.168.20.254 24
[USG-GigabitEthernet1/0/1]quit

[USG]security-policy 
[USG-policy-security]rule name ftp	
[USG-policy-security-rule-ftp]source-zone trust	
[USG-policy-security-rule-ftp]destination-zone dmz	
[USG-policy-security-rule-ftp]source-address 192.168.10.0 24	
[USG-policy-security-rule-ftp]destination-address 192.168.20.0 24	
[USG-policy-security-rule-ftp]service ftp
[USG-policy-security-rule-ftp]action permit
[USG-policy-security-rule-ftp]quit
```

**注意：**在`USG6000v`中`FTP`的`ASPF`功能已经自动开启，通过如下命令可关闭：

```
[USG]undo firewall detect ftp
```

测试`client`能否成功访问`FTP`服务：

![image-20250905153510743](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905153510808.png)

**失败原因分析**

此时客户端使用随机端口`xxxx`向`FTP`服务器的`21`端口发起连接请求建立控制连接，然后使用`PORT`命令协商两者进行数据连接的端口，协商出来的是`yyyy`端口。

然后`FTP`服务器主动向客户端`yyyy`端口发起连接请求，建立数据连接，数据连接建立成功后，才能进行数据传输。

但是，防火墙上只配置允许`FTP`客户端访问`FTP`服务器的安全策略，即控制连接能成功建立。但是当`FTP`服务器访问`FTP`客户端`YYYY`端口的报文到达防火墙后，对于防火墙来说，这并不是前一条连接的后续报文（不满足会话机制），而是一条新的连接，但是又没有对应的安全策略，所以导致`FTP`访问失败。

**解决方法1：**

你肯定能想到，那我再配置一条反放行的策略不就行了么？

对！这是一个方法。

```
[USG]security-policy 
[USG-policy-security]rule name FTP_IN	
[USG-policy-security-rule-FTP_IN]source-zone dmz	
[USG-policy-security-rule-FTP_IN]destination-zone trust 
[USG-policy-security-rule-FTP_IN]action permit 
[USG-policy-security-rule-FTP_IN]quit
```

![image-20250905154458608](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905154458684.png)

虽然能够使`FTP`成功交互，但是你现在就必须配置`FTP`服务器到达`FTP`客户端任何端口的策略，这是一条非常宽泛的策略，那不就丧失了状态检测防火墙的优势了么，不还是出现安全隐患了吗？

**解决方法2：**

最好的方法一定是开启`ASPF`，使用`Server-map`。

```
[USG]firewall detect ftp
```

当开启了针对`FTP`的`ASPF`后，流量经过防火墙时，会生成`server-map`表，下图中`server-map`表的含义是，源地址`192.168.20.100`目的地址`192.168.10.1`，目的端口为`2062`，协议为`TCP`承载`FTP Data`。

![image-20250905154631577](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905154631643.png)

当`FTP`服务器主动访问`FTP`客户端时，首包经过防火墙，防火墙根据`server-map`表生成会话表。如下图中第一条会话：

![image-20250905154816965](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905154817030.png)

------

##### 2.4.6.ASPF命令

1. 执行命令`system-view`，进入系统视图。
2. 执行命令`firewall interzone zone-name1 zone-name2`，进入安全域间视图。
3. 执行命令`detect aspf {ftp| rtsp | sip}`配置`ASPF`。
   - 应用层协议基本都具有双向交互过程，因此在配置ASPF时，无需配置方向，设备自动对双向的数据报文都进行状态检查。
   - 缺省情况下，安全域间未配置`ASPF`。

------

#### 2.5.安全策略补

缺省情况下防火墙是不针对基础协议`BGP、LDP、BFD、DHCP、DHCPv6、OSPF、OSPFv3`的单播报文进行安全策略检查的。

另外，防火墙也是不针对组播报文进行安全策略检查的。

以`OSPF`为例，在建立`OSPF`邻居关系时，会有单播报文的交互过程，防火墙默认不会针对其进行任何的安全策略检查，只要其目的地址是防火墙自身接口皆放行。

可以通过`firewall packet-filter basic-protocol enable`打开对基础协议的安全策略控制开关，在开启之后基础协议的单播报文将无法再被防火墙放行，需要通过安全策略的放行。
