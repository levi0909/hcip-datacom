# 03_防火墙双机热备

### 1.双机热备概述

#### 1.1.双机部署提高网络可靠性

随着移动办公、网上购娱、即时通信、互联网金融、互联网教育等业务蓬勃发展，网络承载的业务越来越多，越来越重要。

![image-20250913202155974](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250913202156050.png)

如上图，防火墙部署在企业出口位置，内外网之间的业务都通过防火墙转发。如果防护墙出现故障，便会导致内外网之间的业务全部中断。

由此可见，在这种网络关键位置上如果只使用一台设备的话，无论其可靠性多高，都必然要承受因设备**单点故障**而导致网络中断的风险。

所以，我们在网络架构设计时，通常会在网络的关键位置部署两台（双击）或多台设备，以提升网路的可靠性。如下图中，当一台防火墙出现故障时，流量会通过另外一台防火墙所在的链路转发，保证内外网之间业务正常运行。

我们将**双机部署**称为设备级别的冗余或可靠性。

![image-20250913202202081](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250913202202154.png)

------

#### 1.2.传统网络设备的冗余

实际上在网络设计时，不仅仅会考虑防火墙的冗余性，传统的网络设备（如路由器、交换机等）我们都需要为其考虑冗余。

针对网络中的核心设备，如核心交换机在设备支持的情况下我们会考虑做**堆叠**。除了设备级别的冗余之外，通常我们还会考虑**链路**级别的冗余，在设备和设备之间连接多根线缆部署**链路聚合**。

上面讲到的都是交互设备，而对于路由设备来说，通常只需要考虑**路由备份**。因为普通的路由器、交换机不会记录报文的交互状态和应用层信息，只是根据路由表进行报文转发。

![image-20250913202221380](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250913202221456.png)

如上图，网络中的路由器通过动态路由协议（`OSPF`）两两之间建立邻居关系，生成并转发路由信息。若上图中的`R1`出现故障，`R3`在知道报文转发时会将数据包转发至`R2`，依旧可以保障网络的可用性。所以，对于普通的网络设备而言，只需保障基本的链路可靠性与路由可靠性即可。

------

#### 1.3.防火墙需考虑会话备份

当我们需要针对**状态检测防火墙**部署双机热备时，就需要考虑会话备份了。

状态检测防火墙是基于连接状态的，它会对一条流量的首包（第一个报文）进行完整的检测，并建立会话来记录报文的状态信息（五元组）。而这条流量的后续报文只有匹配会话才能够通过防火墙并且完成报文转发，如果后续报文不能匹配会话则会被防火墙丢弃。

![image-20250908164223872](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908164223897.png)

如上图，防火墙A和防火墙B与上下行设备使用`OSPF`构建网络学习路由信息，当内网主机A向`Internet`的服务器发起连接请求后，根据`OSPF`的选路规则数据包从防火墙A进行转发。

此时，防火墙A出现故障，当数据包回程时被设备根据路由协议转发到防火墙B。因为防火墙B上没有会话表，所以回程流量会被拒绝。

需要内网主机A重新发起连接，出发防护墙B生成会话表才能够放行回程流量。

------

防火墙双机热备有两个模式：

- **主备：**两台防火墙一主一备，正常情况下主防火墙负责处理流量，备防火墙监听主防火墙状态，当主防火墙出现故障时及时切换。
- **负载分担：**两台防火墙互为主备，同时负责对流量进行处理，以达到负载分担的目的。

------

##### 1.3.1.主备解决方法

防火墙双机热备功能最大的特点在于提供一条专门的备份通道（心跳线），用于两台防火墙之间协商主备状态，以及**备份会话**、`Server-map`表等重要的状态信息和配置信息。

双机热备功能启动后，正常情况下，两台防火墙会根据管理员的配置分别成为**主设备**和**备用设备**。成为主用设备的防火墙会处理业务，并将设备上的会话、`Server-map`等重要状态信息及配置信息通过**心跳线**实时同步给备用设备。

成为备用设备的防火墙不会处理业务，只是通过心跳线接收来自主用防火墙的状态信息以及配置信息。

![image-20250908164223872](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908182022709.png)

当上图中的防火墙A的链路出现故障时，两台防火墙会利用**心跳线**交互报文，重新协商主备状态。这是防火墙B协商后成为新的主用设备，处理业务；

而防火墙A会协商称为备用设备不处理业务。此时，业务流量会被上下行设备的**路由信息**引导到新的主用设备防火墙B上。由于防火墙B之前已经备份了主用设备上的会话和配置等信息，因此业务报文就能够顺利匹配到会话从而被正常转发。

------

##### 1.3.2.负载分担解决方法

在负载分担场景下，两台防火墙均为主用设备，都建立会话，都处理业务流量。同时两台防火墙又都相互作为对方的备用设备，接收对方备份的会话和配置信息。

![image-20250908164223872](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908182831277.png)

上图中两台防火墙之间部署了负载分担模式的双机热备。当防火墙A发生故障后，另一台防火墙会负责处理全部业务流量。由于这两台防火墙的会话信息是相互备份的，因此全部业务流量的后续报文都能够在其中一台防火墙上匹配到会话从而正常转发，这就避免了网络业务的中断。

------

##### 1.4.双机热备所需技术

1. `VRRP(Virtual Router Redundancy Protocol)`
   - **核心作用：**提供虚拟网关`IP`地址，实现网络层冗余。
   - **具体功能：**避免因单台防火墙故障导致的网络中断，为下行设备提供一个稳定的、不中断的网关地址。
     - 将两台物理防火墙的多个接口组合成多个`VRRP`组。
     - 每个`VRRP`组共享一个虚拟`IP`地址，作为终端用户的默认网关。
     - 通过优先级，决定由那台设备的接口扮演`master`角色，负责接收和转发流量。

2. `VGMP(VRRP Group Management Protocol)`
   - **核心作用：**统一管理整台设备的状态，实现故障检测和快速切换。
   - **具体功能：**确保防火墙**主备**的统一性，并提供快速的故障感知与响应机制。
     - 将一台防火墙上所有的`VRRP`组（如上行和下行接口组）加入一个`VGMP`管理组进行统一管理。
     - `VGMP`组对外呈现一个统一的`Active`或`Standby`状态，并强制该设备上所有`VRRP`组的状态与`VGMP`组状态保持一致。
     - 主动监控设备及链路的健康状态（如接口故障、链路故障）。一旦检测到故障，立即主动降低自身优先级，出发主备切换。

3. `HRP(Huawei Redundancy Protocol)`
   - **核心作用：**这主备设备之间同步关键状态信息和配置，实现业务无缝切换。
   - **具体功能：**解决传统冗余协议只能切换`IP`地址而无法保持连接状态的难题。在主备切换后，现有网络连接不会中断，实现真正的热备份。
     - 通过专用的心跳链路，将主用设备上的动态状态数据实时同步到备用设备。
     - **同步内容包括：**会话表、`NAT`表项、黑名单等。
     - 确保备用设备在任何时候都拥有与主用设备几乎一致的操作状态和网络信息。

**总结：**

- `VRRP`负责对外“露面”，提供虚拟`IP`，解决地址冗余问题。
- `VGMP`是内部的“总指挥”，负责决策和管理**整机状态**，解决**故障感知和统一切换**问题。
- `HRP`负责“数据同步”，负责保持主备设备**状态一致**，解决**业务无缝切换**问题。

------

### 2.VRRP与VGMP

#### 2.1.VRRP概述

`VRRP(Virtual Router Redundancy Protocol)`虚拟路由冗余协议，是一种用于提高网络可靠性的容错协议。通过`VRRP`，可以在主机的下一跳设备出现故障时，及时将业务切换到备份设备，从而保障网络通信的连续性和可靠性。

上个章节提到防火墙双机热备组网中，流量被引导到主用还是备用设备都是由上下行设备的**路由表**决定的。这是因为**动态路由**可以根据链路状态动态调整路由表，自动将流量引导到正确的设备上。但如果下行设备都是**主机**，它们是无法配置动态路由的，那应该怎么做呢？？

![image-20250908223826512](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908223826531.png)

如上图，内网中有非常多的主机它们的网关是一台防火墙，内网主机的上网流量都通过这台防火墙承载。可是当这台防火墙出现故障，网络就会停摆。

------

为了解决内网主机网关的**单点故障**问题，在网络中再增加一台防火墙。可是，对于主机并没有办法设置多个网关。这就导致一旦防火墙A出现故障，内网主机的流量无法自动切换到防火墙B上，需要在内网中所有主机上修改网关的`IP`地址。这种情况下，依旧会导致出现网络中断、停摆的情况发生。

![image-20250908223938333](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908223938359.png)

------

此时我们的`VRRP`协议隆重登场了，`VRRP`协议将多台设备组成一个虚拟设备，该虚拟设备拥有自己的虚拟`IP`地址和虚拟`MAC`地址（格式：`00-00-53-00-01-{VRID}`）。所有的内网主机需要将该虚拟`IP`地址设置为自己的**默认网关**。

如下图，组成虚拟设备的两台或多台设备会提前根据规则进行选举，选举出一个`Master`设备和一个或多个`Backup`设备。`Master`设备负责接收所有内网主机的流量承担**网关**的角色，`Master`设备真正拥有虚拟`IP`地址，负责接收并转发内网主机流量。

而`Backup`设备负责监听`Master`设备的状态，一旦`Master`设备出现故障无法胜任当前工作时，`Backup`设备便会切换成`Master`设备，拥有虚拟`IP`地址，负责接收并转发内网主机流量。

所以，下图中`Router A`一开始是`Master`，当它发生故障后，`Router B`会第一时间感知到这个变化，并最快速度将虚拟`IP`地址所承载的流量接收到本端并进行转发。

![image-20250908224406954](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908224406978.png)

------

##### 2.1.1.VRRP的状态机

`VRRP`协议中定义了三种状态机：初始状态（`Initialize`）、活动状态（`Master`）、备份状态（`Backup`）。其中，只有处于`Master`状态的设备才可以转发那些发送到虚拟`IP`地址的报文。下表详细描述了三种状态。

|  状态 (State)  |                      说明 (Description)                      |
| :------------: | :----------------------------------------------------------: |
| **Initialize** | 该状态为VRRP不可用状态，在此状态时设备不会对VRRP通告报文做任何处理。通常设备启动时或设备检测到故障时会进入Initialize状态。 |
|   **Master**   | 当VRRP设备处于Master状态时，它将会承担虚拟路由设备的所有转发工作，并定期向整个VRRP备份组内发送VRRP通告报文。 |
|   **Backup**   | 当VRRP设备处于Backup状态时，它不会承担虚拟路由设备的转发工作，并定期接受Master设备的VRRP通告报文，判断Master的工作状态是否正常。 |

------

##### 2.1.2.VRRP报文结构

![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915000634572.png)

`VRRP`报文是封装在`IP`报文中，发送到`224.0.0.18`的组播地址，协议号是`112`。

- `Version`：版本号，通常是`VRRPv2`。
- `Type`：`VRRP`通告报文的类型，取值为`1`表示`Advertisement`。
- `Virtual Rtr ID(VRID)`：虚拟路由器`ID`（），取值范围是`1 ~ 255`。
- `Priority`：优先级，用于选举`Master`。
- `Count IP Addrs`：备份组中虚拟`IPv4`地址的个数。
- `Auth Type`：`VRRP`报文的认证类型。
  - `0`：`Non Authentication`不认证
  - `1`：`Simple Text Password`明文认证
  - `2`：`IP Authentication Header`表示`MD5`认证
- `Adver Int`：`VRRP`通告报文的发送时间间隔，单位是秒，缺省值为`1S`。
- `Checksum`：`16`位校验和，用于检测`VRRP`报文中的数据破坏情况。
- `IP Address`：`VRRP`备份组的虚拟`IPv4`地址，有多少个虚拟`IPv4`地址就有多少个该字段。
- `Authentication`：`VRRP`报文的认证字端。目前只有明文认证和`MD5`认证才用到该部分，其他方式该字段皆为`0`。

------

##### 2.1.2.VRRP的选举机制

由两台或以上运行了`VRRP`的设备组成的虚拟设备又称为`VRRP`备份组。一个`VRRP`备份组在逻辑上为一台路由器。`VRRP`备份组建立后（配置完毕），各设备会根据所配置的优先级来选举`Master`设备，选举方式如下：

![Master设备选举过程](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908225842096.png)

从上图中可看出，`VRRP`备份组中的所有设备如果优先级未设置为`255`，默认情况下都会先进入`Master`状态，然后发送`VRRP`报文比较优先级，优先级最大的称为`Master`其他设备成为`Backup`。如果优先级都相同，则比较接口主`IP`地址，最大的成为`Master`。

其中**优先级**是一个非常重要的内容，它的取值范围是`0 ~ 255`。`0`和`255`是两个非常特殊的值：

- 当设备的`VRRP`优先级设置为`255`时，跳过选举直接成为当前`VRRP`备份组的`Master`。
- 当设备的`VRRP`的优先级设置为`0`时，代表放弃当前`Master`身份，用来通知备份组中的`backup`设备。

如下图，实际上在华为设备中你能够手动配置的`VRRP`优先级的范围是`1-254`：

- 优先级`255`的情况只会出现在，接口的**物理地址**和**虚拟地址**一致的情况下。
- 优先级`0`的情况只会出现在，`Master`设备主动放弃`Master`的身份的情况，如手动删除`VRRP`配置。

![image-20250908231021804](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908231021834.png)

------

##### 2.1.3.VRRP备份组

你可以将`VRRP`备份组理解成“虚拟路由器团队”，每一个`VRRP`备份组服务于不同的网段。一个`VRRP`备份组中会选举出一个`Master`和多个`Backup`。由组中的`Master`设备拥有虚拟`IP`和虚拟`MAC`地址的所有权。

一台`VRRP`设备上可以配置多个`VRRP`组，通过`VRID`这个参数进行区分。不同的`VRRP`组中的`IP`地址一定是不同的，根据管理员配置为准。不同的`VRRP`组中的虚拟`MAC`地址根据`VRID`区分，`00-00-53-00-01-{VRID}`。

`VRID`也是管理员手动指定的，用于区分不同`VRRP`备份组。

------

##### 2.1.4.VRRP的工作原理

**初始化阶段：**

如下图，在`VRRP`备份组中的多个路由器中，根据选举规则成功选举出`Master`。`Master`会立即周期性（默认为1秒）的向`VRRP`备份组中所有`Backup`路由器发送`VRRP`报文，以维持自己`Master`的身份。

同时`Master`会广播发送免费`ARP`报文，将`VRRP`备份组的虚拟`MAC`地址和虚拟`IP`地址通告给与它连接的交换机。下行的交换机的`MAC`表项会记录虚拟`MAC`地址与`Master`设备端口的对应关系。

由于内网的`PC`将网关设置为`VRRP`备份组的虚拟`IP`地址，所以当内网`PC`访问外网产生流量时，首先会广播`ARP`报文，请求虚拟`IP`地址对应的虚拟`MAC`地址。这时只有`Master`路由器会回应此`ARP`报文，将虚拟`MAC`地址回应给`PC`。

![image-20250908232351971](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908232352003.png)

------

**稳定后的情况：**

当`VRRP`备份组中`Master`选举成功后，且已经发送`VRRP`免费报文，导致交换机和`PC`都已经成功学习到虚拟`MAC`地址和虚拟`IP`地址的对应关系时。

当`PC1`需要访问上行流量时，`PC`会将虚拟`MAC`地址作为数据包中的目的`MAC`地址，构建完数据包后将该数据包单播转发给网关（虚拟网关`Master`）。交换机收到该报文后，查找`MAC`地址表，发现应该从`Ethernet0/0/1`接口发出（`master`）转发给路由器A。

路由器A收到后，因为自己是`Master`所以会处理该报文并转发。

------

**故障的情况：**

![image-20250908233712576](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908233712610.png)

如果此时，`Master`设备出现故障（路由器A的G0/0/0接口断开）时，它将无法发送`VRRP`报文通知`Backup`路由器。当`Backup`路由器在定时器（默认三秒）超时后仍不能收到`Master`发送的`VRRP`报文，则认为`Master`故障，自己切换为`Master`。

或者`Master`主动放弃身份，向`Backup`发送优先级为`0`的`VRRP`报文，此时`Backup`路由器会立即切换为`master`，如果有多台`backup`依旧需要选举。

`VRRP`备份组的状态切换完成后，新的`Master`设备会立即发送携带虚拟`IP`地址和虚拟`MAC`地址的免费`ARP`报文，刷新它与下行设备（交互机）的`MAC`表项。

**提问：**

为什么`PC`没有被刷新`MAC`表项或`ARP`表项呢？？

- 因为，`PC`机连接着交换机端口一直不变，没有刷新的意义。
- 因为，`Master`切换后虚拟IP地址和虚拟MAC地址不会发生改变，所以修改`ARP`表项也没有意义。
- 所以，对于`PC`来说什么都没有改变，它是无感知的。

此时，`PC`机发送的流量目的`MAC`地址依旧是虚拟`MAC`地址，会被交换机根据`MAC`地址表转发给新的`Master`，至此切换完毕、网络稳定。

------

**故障恢复的情况：**

![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908233719551.png)

当之前故障的路由器恢复后，如果该设备开启了`VRRP`抢占功能（默认开启），会发送`VRRP`报文给所有的`VRRP`备份组中的路由器进行优先级比较，那因为它本身就是优先级最高的，所以经过此次选举它成功再次获得`Master`身份。之前顶替的设备切换回`Backup`身份。

随后，`master`设备依旧会发送免费`ARP`告知交换机虚拟`MAC`地址对应的接口发生了改变。

------

##### 2.1.5.VRRP配置举例

![image-20250915000351989](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915000352115.png)

如上图，`PC1`属于`vlan10`，`PC2`属于`vlan20`，通过`trunk`和`access`将`vlan`打通。

`LSW1`和`LSW2`配置两个`VRRP`备份组

- 备份组`1`服务于`vlan10`，`VRRID`为`10`，虚拟`IP`地址为`192.168.10.254`。`Master`为`LSW1`。
- 备份组`2`服务于`vlan20`，`VRRID`为`20`，虚拟`IP`地址为`192.168.20.254`。`Master`为`LSW2`。

**基础配置如下：**

1. **三台交换机上配置vlan与trunk和access：**

```
[LSW1]vlan batch 10 20	# 批量配置vlan 10 20
[LSW1]int g0/0/1	# 进入物理接口
[LSW1-GigabitEthernet0/0/1]port link trunk	# 将该接口配置为trunk模式
[LSW1-GigabitEthernet0/0/1]port trunk all vlan 10 20	# 在该接口上放行vlan 10 20
[LSW1-GigabitEthernet0/0/1]quit

[LSW2]vlan batch 10 20
[LSW2]int g0/0/2
[LSW2-GigabitEthernet0/0/2]port link trunk
[LSW2-GigabitEthernet0/0/2]port trunk all vlan 10 20
[LSW2-GigabitEthernet0/0/2]quit

[LSW3]int Ethernet0/0/1
[LSW3-Ethernet0/0/1]port link trunk
[LSW3-Ethernet0/0/1]port trunk all vlan 10 20
[LSW3-Ethernet0/0/1]quit
[LSW3]int Ethernet0/0/2
[LSW3-Ethernet0/0/2]port link trunk
[LSW3-Ethernet0/0/2]port trunk all vlan 10 20
[LSW3-Ethernet0/0/2]quit	
[LSW3]int Ethernet0/0/3
[LSW3-Ethernet0/0/3]port link acc	
[LSW3-Ethernet0/0/3]port default vlan 10
[LSW3-Ethernet0/0/3]quit	
[LSW3]int Ethernet0/0/4
[LSW3-Ethernet0/0/4]port link acc
[LSW3-Ethernet0/0/4]port def vlan 20
[LSW3-Ethernet0/0/4]quit
```

2. **在两台三层交换机上配置vlanif：**

```
[LSW1]interface vlan 10
[LSW1-Vlanif10]ip add 192.168.10.252 24
[LSW1-Vlanif10]quit
[LSW1]interface vlan 20
[LSW1-Vlanif20]ip add 192.168.20.252 24
[LSW1-Vlanif20]quit

[LSW2]interface vlan 10
[LSW2-Vlanif10]ip add 192.168.10.253 24
[LSW2-Vlanif10]quit
[LSW2]interface vlan 20
[LSW2-Vlanif20]ip add 192.168.20.253 24
[LSW2-Vlanif20]quit
```

3. **在两台交换机上配置vrrp**

```
[LSW1]int vlan 10
[LSW1-Vlanif10]vrrp vrid 10 virtual-ip 192.168.10.254	# 指定虚拟IP地址
[LSW1-Vlanif10]vrrp vrid 10 priority 150	# 指定vrrp优先级
[LSW1-Vlanif10]quit
[LSW1]interface vlan 20
[LSW1-Vlanif20]vrrp vrid 20 virtual-ip 192.168.20.254
[LSW1-Vlanif20]quit

[LSW2]int vlan 10
[LSW2-Vlanif10]vrrp vrid 10 virtual-ip 192.168.10.254
[LSW2-Vlanif10]quit
[LSW2]int vlan 20
[LSW2-Vlanif20]vrrp vrid 20 virtual-ip 192.168.20.254
[LSW2-Vlanif20]vrrp vrid 20 priority 150
[LSW2-Vlanif20]quit
```

**查看vrrp是否成功：**

![image-20250909000149692](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909000149736.png)

![image-20250909000204559](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909000204599.png)

**查看交换机MAC地址表：**

![image-20250909000401874](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909000401926.png)

`0a`是`10`的十六进制表现，`14`是`20`的十六进制表现。

- 说明当前`vlan 10`的`Master`是`LSW1`，`vlan 20`的`Master`是`LSW2`。现象完全正确。

------

**模拟故障：**

关闭`LSW1`的`vlan10`接口：

```
[LSW1]int vlan 10
[LSW1-Vlanif10]shutdown 
[LSW1-Vlanif10]quit
```

抓包查看现象：

![image-20250909000931706](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909000931753.png)

![image-20250909000951696](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909000951744.png)

**故障恢复：**

打开`LSW1`的`vlan10`接口：

```
[LSW1]int vlan 10
[LSW1-Vlanif10]undo shutdown 
[LSW1-Vlanif10]quit
```

抓包查看现象：

![image-20250909000843391](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909000843442.png)

![image-20250909000904434](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909000904483.png)

------

##### 2.1.6.VRRP与上行接口联动

在刚刚的介绍和案例中都是以下行“路由”服务的，但是如果`Master`的上行接口故障了，本质上`PC`已经无法通过`Master`访问互联网了，但因为没有配置**联动**就会导致网络中断。

此时，可以开启`VRRP`的`Track`跟踪功能，开启后可以指定若上行接口故障将降低`VRRP`优先级。

![image-20250909001530007](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909001530060.png)

当前的`VRRP`状态如下：

![image-20250909001602710](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909001602756.png)

**配置要求：**

当`LSW1`的`G0/0/2`接口故障后，降低`VRRP 10`的优先级，值为`51`。

```
[LSW1]interface vlan 10
[LSW1-Vlanif10]vrrp vrid 10 track interface g0/0/2 reduced 51
[LSW1-Vlanif10]quit
```

关闭`LSW1 G0/0/2`接口，查看现象：

```
[LSW1]interface g0/0/2
[LSW1-GigabitEthernet0/0/2]shutdown 
[LSW1-GigabitEthernet0/0/2]quit
```

![image-20250909001927109](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909001927158.png)

![image-20250909001947424](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909001947473.png)

**参数讲解：**

- `reduced`：降低优先级。
- `increased`：提高优先级。

**注意：**配置`track`时，减少的优先级值，必须满足公式：原定优先级减去该值后大于对端优先级。

------

#### 2.2.VGMP

##### 2.2.1.VRRP的问题

之前我们介绍`VRRP`的时候都在讨论为下行链路创建`VRRP`备份组，但是在实际部署双机热备时还必须考虑上行流量，若上下行流量引导设备不一致，则会出现丢包问题。

![image-20250909214052468](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909214052527.png)

如上图，防火墙A和防火墙B构建了三个备份组，正常情况下防火墙A是这三个备份组的`Master`。`Trust`区域的`PC1`访问`Untrust`区域的`PC2`，报文来回路径一致，防火墙A状态检测机制检测通过，通信正常。

当防火墙A的上行接口故障，备份组3的`Master`切换为防火墙B。`Trust`区域的`PC1`访问`Untrust`区域的`PC2`依旧是走向防火墙A，导致通信失败。

从上述案例，可看出`VRRP`的缺点是无法统一设备上的所有备份组状态。

------

##### 2.2.2.VGMP的解决方法

为了解决多个`VRRP`备份组状态不一致的问题，华为防火墙引入`VGMP(VRRP Group Management Protocol，vrrp组管理协议)`来实现对`VRRP`备份组的统一管理，保证多个`VRRP`备份组状态的一致性。

我们将防火墙上的所有`VRRP`备份组都加入到一个`VGMP`组中，由`VGMP`组来集中监控并管理所有的`VRRP`备份组状态。如果`VGMP`组检测到其中一个`VRRP`备份组的状态变化，则`VGMP`组会控制组中的所有`VRRP`备份组统一进行状态切换，保证各`VRRP`备份组状态的一致性。

------

##### 2.2.3.基本概念

`VGMP`组有状态和优先级两个基本属性，并且有三条基本运行原则。

- `VGMP`组的状态决定了组内`VRRP`备份组的状态，也决定了防火墙的主备状态。
- 两台防火墙的`VGMP`组状态是通过相互比较优先级来决定的。优先级高的`VGMP`组状态为`Active`，优先级低的`VGMP`组状态为`Standby`。
- `VGMP`组会根据组内`VRRP`备份组的状态变化来更新自己的优先级。一个`VRRP`备份组的状态变成`Initialize`，`VGMP`组的优先级就会降低`2`。

------

**初始状态：**

![image-20250909161121988](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909161122047.png)

在`FW1`上将`VRRP`备份组1和`VRRP`备份组2都加入状态为`Active`的`VGMP`组，在`FW2`上将`VRRP`备份组1和`VRRP`备份组2都加入状态为`Standby`的`VGMP`组。

由于`VGMP`组的状态决定了组内`VRRP`备份组的状态，所以`FW1`上`VRRP`两个备份组的状态都为`Active`，`FW2`上`VRRP`两个备份组的状态都为`Standby`。

此时，由于`FW1`是两个备份组的主用设备，所以上下行的业务流量都会被引导到主用设备`FW1`转发。

之前的讲解`VRRP`的时候状态是`Master`和`Backup/Slave`，在`VGMP`中统一为`Active`和`Standby`。

------

**故障切换：**

![image-20250909162824579](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250909162824631.png)

当`FW1`的接口故障时，`VGMP`组控制`VRRP`备份组状态统一切换：

1. 当`FW1`的`GE1/0/1`接口故障时，`FW1`上的`VRRP`备份组`1`发生状态切换，由`Active`切换成`Initialize`。
2. `FW1`的`VGMP`组感知到这一故障后，会降低自身的优先级，然后与`FW2`的`VGMP`组比较优先级，重新协商主备状态。
3. 协商后，`FW1`的`VGMP`组状态由`Active`切换成`Standby`，`FW2`的`VGMP`组状态由`Standby`切换成`Active`。
4. 同时，由于`VGMP`组的状态决定了组内`VRRP`备份组的状态，所以`FW1`会强制`VRRP`备份组切换为`Standby`状态，`FW2`也会强制组内`VRRP`备份组状态切换为`Active`状态。
   - 此时，`FW2`就成为了两个备份组的主用设备。
5. `FW2`会分别向`LSW1`和`LSW2`发送免费`ARP`，更新它们的`MAC`地址表，使所有的上行报文和回程报文都转发到`FW2`，此时完成了`VRRP`备份组状态的同意切换，并且保证业务流量不会中断。

------

##### 2.2.4.VGMP报文结构

从上面的案例可看出，`VGMP`不仅完成了`VRRP`备份组的统一管理，还取代了`VRRP`接管了对防火墙主备状态的管理权。

两台设备的`VRRP`备份组是通过`VRRP`报文来传递状态和优先级信息的。防火墙的`VGMP`组是通过`VGMP`报文来传递状态和优先级信息的。

`VGMP`是华为的私有协议，为了实现**防火墙双机热备功能**对`VRRP`报文进行了扩展和修改，并衍生出多种使用`VGMP`报文头封装的报文。

**VGMP与VRRP报文区别**

![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914233629082.png)

`VGMP`报文是封装在`VRRP`报文后面的，是由`VRRP`报文头封装的。但这个`VRRP`报文头并不是标准的`VRRP`报文头，是经过华为扩展和修改的新的`VRRP`报文头，变化如下：

- 标准`VRRP`报文头的`Type`字段只有`1`一个取值，新`VRRP`报文头中增加了`2`这个取值。
  - 当`Type=1`说明是标准的`VRRP`报文头。
  - 当`Type=2`说明是修改后的`VRRP`报文头（`VGMP`）。
- 标准`VRRP`报文头的`Virtual Rtr ID`字段代表`VRRP`备份组`ID`，而修改后的新`VRRP`报文头`Virtual Rtr ID`取值固定为`0`。
- 修改后的新`VRRP`报文头中去掉了标准`VRRP`报文的`IP Address`字段。
- 标准`VRRP`报文头中的`Priority`字段在新`VRRP`报文头中被修改成`Type2`字段。

------

**VGMP报文类型**

![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914233620715.png)

根据`VRRP`报文头中的`Type2`字段的不同，`VGMP`报文类型也不同：

- 当`Type2=1`时，报文封装成**心跳链路探测报文**。心跳链路探测报文用于检测对端设备的心跳口能否正常接收本段设备的报文，以确定是否有心跳口可以使用。
- 当`Type2=5`时，报文封装成**一致性检查报文**。一致性检查报文用于检测双机热备状态下的两台防火墙的双机热备和策略配置是否一致。
- 当`Type2=2`时，`VRRP`报文才会进一步封装`VGMP`报文头，并根据`VGMP`报文头中`vType`字段继续分成以下三种报文。
  - `VGMP`报文（`VGMP Hello`报文）。`VGMP Hello`报文用于两台防火墙间的`VGMP`组协商主备状态。
  - `HRP`心跳报文（`HRP Hello`报文）。`HRP`心跳报文用于探测对端的`VGMP`组是否处于工作状态。状态为`Active`的`VGMP`组会每隔一段时间（缺省为`1s`）向对端的`VGMP`组发送`HRP`心跳报文，用来通知本端的`VGMP`组状态和优先级。如果状态为`Standby`的`VGMP`在三个周期内没有收到对端发送的`HRP`心跳报文，则认为对端`VGMP`组故障，会将自身状态切换成`Active`。
  - `HRP`数据报文。在`VGMP`报文头后增加`HRP`报文头，才能封装成`HRP`数据报文。`HRP`数据报文用于主备设备之间的数据备份，包括命令行配置的备份和各种状态信息的备份。

------

在防火墙双机热备中新`VRRP`报文头是用来封装`VGMP`报文的，那标准的`VRRP`报文还存在么？

标准`VRRP`报文仍旧存在，它还适用于`VRRP`备份组内部通信。只是其中的优先级字段（`Priority`）已经为固定值，无法配置，所以标准`VRRP`报文实际上已名存实亡。

优先级字段失去作用导致标准`VRRP`报文已经无法控制`VRRP`备份组的状态协商了，只能在主备防火墙之间通告一下`VRRP`备份组的状态和虚拟`IP`地址了。`Active`和`Standby`的身份完全是由`VGMP`说了算了。

由于`VGMP`才真正决定`VRRP`备份组状态，所以`VGMP`报文中必须包含`VGMP`组状态和优先级信息。

![image-20250914233614645](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914233614769.png)

- **mode**：表示是请求报文还是应答报文。
- **vgmpID**：表示`VGMP`组是`Active`组还是`Standby`组。
- **vPriority**：表示`VGMP`组的优先级。

- **data:**包含`VGMP`组的状态信息。

------

**UDP与组播**

默认情况下`VGMP`和`HRP`报文是使用`VRRP`封装的也就是**组播**。还可以选择将`VGMP`和`HRP`报文封装成`UDP`报文。

![image-20250914233604341](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914233604464.png)

组播的`VGMP`和`HRP`不能跨网段传输，不受安全策略控制。两台防火墙的心跳口之间就必须直连或通过二层交换机相连。

`UDP`的`VGMP`和`HRP`报文是单播报文，只要路由可达就可以跨越网段传输，但是受安全策略控制。两台防火墙的心跳口之间可以通过路由器这种三层设备相连，但是需要配置安全策略允许报文在`Local`区域与心跳口所在安全区域间双向通过。另外，使用业务接口做心跳口时也必须使用`UDP`封装`VGMP`报文。

------

##### 2.2.5.VGMP组的缺省情况

![image-20250914235420236](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914235420376.png)

如上图，每台防火墙有两个`VGMP`组：`Active`和`Standby`。缺省情况下，`Active`组的优先级为`65001`。`Standby`组的优先级为`65000`。

主备情况下，主用设备启用`Active`组，所有`VRRP`备份组加入`Active`组；备用设备启用`Standby`组，所有`VRRP`备份组加入`Standby`组。

负载分担情况下，两台设备都启用`Active`和`Standby`组，`VRRP`备份组分别加入`Active`和`Standby`。`FW1`的`Active`组和`FW2`的`Standby`组形成一组**主备**，`FW2`的`Active`组和`FW1`的`Standby`组形成一组**主备**，两台防火墙互为主备，形成负载分担。

以上是中低端防火墙`USG2000/5000/6000`的情况，高端防火墙存在接口板和业务板，所以高端防火墙的缺省优先级与中低端防火墙是不同的：

- `Active`优先级：`45001 + 1000 X （业务板个数 + 接口板个数）`
- `Standby`优先级：`45000 + 1000 X （业务板个数 + 接口板个数）`

------

##### 2.2.6.VGMP的状态机

![image-20250914233901079](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914233901208.png)

**初始化：**

1. 启用双机热备后，`VGMP`组进入`Initialize`初始化状态。
2. 启用`Active`组后，`Active`组的状态由`Initialize`切换成`Active`。
3. 启用`Standby`组后，`Standby`组的状态由`Initialize`切换成`Standby`。

**接口故障**

1. 本端`VGMP`组监控的接口故障时，状态由`Active`切换成`Active ToStandby`，并发送`VGMP`请求报文给对端设备的`VGMP`组。
2. 本端`VGMP`组收到对端的`VGMP`请求报文，发现自身优先级高，则将状态由`Standby`切换成`Active`，并发送`VGMP`确认报文给对端设备的`VGMP`组。
3. 本端`VGMP`组收到对端的`VGMP`确认报文，确认本段需要进行状态切换，则本端的`VGMP`组状态由`Active ToStandby`切换成`Standby`。
4. 对端`VGMP`组确认本端的`VGMP`组不需要进行状态切换或连续三次没有回应本端的`VGMP`请求报文，则本端的`VGMP`组状态由`Active ToStandby`切换成`Standby`。

**故障恢复**

1. 本端`VGMP`组监控的接口故障恢复后，如果本端`VGMP`组优先级高于对端且配置了抢占功能，则本端`VGMP`组状态由`Standby`切换成`Standby ToActive`，并向对端发送`VGMP`请求报文。
2. 本端`VGMP`组收到对端的`VGMP`请求报文，发现对端优先级高，则将状态由`Active`状态切换成`Standby`，并发送`VGMP`确认报文给对端设备的`VGMP`组。
3. 本端`VGMP`组收到对端的`VGMP`确认报文，确认本端需要进行状态切换，则本端的`VGMP`组状态由`Standby ToActive`切换成`Active`，完成抢占过程。
4. 对端`VGMP`组确认本段的`VGMP`组不需要进行状态切换或连续三次没有回应本端的`VGMP`请求报文，则本端的`VGMP`组状态由`Standby ToActive`切换成`Standby`。

------

### 3.HRP

#### 3.1.HRP概述

防火墙通过执行命令来实现用户所需的各种功能。如果备用设备切换为主用设备前，配置命令没有备份到备用设备，则备用设备无法实现主用设备的相关功能，从而导致业务中断。

![image-20250909162824579](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250911143357572.png)

如上图，`FW1`和`FW2`配置了主备模式的防火墙双机热备，`FW1`为主。为了使内网主机能够成功访问外网，配置了安全策略。如果**主设备**上的安全策略没有备份到备用设备上，一旦主设备故障，由于备用设备没有安全策略导致网络故障。

另外除了安全策略之外，防火墙是**状态检测防火墙**。主用设备处理业务过程中会创建很多**会话表**，如果没有将会话表同步到备用设备的话，一旦设备出现故障，也会导致业务中断。

所以，为了实现主用设备出现故障时备用设备能平滑地接替工作，必须在主用和备用设备之间备份关键配置命令和会话表等状态信息。华为防火墙引入了**HRP（Huawei Redundancy Protocol）协议**，实现防火墙双机之间动态状态数据和关键配置命令的备份。

------

##### 3.1.1.主备与负载分担

**主备模式：**

- **工作方式：**同一时间只有一台防火墙充当**主用设备**真正在处理所有网络流量，备用设备则处于空闲状态。
- **同步机制：**主用设备做的任何配置变更以及各种状态都会自动同步给备用设备，方便当主用设备故障后备用设备成功接管流量。

**负载分担模式：**

- **工作方式：**两台防火墙都是**主用设备**，同时处理一部分网络流量，共同分担工作压力，性能更好。
- **产生的问题：**两台防火墙都是主用设备，可能会出现**配置命令相互覆盖或冲突的问题**。

- **解决方法：**最先建立双机热备状态的防火墙会成为**配置主设备**。也就是最先启用双机热备功能的防火墙会成为**配置主设备**。
  - **配置主设备(Primary)：**唯一有权力下发配置命令的防火墙，命令行提示符前有`HRP_A`的标记。
  - **配置从设备（Secondary）：**另一台防火墙，依旧负责处理一部分流量，但是不允许下发配置命令，只能接收`Primary`的配置同步。命令行提示符前有`HRP_S`标记。

**注意：**在负载分担模式下，**状态信息**是互相备份的。

|     特性     |  **主备备份模式**  |       **负载分担模式**        |
| :----------: | :----------------: | :---------------------------: |
| **工作角色** | 一个主用，一个备用 |    两个都是主用（都干活）     |
| **配置同步** | 主 -> 备 （单向）  | **配置主 -> 配置从 （单向）** |
| **状态同步** | 主 -> 备 （单向）  | **两台设备互相同步 （双向）** |
| **管理方式** |  在主用设备上配置  |    **在配置主设备上配置**     |

------

##### 3.1.2HRP报文结构和实现原理

防火墙通过心跳口（`HRP`备份通道）发送和接收`HRP`数据报文来实现配置和状态信息的备份。`HRP`数据报文从外到内依次封装了`VRRP`报文头、`VGMP`报文头和`HRP`报文头。其中`VRRP`报文头中`Type=2`，`Type2=2`。`VGMP`报文头中的`vType`字段对应为`HRP`数据报文的取值。

![image-20250911234915994](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250911234916044.png)

- `Source Module ID`和`Source Sub Module ID`表示本端防火墙哪些特性模块和子模块的数据需要备份。
- `Dest Module ID`和`Dest Sub Module ID`表示需要向对端防火墙的哪些特性模块和子模块备份数据。

**HRP数据备份过程：**

![image-20250911235510659](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250911235510728.png)

1. `FWA`在发送`HRP`数据报文时，会将`ASPF`特性模块的`ID`写入`HRP`报文头的`Source Module ID`和`Dest Module ID`字段中，并将`ASPF`模块的配置和表项信息封装到`HRP`数据报文中。

2. `FWA`将`HRP`数据报文通过备份通道（心跳线）发送给`FWB`。
3. `FWB`收到`HRP`数据报文后，会根据`HRP`报文头中的`Source Module ID`和`Dest Module ID`字段将报文中的配置和表项信息发送到本端的`ASPF`特性模块，并进行配置与表项的下发。

`HRP`同样也支持`UDP`封装方式：

![image-20250911235942304](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250911235942364.png)

------

##### 3.1.3.HRP能够备份的配置与状态信息

**防火墙能够备份的配置如下：**

- **策略：**安全策略、`NAT`策略、带宽管理、认证策略、攻击防范、黑名单、`ASPF`。
- **对象：**地址、地区、服务、应用、用户、认证服务器、时间段、`URL`分类、关键字组、邮件地址组、签名、安全配置文件（反病毒、入侵防御、`URL`过滤、文件过滤、内容过滤、应用行为控制、邮件过滤）。
- **网络：**新建逻辑接口、安全区域、`DNS`、`IPSec`、`SSL VPN`、`TSM`联动。
- **系统：**管理员、日志配置。

**注意：**防火墙的网络基本配置（接口地址和路由等）都不能够备份，这些配置需要在双机热备状态成功建立前配置完成。而上面支持备份的配置可以在双机热备状态成功建立后，只在主用设备上配置。

**防火墙能够备份的状态信息如下：**

- 会话表
- `ServerMap`表
- `IP`监控表
- 分片缓存表
- `GTP`表
- 黑名单
- `PAT`方式端口映射表
- `No-PAT`方式地址映射表

------

##### 3.1.4.HRP的备份方式

**自动备份功能**

自动备份功能（`hrp auto-sync [config | connection-statuc]`）缺省为开启状态，能够自动实时备份配置命令和周期性地备份状态信息，适用于各种双机热备组网。

- **配置备份：**
  - 启用自动备份功能后，**配置主设备**上每执行一条可以备份的命令时，此**配置命令**就会被立即同步备份到**配置备设备**上。
  - 如果在**配置主设备**上执行不可以备份的命令，则该命令仅在**配置主设备上**执行。
  - 对于可以备份的配置命令，只能在**配置主设备**上配置。
  - 对于不可以备份的配置命令，**配置备设备**上也可以配置。
- **状态信息备份：**
  - 启用自动备份功能后，主用设备会周期性的将可以备份的状态信息备份到备用设备上。即主用设备的状态信息建立后不会立即备份，需要经过一个周期后才会备份到备用设备。
  - 自动备份不会备份以下类型的会话（快速会话备份支持）：
    - 到防火墙自身的会话，比如管理员登录防火墙时产生的会话。
    - 未完成三次握手的`TCP`半连接会话。
    - 只为`UDP`首包创建，而不被后续报文匹配的会话。

------

**快速备份**

快速会话备份功能，命令为`hrp mirror session enable`，适用于负载分担的工作模式，以应对报文来回路径不一致的场景。为了保证状态信息的及时同步，快速备份功能只是备份状态信息，不备份配置的命令。

启用**快速会话备份功能**后，主用设备会实时的将可以备份的状态信息（包括上面提到的自动备份不支持的会话）都同步到备用设备上。即在主用设备状态信息建立的时候立即将其实时备份到备用设备。

**报文来回路径不一致：**

![image-20250912002338948](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250912002339026.png)

如果没有开启**快速备份功能**，状态信息需要依赖**自动备份**也就是周期性备份。如上图，负载分担双机热备中的两台防火墙同时接收流量，若内网主机通过`FW1`访问外网主机，当流量经过`FW1`时会创建**会话表**允许回包经过。若`FW1`还没有来得及向`FW2`同步**状态信息**，而回包已经通过`FW2`回程时，就会因为`FW2`上没有**会话表**而拒绝通过，导致流量中断。

------

**手工批量备份**

手工批量备份需要管理员手工出发，每执行一次手工批量备份命令（`hrp sunc [ config | connection-status]`），主用设备就会立即同步一次配置命令和状态信息到备用设备。因此手工批量备份主要适用于主备设备之间配置不同步时，需要手工同步的场景。

我们可以在防火墙上配置一致性检查功能，检查两台防火墙的配置是否同步。

- 执行手工批量备份命令后，主用（配置主）设备会立即同步一次可以备份的配置命令到备用（配置备）设备。
- 执行手工批量备份命令后，主用设备会立即同步一次可以备份的状态信息到备用设备，而不必等到自动备份周期的到来。

------

##### 3.1.5.心跳链路探测报文

两台防火墙之间备份的数据是通过防火墙的**心跳口**发送和接收的。心跳口必须是状态独立且有`IP`地址的接口，可以是一个物理接口，也可以是`Eth-Trunk`。通常我们可以配置多个心跳口（多个物理口或`Eth-trunk`），从而形成多条心跳链路，以保证备份数据的可靠传输。

两台防火墙通过心跳口相互发送心跳链路探测报文，来检测对端设备的心跳口能否正常接收本端设备的报文，以确定是否有心跳口可以使用。心跳链路探测报文也是由`VRRP`报文头封装的，当`VRRP`报文头中`Type-2,Type2=2`时，报文封装成心跳探测链路报文。

![image-20250912003438571](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250912003438623.png)

如上图，心跳口有五种状态（`display hrp interface`）：

- **invalid：**当本端防火墙上的心跳口配置错误时显示此状态（物理`UP`，协议`Down`），例如指定的心跳口为二层接口或未配置心跳接口的`IP`地址。

- **down：**当本端防火墙上的心跳口的物理与协议状态均为`down`时，则会显示此状态。

- **peerdown：**当本端防火墙上的心跳口物理与协议状态均为`UP`时，则心跳口会向对端对应的心跳口发送心跳链路探测报文。如果收不到对端响应的报文，那么防火墙会设置心跳接口状态为`peerdown`。但是心跳口还会不断发送心跳链路探测报文，以便当对端的对应心跳口`up`后，该心跳链路能处于连通状态。

- **ready：**当本端防火墙上的心跳口的物理与协议状态均为`UP`时，则心跳口会向对应的心跳口发送心跳链路探测报文。如果对端心跳口能够响应此报文，那么防火墙会设置本端心跳口状态为`ready`，随时准备发送和接收心跳报文。这是心跳口依旧会不断发送心跳链路探测报文，以保证心跳链路的状态正常。

- **running：**当本端防火墙有多个处于`ready`状态的心跳口时，防火墙会选择最先配置的心跳口形成心跳链路，并设置此心跳口的状态为`running`。状态为`running`的接口负责发送和接收`HRP`心跳报文、`HRP`数据报文、`HRP`一致性检查报文和`VGMP`报文。

  - 这时其余处于`ready`状态的心跳口处于备份状态，当处于`running`状态的心跳口或心跳链路故障时，其余处于`ready`状态的心跳口依次（配置先后顺序）接替当前心跳口处理业务。

    ![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250912004419108.png)

    - 如上图，当`G1/0/3`接口故障后`G1/0/4`就会进入`running`状态。

------

**特殊情况：**

![image-20250912004809302](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250912004809377.png)

由于`FW1`最先配置的心跳接口是`G1/0/3`所以该接口进入`Running`状态，而`FW2`最先配置的心跳接口是`G1/0/2`所以该接口进入`Running`状态，此时`FW1`会从`G1/0/3`接口发送报文，而`FW2`从`G1/0/2`接口发送。虽然发送和接收接口不一致，但这不会影响双机热备的正常工作。

------

##### 3.1.6.HRP心跳报文与心跳链路探测报文

- **心跳链路探测报文：**用于检测对端设备的心跳口能够正常接收本端设备的报文，以确定心跳口是否可用。只要本端心跳接口的物理和协议状态为`UP`就会向对端心跳口发送心跳链路探测报文进行探测。
- **HRP心跳报文：**用于探测和感知对端设备（`VGMP`组）是否正常工作。`HRP`心跳报文只有主用设备的`VGMP`组通过状态为`running`的心跳口发出。

------

##### 3.1.7.HRP一致性检查报文

**作用：**

`HRP`一致性检查报文用于检测双机热备状态下的两台防火墙的**双机热备配置**是否一致以及**策略配置**是否相同。双机热备配置的一致性检查包括两台防火墙是否监控了相同的业务接口，是否配置了相同的心跳接口等。

策略配置一致性检查主要检查两台防火墙是否配置了相同的策略，包括安全策略、带宽策略、`NAT`策略、认证策略和审计策略。`HRP`一致性检查报文也是由`VRRP`报文头封装的，当`VRRP`报文头中`Type=2,Type2=5`时，报文封装成`HRP`一致性报文。

**实现原理：**

1. 执行一致性检查命令（`hrp configuration check { all | audit-policy | auth-policy | hrp | nat-policy | security-policy | traffic-policy }`）后，执行此命令的设备会发送一致性检查请求报文给对端，并且同时收集自身的相关模块的配置信息摘要。
2. 对端设备收到请求后，会收集自身相关模块的配置信息摘要，然后封装到一致性检查报文中返回给本端设备。

3. 本端设备会对比自身的配置摘要和对端设备的配置摘要，并记录并比较信息。可以执行命令`display hrp configuration check`查看一致性检查结果。如下结果表示双机热备配置一致：

![image-20250912010101877](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250912010101955.png)

------

### 4.进阶

#### 4.1.主备模式（理论）

![image-20250914153558100](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914162422062.png)

当前通过`FW1`和`FW2`形成**主备模式双机热备**，由于这两台防火墙部署位置处于**出口位置**，故上下都连接一台交换机，创建两个`VRRP`备份组，一个负责上行流量，一个负责下行流量。

现要求`FW1`作为**主用设备**，在`FW1`上启用`Active`组（`VGMP`），将所有`VRRP`备份组都加入`Active`组。`FW2`作为备用设备，在`FW2`上启用`Standby`组（`VGMP`），将所有`VRRP`备份组都加入`Standby`组。

由于`VGMP`报文和`HRP`报文都是通过心跳口发送的，心跳口是双机热备的**命脉**，需要注意如下内容：

- 两台设备的心跳口必须加入相同的安全区域。
- 两台设备的心跳口的接口类型和编号必须相同。
  - 例如主用设备的心跳接口为`G1/0/2`，那么备用设备的心跳口也必须为`G1/0/2`。
- 心跳口可有如下几种选择：
  - **二层通信：**心跳口可以直连或通过二层交换机相连。配置方法是在配置心跳口时不添加`remote`参数。这时心跳口发送的报文使用`VRRP`报文封装的，是组播报文。组播报文不能跨越网段传输，且不受安全策略控制。这是首选的心跳口相连方式。
  - **三层通信：**心跳口之间可以跨三层进行通信，配置方式是在配置心跳口时添加`remote`参数，指定对端心跳口地址（如：`hrp interface G1/0/2 remote 10.1.1.2`）。添加`remote`参数后，从心跳口发送的各种报文将封装成`UDP`报文。`UDP`报文是单播报文，只要路由可达就可以跨网段传输，但需要收到安全策略控制。安全策略的配置方式是允许目的端口为`18514`的报文在`Local`区域与心跳口所在安全区域间双向通过。
  - **业务口：**当两台防火墙接口资源紧张时，也可以使用业务接口作为心跳口。配置方法是在配置心跳口时添加`remote`参数，指定对端心跳口（其中的一个业务接口）的地址。安全策略配置方式与**三层通信**一致。

------

##### 4.1.1.状态同步过程

![image-20250913211855817](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250913211855912.png)

如上图，配置完成后，主备备份模式的双机热备状态形成过程如下：

1. 双机热备启用之后，`FW1`的`Active`组的状态会由`Initialize`切换成`Active`，`FW2`的`Standby`组的状态由`Initialize`切换成`Standby`。
2. 由于`FW1`的`VRRP`备份组都加入了`Active`组，而`Active`组的初始状态`Active`，所以`FW1`的`VRRP`备份组状态都为`Active`。`FW2`同理。
3. 这是`FW1`的两个`VRRP`备份组分别向上行和下行交换机发送免费`ARP`报文，将`VRRP`备份组的虚拟`MAC`地址通告给它们。
4. 上下行交换机的`MAC`表会分别记录虚拟`MAC`地址与端口的对应关系。这样当上下行的业务报文到达交换机后，交换机会将报文转发到`FW1`上，所以`FW1`成为了主用设备，`FW2`成为了备用设备。
5. 同时`FW1`的`Active`组还会通过心跳线定时向`FW2`的`Standby`组发送`HRP`心跳报文、心跳链路探测报文与同步报文。

------

##### 4.1.2.主用设备接口故障后的状态切换过程

两台防火墙形成主备备份状态后，如果主用设备的接口故障，那么两台防火墙会发生主备状态切换过程，具体过程如下：

![image-20250913213013684](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250913213013768.png)

1. 如上图，当主用设备的接口`G1/0/1`故障后，`FW1`的`VRRP`备份组`1`的状态变成`Initialize`。
2. `FW1`的`Active`组会感知到这一变化，将自身的优先级降低`2`（一个接口故障优先级降低`2`），并将自身状态切换从`Active to Standby`，这是一种短暂的中间状态，用户是不可见的。
3. `FW1`的`Active`组会向对端发送`VGMP`请求报文，请求将状态切换时`Standby`。`VGMP`请求报文是一种`VGMP`报文，携带本端`VGMP`组调整后的优先级`64999`。
4. 如下图，`FW2`的`Standby`组收到`FW1`的`Active`组的`VGMP`请求报文后，将会与对端比较`VGMP`优先级。经过比较后发现本端的优先级`65000`高于对端的`64999`，因此`FW2`的`Standby`组会将自身状态切换成`Active`。

![image-20250913213419566](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250913213419661.png)

5. `FW2`的`Standby`组会向对端返回`VGMP`应答报文，允许对端进行状态切换。
6. 与此同时`FW2`的`Standby`组会强制组内的`VRRP`备份组`1`和`2`也将状态切换成`Active`。
7. `FW2`的`VRRP`备份组`1`和`2`会分别向下行和上行交换机发送免费`ARP`报文，更新他们的`MAC`转发表。

8. `FW1`的`Active`组收到对端的`VGMP`确认报文后，会将自身状态切换从`Standby`。
9. `FW1`的`Active`组会强制组内`VRRP`备份组状态切换成`Standby`。由于`VRRP`备份组`1`内的接口故障，所以`VRRP`备份组`1`的状态为`Initialize`不变，只有`VRRP`备份组`2`的状态切换成`Standby`。
10. 与此同时，上下行交换机收到`FW2`的免费`ARP`报文后会更新`MAC`地址表项，记录虚拟`MAC`地址与端口的对应关系。这样当上下行的业务流量到达交换机后，交换机会将流量转发到`FW2`上。至此两台防火墙的主备状态切换完成，`FW2`成为新的主用设备，`FW1`成为新的备用设备。
11. 主备状态切换完成后，新的主用设备`FW2`会定时向新的备用设备`FW1`发送心跳报文。

------

##### 4.1.3.主用设备整机故障后的状态切换过程

当主用设备**整机故障**后，主用设备的`VGMP`组将不会再发送`HRP`心跳报文。这时如果备用设备的`VGMP`组连续三次收不到主用设备的`HRP`心跳报文，那么它就会认定对端的`VGMP`组故障，从而将自身切换到主用状态。

------

##### 4.1.4.原主用设备故障恢复后的状态切换过程（抢占）

当原主用设备故障恢复后，如果配置了抢占功能，那么原主用设备将重新抢占成为主用设备。如果没有配置抢占功能，则原主用设备依旧保持备份状态。

![image-20250913214713020](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250913214713104.png)

1. 如上图所示，原主用设备的接口`GE1/0/1`故障恢复后，`VRRP`备份组`1`的状态由`Initialize`切换成`Standby`。
2. `FW1`的`Active`组感知到这一变化后，会将自身的优先级升高`2`，升高到`65001`。`FW1`的`Active`组会与对端比较`VGMP`优先级，对端的优先级信息是从对端发送的`HRP`心跳包文中获取的。经过比较后发现本端的优先级`65001`高于对端的`65000`。这时如果配置了抢占功能，则会启动抢占延时。抢占延时结束后，`FW1`的`Active`组会将状态由`Active To Standby`切换成`Standby To Active`。这是一种短暂的中间状态，用户不可见。
3. `FW1`的`Active`组会向对端发送`VGMP`请求报文，请求将状态切换从`Active`。`VGMP`请求报文是一种`VGMP`报文，携带本端`VGMP`组调整后的优先级`65001`。

![image-20250913215121787](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250913215121878.png)

4. 如上图所示，`FW2`的`Standby`组收到`FW1`的`Active`组的`VGMP`请求报文后，将会与对端比较`VGMP`优先级。经过比较后发现本端的优先级`65000`低于对端的`65001`，因此`FW2`的`Standby`组会将自身状态切换成`Standby`。

5. `FW2`的`Standby`组会向对端返回`VGMP`应答报文，允许对端将状态切换成`Active`。
6. 与此同时`FW2`的`Standby`组会强制组内的`VRRP`备份组`1`和`2`也将状态切换成`Standby`。

![image-20250913215352768](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250913215352864.png)

7. 如上图所示，`FW1`的`Active`组收到对端的`VGMP`确认报文后，会将自身状态切换成`Active`。
8. `FW1`的`Active`组会强制组内的`VRRP`备份组`1`和`2`也将状态切换成`Active`。
9. `FW1`的`VRRP`备份组`1`和`2`会分别向下行和上行交换机发送免费`ARP`报文，更新它们的`MAC`转发表。上下行交换机收到免费`ARP`报文后会更新`MAC`表项，记录虚拟`MAC`地址与端口的对应关系。这样当上下行的业务报文到达交换机后，交换机会将报文转发到`FW1`上。至此两台防火墙的主备状态切换完成，`FW1`重新抢占成为主用设备，`FW2`重新成为备用设备。
10. 主备状态切换完成后，主用设备`FW1`会定时向备用设备`FW2`发送心跳报文。

------

#### 4.2.主备模式（实操） 

##### 4.2.1.环境说明

1. `FW1`与`FW2`组成**主备模式**双机热备，`FW1`为主用设备`FW2`为备用设备
2. `VRRP`备份组`1`负责上行对接`AR1`，`VRRP`备份组`2`负责下行对接`PC1`
   - 由于`AR1`模拟运营商路由器，所以`FW1`和`FW2`上行物理接口配置**私网地址**，`VRRP`备份组地址为公网地址
3. 心跳报文使用`UDP`封装，网段为`10.1.1.0/30`
4. 最终`PC`需要`ping`通`100.100.100.100`

![image-20250914153558100](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914153558219.png)

##### 4.2.2.基础配置

**防火墙接口地址：**

```
[FW1]interface g1/0/0
[FW1-GigabitEthernet1/0/0]ip add 10.1.1.1 30
[FW1-GigabitEthernet1/0/0]quit
[FW1]interface g1/0/1
[FW1-GigabitEthernet1/0/1]ip add 10.2.0.1 24
[FW1-GigabitEthernet1/0/1]quit
[FW1]interface g1/0/2
[FW1-GigabitEthernet1/0/2]ip add 192.168.10.252 24
[FW1-GigabitEthernet1/0/2]quit

[FW2]int g1/0/0
[FW2-GigabitEthernet1/0/0]ip add 10.1.1.2 30
[FW2-GigabitEthernet1/0/0]quit
[FW2]int g1/0/1
[FW2-GigabitEthernet1/0/1]ip add 10.2.0.2 24
[FW2-GigabitEthernet1/0/1]quit
[FW2]int g1/0/2
[FW2-GigabitEthernet1/0/2]ip add 192.168.10.253 24
[FW2-GigabitEthernet1/0/2]quit
```

**防火墙接口安全区域：**

```
[FW1]firewall zone untrust 
[FW1-zone-untrust]add interface g1/0/1
[FW1-zone-untrust]quit
[FW1]firewall zone dmz
[FW1-zone-dmz]add interface g1/0/0
[FW1-zone-dmz]quit
[FW1]firewall zone trust 
[FW1-zone-trust]add interface g1/0/2
[FW1-zone-trust]quit

[FW2]firewall zone trust 
[FW2-zone-trust]add int g1/0/2
[FW2-zone-trust]quit
[FW2]firewall zone untrust 
[FW2-zone-untrust]add int g1/0/1
[FW2-zone-untrust]quit
[FW2]firewall zone dmz
[FW2-zone-dmz]add int g1/0/0
[FW2-zone-dmz]quit
```

**防火墙默认路由**

```
[FW1]ip route-static 0.0.0.0 0 202.100.100.10

[FW2]ip route-static 0.0.0.0 0 202.100.100.10
```

**路由器配置：**

```
[AR1]int g0/0/0
[AR1-GigabitEthernet0/0/0]ip add 202.100.100.10 24
[AR1-GigabitEthernet0/0/0]quit
[AR1]int loo0
[AR1-LoopBack0]ip add 100.100.100.100 32
[AR1-LoopBack0]quit
```

##### 4.2.3.VRRP与VGMP配置

```
[FW1]interface g1/0/1
[FW1-GigabitEthernet1/0/1]vrrp vrid 1 virtual-ip 202.100.100.1 24 active
[FW1-GigabitEthernet1/0/1]quit
[FW1]interface g1/0/2
[FW1-GigabitEthernet1/0/2]vrrp vrid 2 virtual-ip 192.168.10.254 24 active
[FW1-GigabitEthernet1/0/2]quit

[FW2]int g1/0/1
[FW2-GigabitEthernet1/0/1]vrrp vrid 1 virtual-ip 202.100.100.1 24 standby 
[FW2-GigabitEthernet1/0/1]quit
[FW2]int g1/0/2
[FW2-GigabitEthernet1/0/2]vrrp vrid 2 virtual-ip 192.168.10.254 24 standby 
[FW2-GigabitEthernet1/0/2]quit
```

##### 4.2.4.心跳口配置

```
[FW1]hrp interface g1/0/0 remote 10.1.1.2
[FW1]hrp enable

[FW2]hrp interface g1/0/0 remote 10.1.1.1
[FW2]hrp enable
```

- 一开始两台防火墙的状态都会进入`Standby`，等待`HRP`心跳报文交互完毕后，`FW1`的身份会切换：

```
HRP_M[FW1]
HRP_S[FW2]
```

- 如果你开启了`firewall packet-filter basic-potocol enable`需要在**两台防火墙**上配置如下策略：

```
[FW1] security-policy
[FW1-policy-security] rule name ha_local_to_dmz
[FW1-policy-security-rule-ha_local_to_dmz] source-zone local dmz
[FW1-policy-security-rule-ha_local_to_dmz] destination-zone local dmz
[FW1-policy-security-rule-ha_local_to_dmz] service protocol udp destination-port 18514
[FW1-policy-security-rule-ha_local_to_dmz] action permit
[FW1-policy-security-rule-ha_local_to_dmz] quit
[FW1-policy-security] quit
```

##### 4.2.5.配置NAT

双机热备防火墙不建议使用`Easy-IP`模式的`NAT`。

```
HRP_M[FW1]nat address-group group1
HRP_M[FW1-address-group-group1]section 202.100.100.2 202.100.100.5
HRP_M[FW1-address-group-group1]quit

HRP_M[FW1]nat-policy  (+B)
HRP_M[FW1-policy-nat]rule name policy1 (+B)
HRP_M[FW1-policy-nat-rule-policy1]source-zone trust  (+B)
HRP_M[FW1-policy-nat-rule-policy1]destination-zone untrust  (+B)
HRP_M[FW1-policy-nat-rule-policy1]source-address 192.168.10.0 24 (+B)
HRP_M[FW1-policy-nat-rule-policy1]action source-nat address-group group1 (+B)
HRP_M[FW1-policy-nat-rule-policy1]quit
HRP_M[FW1-policy-nat]quit

HRP_M[FW1]security-policy  (+B)
HRP_M[FW1-policy-security]rule name trust_to_internet (+B)
HRP_M[FW1-policy-security-rule-trust_to_internet]source-zone trust  (+B)
HRP_M[FW1-policy-security-rule-trust_to_internet]destination-zone untrust  (+B)
HRP_M[FW1-policy-security-rule-trust_to_internet]source-address 192.168.10.0 24 (+B)
HRP_M[FW1-policy-security-rule-trust_to_internet]action permit (+B)
HRP_M[FW1-policy-security-rule-trust_to_internet]quit
HRP_M[FW1-policy-security]quit
```

##### 4.2.6.查看配置同步

**安全策略：**

```
HRP_S[FW2]display security-policy rule all
2025-09-14 16:02:37.900  
Total:2 
RULE ID  RULE NAME                         STATE      ACTION       HITS        
------------------------------------------------------------------------------- 
2        trust_to_internet                 enable     permit       0           
0        default                           enable     deny         23          
-------------------------------------------------------------------------------
```

**nat-policy：**

```
HRP_S[FW2]display nat-policy rule all
2025-09-14 16:03:03.080  
Total:2 
RULE ID  RULE NAME                         STATE      ACTION       HITS        
------------------------------------------------------------------------------- 
2        policy1                           enable     src-nat      0           
0        default                           enable     no-nat       12          
-------------------------------------------------------------------------------
```

**address-group:**

```
HRP_S[FW2]display nat address-group 
2025-09-14 16:03:20.480 
NAT address-group information:
  Total 1 address-group(s)
nat address-group group1 0
 reference count: 1
 mode pat
 status active
 section 0 202.100.100.2 202.100.100.5
```

**默认路由：**

- 备用设备上的默认路由是不会生效的。

```
HRP_S[FW2]display ip routing-table 
2025-09-14 16:03:57.020 
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Tables: Public
         Destinations : 8        Routes : 8        

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       10.1.1.0/30  Direct  0    0           D   10.1.1.2        GigabitEthernet1/0/0
       10.1.1.2/32  Direct  0    0           D   127.0.0.1       GigabitEthernet1/0/0
       10.2.0.0/24  Direct  0    0           D   10.2.0.2        GigabitEthernet1/0/1
       10.2.0.2/32  Direct  0    0           D   127.0.0.1       GigabitEthernet1/0/1
      127.0.0.0/8   Direct  0    0           D   127.0.0.1       InLoopBack0
      127.0.0.1/32  Direct  0    0           D   127.0.0.1       InLoopBack0
   192.168.10.0/24  Direct  0    0           D   192.168.10.253  GigabitEthernet1/0/2
 192.168.10.253/32  Direct  0    0           D   127.0.0.1       GigabitEthernet1/0/2
```

------

##### 4.2.7.PC机测试

```
VPCS> ip 192.168.10.1 24 192.168.10.254
Checking for duplicate address...
VPCS : 192.168.10.1 255.255.255.0 gateway 192.168.10.254

VPCS> ping 202.100.100.10
202.100.100.10 icmp_seq=1 timeout
84 bytes from 202.100.100.10 icmp_seq=2 ttl=254 time=7.818 ms
84 bytes from 202.100.100.10 icmp_seq=3 ttl=254 time=2.302 ms
84 bytes from 202.100.100.10 icmp_seq=4 ttl=254 time=3.446 ms
84 bytes from 202.100.100.10 icmp_seq=5 ttl=254 time=2.954 ms
```

##### 4.2.8.查看会话表

**主用设备：**

```
HRP_M[FW1]display firewall session table 
2025-09-14 16:05:22.310 
 Current Total Sessions : 9
 udp  VPN: public --> public  10.1.1.2:16384 --> 10.1.1.1:18514
 icmp  VPN: public --> public  192.168.10.1:48871[202.100.100.4:2057] --> 202.100.100.10:2048
 udp  VPN: public --> public  10.1.1.2:49152 --> 10.1.1.1:18514
 icmp  VPN: public --> public  192.168.10.1:48103[202.100.100.4:2054] --> 202.100.100.10:2048
 icmp  VPN: public --> public  192.168.10.1:47847[202.100.100.4:2053] --> 202.100.100.10:2048
 tcp  VPN: public --> public  10.2.0.1:60118 --> 192.168.0.1:1024
 udp  VPN: public --> public  10.1.1.1:49152 --> 10.1.1.2:18514
 icmp  VPN: public --> public  192.168.10.1:48359[202.100.100.4:2055] --> 202.100.100.10:2048
 icmp  VPN: public --> public  192.168.10.1:48615[202.100.100.4:2056] --> 202.100.100.10:2048
```

**备用设备：**

```
HRP_S[FW2]display firewall session table 
2025-09-14 16:05:53.860 
 Current Total Sessions : 6
 udp  VPN: public --> public  10.1.1.2:49152 --> 10.1.1.1:18514
 udp  VPN: public --> public  10.1.1.1:16384 --> 10.1.1.2:18514
 icmp  VPN: public --> public  Remote 192.168.10.1:58343[202.100.100.4:2060] --> 202.100.100.10:2048
 icmp  VPN: public --> public  Remote 192.168.10.1:58087[202.100.100.4:2059] --> 202.100.100.10:2048
 udp  VPN: public --> public  10.1.1.1:49152 --> 10.1.1.2:18514
 icmp  VPN: public --> public  Remote 192.168.10.1:57831[202.100.100.4:2058] --> 202.100.100.10:2048
```

##### 4.2.9.查看hrp状态

```
HRP_M[FW1]display hrp state
2025-09-14 16:06:51.560 
 Role: active, peer: standby
 Running priority: 45000, peer: 45000
 Backup channel usage: 0.00%
 Stable time: 0 days, 0 hours, 13 minutes
 Last state change information: 2025-09-14 15:53:04 HRP core state changed, old_state = abnormal(standby), new_state = normal, local_priority = 45000, peer_priority = 45000.
```

```
HRP_S[FW2]display hrp state
2025-09-14 16:07:23.030 
 Role: standby, peer: active
 Running priority: 45000, peer: 45000
 Backup channel usage: 0.00%
 Stable time: 0 days, 0 hours, 14 minutes
 Last state change information: 2025-09-14 15:53:05 HRP link changes to up.
```

##### 4.2.10.查看vrrp状态

```
HRP_M[FW1]display vrrp brief 
2025-09-14 16:08:20.520 
Total:2     Master:2     Backup:0     Non-active:0      
VRID  State        Interface                Type     Virtual IP     
----------------------------------------------------------------
1     Master       GE1/0/1                  Vgmp     202.100.100.1  
2     Master       GE1/0/2                  Vgmp     192.168.10.254

HRP_S[FW2]display vrrp brief 
2025-09-14 16:08:32.990 
Total:2     Master:0     Backup:2     Non-active:0      
VRID  State        Interface                Type     Virtual IP     
----------------------------------------------------------------
1     Backup       GE1/0/1                  Vgmp     202.100.100.1  
2     Backup       GE1/0/2                  Vgmp     192.168.10.254 
```

##### 4.2.11.主用设备关闭上行接口

**PC上持续ping**

```
VPCS> ping 202.100.100.10 -t
```

**关闭接口**

```
HRP_M[FW1]interface g1/0/1 (+B)
HRP_M[FW1-GigabitEthernet1/0/1]shutdown 
HRP_M[FW1-GigabitEthernet1/0/1]quit
```

**查看vrrp**

```
HRP_S[FW1]display vrrp brief 
2025-09-14 16:10:53.660 
Total:2     Master:0     Backup:1     Non-active:1      
VRID  State        Interface                Type     Virtual IP     
----------------------------------------------------------------
1     Initialize   GE1/0/1                  Vgmp     202.100.100.1  
2     Backup       GE1/0/2                  Vgmp     192.168.10.254

HRP_M[FW2]display vrrp brief 
2025-09-14 16:11:03.660 
Total:2     Master:2     Backup:0     Non-active:0      
VRID  State        Interface                Type     Virtual IP     
----------------------------------------------------------------
1     Master       GE1/0/1                  Vgmp     202.100.100.1  
2     Master       GE1/0/2                  Vgmp     192.168.10.254 
```

**查看hrp**

```
HRP_S[FW1]display hrp state
2025-09-14 16:13:19.390 
 Role: standby, peer: active (should be "active-standby")
 Running priority: 44998, peer: 45000
 Backup channel usage: 0.00%
 Stable time: 0 days, 0 hours, 3 minutes
 Last state change information: 2025-09-14 16:10:17 HRP core state changed, old_state = normal, new_state = abnormal(standby), local_priority = 44998, peer_priority = 45000.
 
HRP_M[FW2]display hrp state
2025-09-14 16:13:35.050 
 Role: active, peer: standby (should be "standby-active")
 Running priority: 45000, peer: 44998
 Backup channel usage: 0.00%
 Stable time: 0 days, 0 hours, 3 minutes
 Last state change information: 2025-09-14 16:10:17 HRP core state changed, old_state = normal, new_state = abnormal(active), local_priority = 45000, peer_priority = 44998.
```

**查看静态路由**

```
HRP_M[FW2]display ip routing-table 
2025-09-14 16:13:56.530 
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Tables: Public
         Destinations : 12       Routes : 12       

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

        0.0.0.0/0   Static  60   0          RD   202.100.100.10  GigabitEthernet1/0/1
       10.1.1.0/30  Direct  0    0           D   10.1.1.2        GigabitEthernet1/0/0
       10.1.1.2/32  Direct  0    0           D   127.0.0.1       GigabitEthernet1/0/0
       10.2.0.0/24  Direct  0    0           D   10.2.0.2        GigabitEthernet1/0/1
       10.2.0.2/32  Direct  0    0           D   127.0.0.1       GigabitEthernet1/0/1
      127.0.0.0/8   Direct  0    0           D   127.0.0.1       InLoopBack0
      127.0.0.1/32  Direct  0    0           D   127.0.0.1       InLoopBack0
   192.168.10.0/24  Direct  0    0           D   192.168.10.253  GigabitEthernet1/0/2
 192.168.10.253/32  Direct  0    0           D   127.0.0.1       GigabitEthernet1/0/2
 192.168.10.254/32  Direct  0    0           D   127.0.0.1       GigabitEthernet1/0/2
  202.100.100.0/24  Direct  0    0           D   202.100.100.1   GigabitEthernet1/0/1
  202.100.100.1/32  Direct  0    0           D   127.0.0.1       GigabitEthernet1/0/1
```

**查看ping结果**

![image-20250914161436869](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914161436991.png)

------

#### 4.3.负载分担模式（理论）

![image-20250914163053412](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914163053534.png)

负载分担模式可能与大家想的不太一样，首先因为当前需要实现流量负载分担的目的，所以上下行同时都需要两个`VRRP`备份组。如上图，`VRRP`备份组`1`和`2`负责与上行路由器对接，`VRRP`备份组`3`和`4`负责对接下行`PC`机。此时，一部分`PC`的网关设置为`192.168.10.254`，另一部分网关设置为`192.168.10.253`，那么流量就成功实现负载分担了。（如果，你有多个网段的主机，有多少个网段就要设置两倍的`VRRP`备份组）。

------

##### 4.3.1.状态同步过程

![image-20250914163749487](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914163749610.png)

如上图，配置完成后，负载分担方式的双机热备状态形成过程如下：

1. `FW1`和`FW2`的`Active`组的状态会由`Initialize`切换成`Active`，`Standby`组的状态由`Initialize`切换成`Standby`。
2. 由于`FW1`的`VRRP`备份组`1`和`3`加入了`Active`组，而`Active`组的初始状态为`Active`，所以`FW1`的`VRRP`备份组`1`和`VRRP`备份组`3`的状态都为`Active`；由于`FW2`的`VRRP`备份组`2`和`4`加入了`Standby`组，而`Standby`组的初始状态为`Standby`，所以`FW1`的`VRRP`备份组`2`和`4`状态都为`Standby`。`FW2`同理。

3. 这时`FW1`和`FW2`对应`Active`的`VRRP`备份组会向上行或下行交换机发送免费`ARP`报文，将`VRRP`备份组的虚拟`mac`地址通知给他们。
4. 上下行交换机会记录不同虚拟`MAC`与出接口的关系，当`PC1`的下一跳为`192.168.10.254`时交换机将转发给`FW1`，当`PC2`的下一跳为`192.168.10.253`时交换机会将数据转发给`FW2`。
5. 此时，负载分担形成，`FW1`的`Active`组会定期向`FW2`的`Standby`组发送`HRP`心跳报文，`FW2`的`Active`组会定期向`FW1`的`Standby`组发送`HRP`心跳报文。

------

##### 4.3.2.主用设备接口故障后的状态切换过程

![image-20250914171314076](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914171314203.png)

1. 如上图，当`FW1`的`Ge1/0/1`口故障时，`FW1`的`VRRP`备份组`1`和`2`的状态都会变成`Initialize`。
2. `FW1`的`Active`组与`Standby`组的优先级都会降低`2`。经过`VGMP`组协商后，`FW2`的所有`VRRP`备份组都切换为`Active`。
3. `FW2`的`VRRP`备份组`1`和`3`会分别向下行和上行交换机发送免费`ARP`报文，更新它们的`MAC`地址表。
   1. 负载分担模式此时以及切换成主备备份模式了，主用设备`FW2`会定时向备用设备`FW1`发送心跳报文。

------

#### 4.4.负载分担模式（实操）

##### 4.4.1.环境说明

![image-20250914222526595](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250914222526746.png)

1. `FW1`与`FW2`部署负载分担模式双机热备，两台防火墙上分别部署四个`VRRP`备份组，其中`VRRP`备份组1和`VRRP`备份组`3`的主设备为`FW1`，`VRRP`备份组`2`和`VRRP`备份组`4`的主设备为`FW2`。
2. `VRRP`备份组`1`和`2`负责上行对接`AR1`，`VRRP`备份组`2`和`4`负责下行对接两个`PC`。
3. 心跳报文使用`UDP`封装，网段为`10.1.1.0/30`。
4. 最终两台`PC`需要`ping`通`100.100.100.100`。

------

##### 4.4.2.基础配置

```
[FW1]int g1/0/0
[FW1-GigabitEthernet1/0/0]ip add 10.1.1.1 30
[FW1-GigabitEthernet1/0/0]quit
[FW1]int g1/0/1
[FW1-GigabitEthernet1/0/1]ip add 10.2.0.1 24
[FW1-GigabitEthernet1/0/1]quit
[FW1]int g1/0/2
[FW1-GigabitEthernet1/0/2]ip add 192.168.10.100 24
[FW1-GigabitEthernet1/0/2]quit
[FW1]firewall zone trust 
[FW1-zone-trust]add int g1/0/2
[FW1-zone-trust]quit
[FW1]firewall zone untrust 
[FW1-zone-untrust]add int g1/0/1
[FW1-zone-untrust]quit
[FW1]firewall zone dmz
[FW1-zone-dmz]add int g1/0/0
[FW1-zone-dmz]quit
[FW1]ip route-static 0.0.0.0 0 202.100.100.10

[FW2]int g1/0/0
[FW2-GigabitEthernet1/0/0]ip add 10.1.1.2 30
[FW2-GigabitEthernet1/0/0]quit
[FW2]int g1/0/1
[FW2-GigabitEthernet1/0/1]ip add 10.2.0.2 24
[FW2-GigabitEthernet1/0/1]quit
[FW2]int g1/0/2
[FW2-GigabitEthernet1/0/2]ip add 192.168.10.101 24
[FW2-GigabitEthernet1/0/2]quitr
[FW2]firewall zone trust 
[FW2-zone-trust]add int g1/0/2
[FW2-zone-trust]quit
[FW2]firewall zone untrust 
[FW2-zone-untrust]add int g1/0/1
[FW2-zone-untrust]quit
[FW2]firewall zone dmz
[FW2-zone-dmz]add int g1/0/0
[FW2-zone-dmz]quit
[FW2]ip route-static 0.0.0.0 0 202.100.100.10
```

------

##### 4.4.3.配置VRRP备份组

```
[FW1]interface g1/0/1
[FW1-GigabitEthernet1/0/1]vrrp vrid 1 virtual-ip 202.100.100.1 24 active   
[FW1-GigabitEthernet1/0/1]vrrp vrid 2 virtual-ip 202.100.100.2 24 standby 
[FW1-GigabitEthernet1/0/1]quit
[FW1]interface g1/0/2
[FW1-GigabitEthernet1/0/2]vrrp vrid 3 virtual-ip 192.168.10.254 24 active
[FW1-GigabitEthernet1/0/2]vrrp vrid 4 virtual-ip 192.168.10.253 24 standby 
[FW1-GigabitEthernet1/0/2]quit

[FW2]interface g1/0/1
[FW2-GigabitEthernet1/0/1]vrrp vrid 1 virtual-ip 202.100.100.1 24 standby 
[FW2-GigabitEthernet1/0/1]vrrp vrid 2 virtual-ip 202.100.100.2 24 active 
[FW2-GigabitEthernet1/0/1]quit
[FW2]interface g1/0/2
[FW2-GigabitEthernet1/0/2]vrrp vrid 3 virtual-ip 192.168.10.254 24 standby 
[FW2-GigabitEthernet1/0/2]vrrp vrid 4 virtual-ip 192.168.10.253 24 active 
[FW2-GigabitEthernet1/0/2]quit
```

------

##### 4.4.4.配置安全策略（可选）

```
[FW1] security-policy
[FW1-policy-security] rule name ha_local_to_dmz
[FW1-policy-security-rule-ha_local_to_dmz] source-zone local dmz
[FW1-policy-security-rule-ha_local_to_dmz] destination-zone local dmz
[FW1-policy-security-rule-ha_local_to_dmz] service protocol udp destination-port 18514
[FW1-policy-security-rule-ha_local_to_dmz] action permit
[FW1-policy-security-rule-ha_local_to_dmz] quit
[FW1-policy-security] quit
```

------

##### 4.4.5.配置会话快速备份功能与心跳口

```
[FW1]hrp mirror session enable 
[FW1]hrp interface g1/0/0 remote 10.1.1.2
[FW1]hrp enable

[FW2]hrp mirror session enable 
[FW2]hrp interface g1/0/0 remote 10.1.1.1
[FW2]hrp enable
```

------

##### 4.4.6.配置NAT

- **注意：**双机热备状态形成后，需要在**配置主设备**上输入命令。

```
HRP_M[FW1]nat address-group group1
HRP_M[FW1-address-group-group1]se
HRP_M[FW1-address-group-group1]section 202.100.100.5 202.100.100.10
HRP_M[FW1-address-group-group1]quit

HRP_M[FW1]nat-policy  (+B)
HRP_M[FW1-policy-nat]rule name policy1 (+B)
HRP_M[FW1-policy-nat-rule-policy1]source-zone trust  (+B)
HRP_M[FW1-policy-nat-rule-policy1]destination-zone untrust  (+B)
HRP_M[FW1-policy-nat-rule-policy1]source-address 192.168.10.0 24 (+B)
HRP_M[FW1-policy-nat-rule-policy1]action source-nat address-group group1 (+B)
HRP_M[FW1-policy-nat-rule-policy1]quit
HRP_M[FW1-policy-nat]quit

HRP_M[FW1]hrp nat resource primary-group  (+B)	# 防止两台设备进行NAT转换时端口冲突
# 主设备敲完之后，会在备用设备上自动备份，并且转换成hrp nat resource secondary-group

HRP_M[FW1]security-policy  (+B)
HRP_M[FW1-policy-security]rule name trust_to_internet (+B)
HRP_M[FW1-policy-security-rule-trust_to_internet]source-zone trust  (+B)
HRP_M[FW1-policy-security-rule-trust_to_internet]destination-zone untrust  (+B)
HRP_M[FW1-policy-security-rule-trust_to_internet]source-address 192.168.10.0 24 (+B)
HRP_M[FW1-policy-security-rule-trust_to_internet]action  permit (+B)
HRP_M[FW1-policy-security-rule-trust_to_internet]quit
HRP_M[FW1-policy-security]quit
```

------

##### 4.4.7.查看VRRP

```
HRP_M[FW1]display vrrp brief 
2025-09-14 19:17:30.770 
Total:4     Master:2     Backup:2     Non-active:0      
VRID  State        Interface                Type     Virtual IP     
----------------------------------------------------------------
1     Master       GE1/0/1                  Vgmp     202.100.100.1  
2     Backup       GE1/0/1                  Vgmp     202.100.100.2  
3     Master       GE1/0/2                  Vgmp     192.168.10.254 
4     Backup       GE1/0/2                  Vgmp     192.168.10.253

HRP_S[FW2]display vrrp brief 
2025-09-14 19:17:40.830 
Total:4     Master:2     Backup:2     Non-active:0      
VRID  State        Interface                Type     Virtual IP     
----------------------------------------------------------------
1     Backup       GE1/0/1                  Vgmp     202.100.100.1  
2     Master       GE1/0/1                  Vgmp     202.100.100.2  
3     Backup       GE1/0/2                  Vgmp     192.168.10.254 
4     Master       GE1/0/2                  Vgmp     192.168.10.253 
```

------

##### 4.4.8.查看HRP

```
HRP_M[FW1]display hrp state 
2025-09-14 19:17:54.820 
 Role: active, peer: active
 Running priority: 45000, peer: 45000
 Backup channel usage: 0.00%
 Stable time: 0 days, 0 hours, 14 minutes
 Last state change information: 2025-09-14 19:03:42 HRP link changes to up.
 
HRP_S[FW2]display hrp state 
2025-09-14 19:18:27.590 
 Role: active, peer: active
 Running priority: 45000, peer: 45000
 Backup channel usage: 0.00%
 Stable time: 0 days, 0 hours, 14 minutes
 Last state change information: 2025-09-14 19:03:41 HRP core state changed, old_state = abnormal(standby), new_state = normal, local_priority = 45000, peer_priority = 45000.
```

------

##### 4.4.9.测试

```
VPCS> ip 192.168.10.1 24 192.168.10.254
Checking for duplicate address...
VPCS : 192.168.10.1 255.255.255.0 gateway 192.168.10.254
VPCS> ping 100.100.100.100
100.100.100.100 icmp_seq=1 timeout
84 bytes from 100.100.100.100 icmp_seq=2 ttl=254 time=5.916 ms
84 bytes from 100.100.100.100 icmp_seq=3 ttl=254 time=2.408 ms
84 bytes from 100.100.100.100 icmp_seq=4 ttl=254 time=2.614 ms
84 bytes from 100.100.100.100 icmp_seq=5 ttl=254 time=3.151 ms

VPCS> ip 192.168.10.2 24 192.168.10.253
Checking for duplicate address...
VPCS : 192.168.10.2 255.255.255.0 gateway 192.168.10.253
VPCS> ping 100.100.100.100
84 bytes from 100.100.100.100 icmp_seq=1 ttl=254 time=3.478 ms
84 bytes from 100.100.100.100 icmp_seq=2 ttl=254 time=2.884 ms
84 bytes from 100.100.100.100 icmp_seq=3 ttl=254 time=2.915 ms
84 bytes from 100.100.100.100 icmp_seq=4 ttl=254 time=2.418 ms
84 bytes from 100.100.100.100 icmp_seq=5 ttl=254 time=3.888 ms
```

------

##### 4.4.10.查看会话表

```
HRP_M[FW1]display firewall session table 
2025-09-14 22:34:35.550 
 Current Total Sessions : 14
 udp  VPN: public --> public  10.1.1.2:16384 --> 10.1.1.1:18514
 icmp  VPN: public --> public  192.168.10.1:62786[202.100.100.9:2054] --> 100.100.100.100:2048
 icmp  VPN: public --> public  Remote 192.168.10.2:62274[202.100.100.8:2085] --> 100.100.100.100:2048
 udp  VPN: public --> public  10.1.1.2:49152 --> 10.1.1.1:18514
 tcp  VPN: public --> public  10.2.0.1:48781 --> 192.168.0.1:1024
 icmp  VPN: public --> public  192.168.10.1:63042[202.100.100.9:2055] --> 100.100.100.100:2048
 icmp  VPN: public --> public  192.168.10.1:63554[202.100.100.9:2057] --> 100.100.100.100:2048
 icmp  VPN: public --> public  Remote 192.168.10.2:63042[202.100.100.8:2088] --> 100.100.100.100:2048
 icmp  VPN: public --> public  Remote 192.168.10.2:62018[202.100.100.8:2084] --> 100.100.100.100:2048
 icmp  VPN: public --> public  192.168.10.1:62274[202.100.100.9:2053] --> 100.100.100.100:2048
 udp  VPN: public --> public  10.1.1.1:49152 --> 10.1.1.2:18514
 icmp  VPN: public --> public  Remote 192.168.10.2:62530[202.100.100.8:2086] --> 100.100.100.100:2048
 icmp  VPN: public --> public  192.168.10.1:63298[202.100.100.9:2056] --> 100.100.100.100:2048
 icmp  VPN: public --> public  Remote 192.168.10.2:62786[202.100.100.8:2087] --> 100.100.100.100:2048

HRP_S[FW2]display firewall session table 
2025-09-14 22:34:40.100 
 Current Total Sessions : 14
 icmp  VPN: public --> public  Remote 192.168.10.1:62786[202.100.100.9:2054] --> 100.100.100.100:2048
 icmp  VPN: public --> public  192.168.10.2:62274[202.100.100.8:2085] --> 100.100.100.100:2048
 udp  VPN: public --> public  10.1.1.2:49152 --> 10.1.1.1:18514
 icmp  VPN: public --> public  Remote 192.168.10.1:63042[202.100.100.9:2055] --> 100.100.100.100:2048
 icmp  VPN: public --> public  Remote 192.168.10.1:63554[202.100.100.9:2057] --> 100.100.100.100:2048
 icmp  VPN: public --> public  192.168.10.2:63042[202.100.100.8:2088] --> 100.100.100.100:2048
 udp  VPN: public --> public  10.1.1.1:16384 --> 10.1.1.2:18514
 icmp  VPN: public --> public  192.168.10.2:62018[202.100.100.8:2084] --> 100.100.100.100:2048
 icmp  VPN: public --> public  Remote 192.168.10.1:62274[202.100.100.9:2053] --> 100.100.100.100:2048
 udp  VPN: public --> public  10.1.1.1:49152 --> 10.1.1.2:18514
 icmp  VPN: public --> public  192.168.10.2:62530[202.100.100.8:2086] --> 100.100.100.100:2048
 tcp  VPN: public --> public  10.2.0.2:53826 --> 192.168.0.1:1024
 icmp  VPN: public --> public  Remote 192.168.10.1:63298[202.100.100.9:2056] --> 100.100.100.100:2048
 icmp  VPN: public --> public  192.168.10.2:62786[202.100.100.8:2087] --> 100.100.100.100:2048
```

------

##### 4.4.11.查看配置备份

```
HRP_S[FW2]display nat-policy rule all
2025-09-14 22:35:34.360  
Total:2 
RULE ID  RULE NAME                         STATE      ACTION       HITS        
------------------------------------------------------------------------------- 
1        policy1                           enable     src-nat      14          
0        default                           enable     no-nat       9           
-------------------------------------------------------------------------------
HRP_S[FW2]display nat address-group 
2025-09-14 22:35:41.260 
NAT address-group information:
  Total 1 address-group(s)
nat address-group group1 0
 reference count: 1
 mode pat
 status active
 section 0 202.100.100.5 202.100.100.10
HRP_S[FW2]display security-policy rule all
2025-09-14 22:35:57.050  
Total:2 
RULE ID  RULE NAME                         STATE      ACTION       HITS        
------------------------------------------------------------------------------- 
1        trust_to_internet                 enable     permit       14          
0        default                           enable     deny         0           
-------------------------------------------------------------------------------
```

------

##### 4.4.12.FW1关闭上行口

```
HRP_M[FW1]interface g1/0/1 (+B)
HRP_M[FW1-GigabitEthernet1/0/1]shutdown 
HRP_M[FW1-GigabitEthernet1/0/1]quit
```

**查看VRRP**

```
HRP_S[FW1]display vrrp brief 
2025-09-14 22:37:01.680 
Total:4     Master:0     Backup:2     Non-active:2      
VRID  State        Interface                Type     Virtual IP     
----------------------------------------------------------------
1     Initialize   GE1/0/1                  Vgmp     202.100.100.1  
2     Initialize   GE1/0/1                  Vgmp     202.100.100.2  
3     Backup       GE1/0/2                  Vgmp     192.168.10.254 
4     Backup       GE1/0/2                  Vgmp     192.168.10.253 

HRP_M[FW2]display vrrp brief 
2025-09-14 22:37:30.580 
Total:4     Master:4     Backup:0     Non-active:0      
VRID  State        Interface                Type     Virtual IP     
----------------------------------------------------------------
1     Master       GE1/0/1                  Vgmp     202.100.100.1  
2     Master       GE1/0/1                  Vgmp     202.100.100.2  
3     Master       GE1/0/2                  Vgmp     192.168.10.254 
4     Master       GE1/0/2                  Vgmp     192.168.10.253
```

**查看HRP**

```
HRP_S[FW1]display hrp state 
2025-09-14 22:37:49.100 
 Role: standby, peer: active
 Running priority: 44996, peer: 45000
 Backup channel usage: 0.00%
 Stable time: 0 days, 0 hours, 1 minutes
 Last state change information: 2025-09-14 22:36:47 HRP core state changed, old_state = normal, new_state = abnormal(standby), local_priority = 44996, peer_priority = 45000.
 
HRP_M[FW2]display hrp state
2025-09-14 22:38:01.800 
 Role: active, peer: standby
 Running priority: 45000, peer: 44996
 Backup channel usage: 0.00%
 Stable time: 0 days, 0 hours, 1 minutes
 Last state change information: 2025-09-14 22:36:47 HRP core state changed, old_state = normal, new_state = abnormal(active), local_priority = 45000, peer_priority = 44996.
```

------

#### 4.5.主备模式上下行连接路由器

**注意：防火墙上下行接口放到不同的安全区域！！！！还要写安全策略！！！！**

之前我们的理论及实验都是基于防火墙上下行都为交换机的情况，实际上双机热备根据部署位置与上下行设备还有非常多种情况。可参考：[ HiSecEngine USG6000F 典型配置案例集 ](https://support.huawei.com/enterprise/zh/doc/EDOC1100387633/693dbbdd?idPath=24030814|9856724|21430823|253423179|22914752)

篇幅有限我就不一一举例了，接下来演示**上下行连接路由器**的情况。

![image-20250915150134099](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915150134208.png)

##### 4.5.1.环境说明

![image-20250915003833088](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915003833228.png)

1. 两台防火墙上下行都连接着路由器，通过`OSPF`将网络打通。
2. `FW1`为主用设备，`FW2`为备用设备，正常情况下上下行流量都经过`FW1`转发。
3. 该场景中不包含`VRRP`配置，使用`VGMP`自动调整`OSPF Cost`控制流量走向。
4. 备用设备会在发布路由时将`Cost`值增加`65500`。

------

##### 4.5.2.防火墙基础配置

```
[FW1]int g1/0/0
[FW1-GigabitEthernet1/0/0]ip add 10.10.0.1 30
[FW1-GigabitEthernet1/0/0]quit
[FW1]int g1/0/1
[FW1-GigabitEthernet1/0/1]ip add 13.1.1.1 30
[FW1-GigabitEthernet1/0/1]quit
[FW1]int g1/0/2
[FW1-GigabitEthernet1/0/2]ip add 11.1.1.2 30
[FW1-GigabitEthernet1/0/2]quit
[FW1]firewall zone trust 
[FW1-zone-trust]add interface g1/0/1
[FW1-zone-trust]add interface g1/0/2
[FW1-zone-trust]quit
[FW1]firewall zone dmz
[FW1-zone-dmz]add interface g1/0/0
[FW1-zone-dmz]quit
[FW1]ospf 1 router-id 11.1.1.1
[FW1-ospf-1]area 0
[FW1-ospf-1-area-0.0.0.0]network 11.1.1.2 0.0.0.0
[FW1-ospf-1-area-0.0.0.0]network 13.1.1.1 0.0.0.0
[FW1-ospf-1-area-0.0.0.0]quit
[FW1-ospf-1]quit

[FW2]int g1/0/0
[FW2-GigabitEthernet1/0/0]ip add 10.10.0.2 30
[FW2-GigabitEthernet1/0/0]quit
[FW2]int g1/0/1
[FW2-GigabitEthernet1/0/1]ip add 24.1.1.1 30
[FW2-GigabitEthernet1/0/1]quit
[FW2]int g1/0/2
[FW2-GigabitEthernet1/0/2]ip add 22.1.1.2 30
[FW2-GigabitEthernet1/0/2]quit
[FW2]firewall zone trust 
[FW2-zone-trust]add int g1/0/1
[FW2-zone-trust]add int g1/0/2
[FW2-zone-trust]quit
[FW2]firewall zone dmz
[FW2-zone-dmz]add int g1/0/0
[FW2-zone-dmz]quit
[FW2]ospf 1 router-id 22.1.1.1
[FW2-ospf-1]area 0
[FW2-ospf-1-area-0.0.0.0]network 24.1.1.1 0.0.0.0
[FW2-ospf-1-area-0.0.0.0]network 22.1.1.2 0.0.0.0
[FW2-ospf-1-area-0.0.0.0]quit
[FW2-ospf-1]quit
```

- 配置完`OSPF`记得所有的设备检查一下邻居和路由，`eve-ng`有`bug`可能需要`reset ospf process`。

------

##### 4.5.3.防火墙双机热备配置

**将两台防火墙HRP打开**

```
[FW1]hrp track interface g1/0/2		# 配置设备监控上下行业务接口
[FW1]hrp track interface g1/0/1
[FW1]hrp adjust ospf-cost enable 	
# 开启根据设备状态调整OSPF Cost值功能。开启该功能后，设备发布OSPF路由时，会判断自身是主用设备还是备用设备。如果是主用设备，设备会把学习到的路由直接发布出去；如果是备用设备，设备会增加Cost值后再将路由发布出去。这样上下行路由器在计算路由的时候，就能将下一跳指向主用设备，并把报文转发到主用设备上。
[FW1]hrp interface g1/0/0 remote 10.10.0.2	# 指定心跳口与对端地址
[FW1]hrp enable	# 开启hrp功能

[FW2]hrp track interface g1/0/1
[FW2]hrp track interface g1/0/2
[FW2]hrp adjust ospf-cost enable 
[FW2]hrp interface g1/0/0 remote 10.10.0.1
[FW2]hrp enable
```

- 一会发现，欸？没有配置`VRRP`和`VGMP`怎么指定`Active`和`Standby`设备呢？？
  - 官方文档上提供命令：`hrp device {active | standby}`用来指定设备状态。
  - 但是模拟器只能用此命令：`hrp switch {active | standby}`，不过该命令必须两端都开启`hrp`且心跳链路畅通才能使用。

```
HRP_S[FW1]hrp switch active

HRP_S[FW2]hrp switch standby
```

------

##### 4.5.4.路由表验证

至此，双机热备已经创建完成，观察路由表。因为当前`FW1`为主用设备，`FW2`为备用设备，所以观察`AR4`的路由表。

**双机热备前：**（我忘记截图了）

**双机热备后：**

```
[AR4]dis ip routing-table pro ospf
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 5        Routes : 5        

OSPF routing table status : <Active>
         Destinations : 5        Routes : 5

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       11.1.1.0/30  OSPF    10   3           D   34.1.1.1        GigabitEthernet0/0/0
       13.1.1.0/30  OSPF    10   2           D   34.1.1.1        GigabitEthernet0/0/0
       22.1.1.0/30  OSPF    10   5           D   34.1.1.1        GigabitEthernet0/0/0
  100.100.100.0/30  OSPF    10   4           D   34.1.1.1        GigabitEthernet0/0/0
   192.168.10.0/24  OSPF    10   2           D   34.1.1.1        GigabitEthernet0/0/0
```

- 可发现，当前`AR4`的所有路由下一跳都是`AR3`，这是因为`OSPF`优先级。

**关闭AR4 G0/0/0接口**

```
[AR4]interface g0/0/0
[AR4-GigabitEthernet0/0/0]shutdown 
[AR4-GigabitEthernet0/0/0]quit

[AR4]display ip routing-table protocol ospf
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 6        Routes : 6        

OSPF routing table status : <Active>
         Destinations : 6        Routes : 6

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       11.1.1.0/30  OSPF    10   65503       D   24.1.1.1        GigabitEthernet0/0/1
       13.1.1.0/30  OSPF    10   65504       D   24.1.1.1        GigabitEthernet0/0/1
       22.1.1.0/30  OSPF    10   65501       D   24.1.1.1        GigabitEthernet0/0/1
       34.1.1.0/30  OSPF    10   65505       D   24.1.1.1        GigabitEthernet0/0/1
  100.100.100.0/30  OSPF    10   65502       D   24.1.1.1        GigabitEthernet0/0/1
   192.168.10.0/24  OSPF    10   65505       D   24.1.1.1        GigabitEthernet0/0/1

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0
```

------

##### 4.5.5.故障情况

**关闭FW1端口：**

```
HRP_M[FW1]interface g1/0/2 (+B)
HRP_M[FW1-GigabitEthernet1/0/2]shutdown 
HRP_M[FW1-GigabitEthernet1/0/2]quit
```

**查看AR4路由表**

```
<AR4>display ip routing-table protocol ospf
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 4        Routes : 4        

OSPF routing table status : <Active>
         Destinations : 4        Routes : 4

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       13.1.1.0/30  OSPF    10   2           D   34.1.1.1        GigabitEthernet0/0/0
       22.1.1.0/30  OSPF    10   2           D   24.1.1.1        GigabitEthernet0/0/1
  100.100.100.0/30  OSPF    10   3           D   24.1.1.1        GigabitEthernet0/0/1
   192.168.10.0/24  OSPF    10   2           D   34.1.1.1        GigabitEthernet0/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0
```

**查看AR3路由表**

```
<AR3>display ip routing-table protocol ospf
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 5        Routes : 5        

OSPF routing table status : <Active>
         Destinations : 5        Routes : 5

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       11.1.1.0/30  OSPF    10   5           D   34.1.1.2        GigabitEthernet0/0/0
       22.1.1.0/30  OSPF    10   3           D   34.1.1.2        GigabitEthernet0/0/0
       24.1.1.0/30  OSPF    10   2           D   34.1.1.2        GigabitEthernet0/0/0
  100.100.100.0/30  OSPF    10   4           D   34.1.1.2        GigabitEthernet0/0/0
   192.168.20.0/24  OSPF    10   2           D   34.1.1.2        GigabitEthernet0/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0
```

------

#### 4.6.负载分担模式上下行连接路由器

**注意：**防火墙上下行接口放到不同的区域，这样才能看到现象！！！

![image-20250915014857178](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915014857348.png)

你现在肯定非常疑惑，在该场景中两台防火墙压根无法设置`VRRP`，那么负载均衡怎么做呢？？并且如果你自己尝试过，你会发现如果使用`hrp swtich Active`命令是没有办法让两台设备都进入`Active`的。

实际上只要在两台设备开启`hrp`，不去人为控制它们的身份，你会发现它们的优先级因为一样，所以两台防火墙都是`Active`设备。但因为设计原因，一定会有一台设备是有`HRP_M`标记的，这个前面解释过。但此时已经组成了负载分担的双机热备了，不需要其他协议（`VGMP`）参与。

来看流量问题。如果两台设备互为主备实现负载分担，那其实跟没有配置**双机热备**时的`OSPF`实现是完全一样的，所以`OSPF`此时是根据默认`Cost`来的。

我们现在就有一个概念，啥也不干，就配置个`OSPF`本身在路由层面就已经是负载分担的了，那为啥要配置双机热备呢？？又回到了最初的起点，配置双机热备的目的是防止来回路径不一致导致会话表不同步拒绝流量同行。

但是，在该场景中会话表会根据心跳线同步过去，那不就成功了么？？

------

##### 4.6.1.配置部分

两台设备输入命令：`undo hrp enable`，并删除掉`hrp switch {active | standby}`的配置。然后两台设备上再次输入命令`hrp enable`。

------

##### 4.6.2.查看hrp

```
HRP_M[FW1]display hrp state
2025-09-15 01:58:54.620 
 Role: active, peer: active
 Running priority: 45000, peer: 45000
 Backup channel usage: 0.00%
 Stable time: 0 days, 0 hours, 2 minutes
 Last state change information: 2025-09-15 1:56:26 HRP core state changed, old_state = abnormal(standby), new_state = normal, local_priority = 45000, peer_priority = 45000.
 
HRP_S[FW2]display hrp state
2025-09-15 01:59:02.810 
 Role: active, peer: active
 Running priority: 45000, peer: 45000
 Backup channel usage: 0.00%
 Stable time: 0 days, 0 hours, 2 minutes
 Last state change information: 2025-09-15 1:56:25 HRP core state changed, old_state = abnormal(active), new_state = normal, local_priority = 45000, peer_priority = 45000.
```

------

##### 4.6.3.查看下行路由器路由表

```
<AR3>display ip routing-table protocol ospf
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 5        Routes : 5        

OSPF routing table status : <Active>
         Destinations : 5        Routes : 5

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       11.1.1.0/30  OSPF    10   2           D   13.1.1.1        GigabitEthernet0/0/1
       22.1.1.0/30  OSPF    10   3           D   34.1.1.2        GigabitEthernet0/0/0
       24.1.1.0/30  OSPF    10   2           D   34.1.1.2        GigabitEthernet0/0/0
  100.100.100.0/30  OSPF    10   3           D   13.1.1.1        GigabitEthernet0/0/1
   192.168.20.0/24  OSPF    10   2           D   34.1.1.2        GigabitEthernet0/0/0
   

<AR4>display ip routing-table pro ospf
Route Flags: R - relay, D - download to fib, T - to vpn-instance
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 5        Routes : 5        

OSPF routing table status : <Active>
         Destinations : 5        Routes : 5

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       11.1.1.0/30  OSPF    10   3           D   34.1.1.1        GigabitEthernet0/0/0
       13.1.1.0/30  OSPF    10   2           D   34.1.1.1        GigabitEthernet0/0/0
       22.1.1.0/30  OSPF    10   2           D   24.1.1.1        GigabitEthernet0/0/1
  100.100.100.0/30  OSPF    10   3           D   24.1.1.1        GigabitEthernet0/0/1
   192.168.10.0/24  OSPF    10   2           D   34.1.1.1        GigabitEthernet0/0/0
```

------

##### 4.6.4.AR3上测试并查看会话表

1. 在`AR3`上执行`ping`命令：

```
<AR3>ping -a 192.168.10.254 100.100.100.1  
  PING 100.100.100.1: 56  data bytes, press CTRL_C to break
    Reply from 100.100.100.1: bytes=56 Sequence=1 ttl=254 time=3 ms
    Reply from 100.100.100.1: bytes=56 Sequence=2 ttl=254 time=2 ms
    Reply from 100.100.100.1: bytes=56 Sequence=3 ttl=254 time=2 ms
    Reply from 100.100.100.1: bytes=56 Sequence=4 ttl=254 time=1 ms
    Reply from 100.100.100.1: bytes=56 Sequence=5 ttl=254 time=3 ms

  --- 100.100.100.1 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 1/2/3 ms
```

2. 查看`FW1`会话表

![image-20250915020448970](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915020449135.png)

3. 查看`FW2`会话表

![image-20250915020517172](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915020517326.png)

------

### 5.防火墙链路高可靠性技术

#### 5.1.传统双机热备存在的不足

`VGMP`组监控的防火墙自身的接口，当自身的接口发生故障后会降低`VGMP`组的优先级，从而实现主备切换。但是对于非直连接口的故障，防火墙无法感知，不会出发主备切换，可能导致流量中端情况。

![image-20250915154757903](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915154758022.png)

如上图，当前防火墙`A`是主设备，所有的流量都经由防火墙`A`进行转发。当交换机`C`对接`Internet`的链路发生故障后，防火墙`A`对此是感知不到的。内网流量依旧会经由防火墙`A`进行转发，但是防火墙`A`因为上行链路故障无法成功将流量转发出去，最终导致流量中断。

------

#### 5.2.IP-Link探测技术

`IP-Link`探测技术是指防火墙通过向指定的目的`IP`周期性（5S默认）地发送探测报文并等待应答，来判断链路是否发生故障（默认三次收不到则为故障）。`IP-Link`可以检测到非直连链路地故障，与双机热备技术结合使用，提高网络可靠性。

![image-20250915155211895](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915155212001.png)

如上图，主用设备和备用设备都会向预先配置的`ip-link group`发起探测报文。当防火墙`A`三次收不到回复则认为探测失败，降低自身`VGMP`优先级，并切换身份。

**探测模式**

`IP-Link`技术根据探测报文的不同，可以分为以下两种探测模式：

- `ARP`探测模式仅能用于探测二层网络的连通信。
- `ICMP`探测模式适用于探测二层/三层网络的连通信。

![image-20250915155534859](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915155534975.png)

------

##### 5.2.1.实验部分（失败案例）

以该拓扑为例，`FW1`监控`AR1`的`G0/0/0`接口`202.100.100.10`，`FW2`监控`AR2`的`G0/0/0`接口`202.100.100.11`。`FW1`为主用设备，配置完`IP-Link`后观察`AR1`接口发生故障后，会不会主备切换。

![image-20250915161557931](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915161558068.png)

**ip-link策略配置部分：**

```
[FW1-policy-security]rule name ip_link
[FW1-policy-security-rule-ip_link]source-zone local
[FW1-policy-security-rule-ip_link]destination-zone untrust
[FW1-policy-security-rule-ip_link]service icmp
[FW1-policy-security-rule-ip_link]action permit

[FW2-policy-security]rule name ip_link
[FW2-policy-security-rule-ip_link]source-zone local
[FW2-policy-security-rule-ip_link]destination-zone untrust
[FW2-policy-security-rule-ip_link]service icmp
[FW2-policy-security-rule-ip_link]action permit
```

**hrp与ip-link配置部分：**

```
[FW1] hrp enable
HRP_M[FW1] ip-link check enable
HRP_M[FW1] ip-link name AR1
HRP_M[FW1-iplink-AR1] destination 202.100.100.10 interface GigabitEthernet 1/0/1
HRP_M[FW1-iplink-AR1]source-ip 202.100.100.1
HRP_M[FW1-iplink-AR1]quit
HRP_M[FW1] hrp track ip-link AR1

[FW2] hrp enable
HRP_S[FW2] ip-link check enable
HRP_S[FW2] ip-link name AR2
HRP_S[FW2-iplink-AR2] destination 202.100.100.11 interface GigabitEthernet 1/0/1
HRP_S[FW2-iplink-AR2]source-ip 202.100.100.1
HRP_S[FW2-iplink-AR2]quit
HRP_S[FW2] hrp track ip-link AR2
```

**观察现象：**

默认情况下，不指定模式就是`icmp`模式，主用设备会定期（默认`4S`）向目的地址发送`ICMP`请求报文，如果收到回应则为正常。连续三次收不到回复进入`Down`状态，减少`VGMP`优先级。同理，如果进入`down`状态，连续三次收到回复会进入`up`状态。

```
HRP_M[FW1]display ip-link
2025-09-15 16:41:13.130 
Current Total Ip-link Number : 1
Name                              Member   State   Up/Down/Init
AR1                               1        up      1  0    0 
```

![image-20250915164158229](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915164158359.png)

备用设备不会发送`ip-link`探测报文。

但是，再该拓扑中，无法做出实际变更效果。

原因是，`FW1`与`FW2`的实际`IP`地址是`10.2.0`网段的，在这里无法直接与`202.100.100`通信。即使指定了`Source-ip`能解决这个问题，但是只有主设备能够拥有`VIP`，而备用设备是没有这个`VIP`的就导致其无法探测，优先级直接减`2`。

所以，最后即使`FW1`探测失败了优先级是`44998`，而`FW2`一开始就失败了所以也是`44998`所以无法切换。

```
HRP_M[FW1]display hrp state
2025-09-15 16:53:29.070 
 Role: active, peer: standby
 Running priority: 44998, peer: 44998
 Backup channel usage: 0.00%
 Stable time: 0 days, 0 hours, 6 minutes
 Last state change information: 2025-09-15 16:47:51 HRP core state changed, old_state = abnormal(active), new_state = normal, local_priority = 44998, peer_priority = 44998.
 
HRP_S[FW2]display hrp state
2025-09-15 16:54:02.030 
 Role: standby, peer: active
 Running priority: 44998, peer: 44998
 Backup channel usage: 0.00%
 Stable time: 0 days, 0 hours, 7 minutes
 Last state change information: 2025-09-15 16:47:50 HRP core state changed, old_state = abnormal(standby), new_state = normal, local_priority = 44998, peer_priority = 44998.
```

------

##### 5.2.2.实验部分（icmp）

为了实现效果，将`FW1`与`FW2`的`G1/0/1`接口地址修改为`202.100.100.0/24`。

![image-20250915165536810](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915165536965.png)

```
[FW1]int g1/0/1
[FW1-GigabitEthernet1/0/1]undo vrrp vrid 1 virtual-ip 202.100.100.1    
[FW1-GigabitEthernet1/0/1]undo ip add
[FW1-GigabitEthernet1/0/1]ip add 202.100.100.2 24
[FW1-GigabitEthernet1/0/1]vrrp vrid 1 virtual-ip 202.100.100.1 255.255.255.0 active
[FW1-GigabitEthernet1/0/1]quit

[FW2]int g1/0/1
[FW2-GigabitEthernet1/0/1]undo vrrp vrid 1 virtual-ip 202.100.100.1 
[FW2-GigabitEthernet1/0/1]ip add 202.100.100.3 24
[FW2-GigabitEthernet1/0/1]vrrp vrid 1 virtual-ip 202.100.100.1 255.255.255.0 standby
[FW2-GigabitEthernet1/0/1]quit
```

**hrp与ip-link**

```
[FW1] hrp enable
HRP_M[FW1] ip-link check enable
HRP_M[FW1] ip-link name AR1
HRP_M[FW1-iplink-AR1] destination 202.100.100.10 interface GigabitEthernet 1/0/1
HRP_M[FW1-iplink-AR1]quit
HRP_M[FW1] hrp track ip-link AR1

[FW2] hrp enable
HRP_S[FW2] ip-link check enable
HRP_S[FW2] ip-link name AR2
HRP_S[FW2-iplink-AR2] destination 202.100.100.11 interface GigabitEthernet 1/0/1
HRP_S[FW2-iplink-AR2]source-ip 202.100.100.1
HRP_S[FW2-iplink-AR2]quit
HRP_S[FW2] hrp track ip-link AR2
```

**观察：**

此时抓包会发现`FW1`和`FW2`都会向目的地址发送`icmp`请求报文进行探测：

```
HRP_M[FW1]display ip-link
2025-09-15 17:06:21.090 
Current Total Ip-link Number : 1
Name                              Member   State   Up/Down/Init
AR1                               1        up      1  0    0 

HRP_S[FW2]display ip-link      
2025-09-15 17:05:39.620 
Current Total Ip-link Number : 1
Name                              Member   State   Up/Down/Init
AR2                               1        up      1  0    0
```

**模拟故障：**

在`AR1`上关闭`G0/0/0`接口：

```
[AR1]interface g0/0/0
[AR1-GigabitEthernet0/0/0]shutdown
```

![image-20250915170740889](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915170741043.png)

- 经过三次失败后立刻进行切换

![image-20250915170814885](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915170815020.png)

------

##### 5.2.3.实验部分（arp）

**配置部分：**

```
HRP_M[FW1]ip-link name AR1
HRP_M[FW1-iplink-AR1]undo destination 202.100.100.10 interface GigabitEthernet1/0/1 mode icmp
HRP_M[FW1-iplink-AR1]destination 202.100.100.10 interface g1/0/1 mode arp

HRP_S[FW2]ip-link name AR2
HRP_S[FW2-iplink-AR2]undo destination 202.100.100.11 interface GigabitEthernet1/0/1 mode icmp
HRP_S[FW2-iplink-AR2]destination 202.100.100.11 interface GigabitEthernet1/0/1 mode arp 
HRP_S[FW2-iplink-AR2]quit
```

**抓包：**

![image-20250915171604298](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915171604429.png)

**查看ip-link**

![image-20250915171701614](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915171701750.png)

![image-20250915171711984](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915171712116.png)

**关闭AR1接口**

![image-20250915171815522](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915171817252.png)

三次失败后，进行回切：

![image-20250915171828075](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915171828207.png)

![image-20250915171841825](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250915171841959.png)

------

### 6.BFD

#### 6.1.概述

`BFD(Bidirectional Forwarding Detection)`双向转发检测是一种高速故障检测机制。两端建立`BFD`会话后，在它们之间的通道上周期性的发送`BFD`报文，如果一方在协商的检测时间内没有接收到`BFD`报文，则认为这条双向通道上发生了故障。上层协议通过`BFD`感知到链路故障后可以及时采取措施，进行故障恢复。

![image-20250922002237145](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922002237265.png)

------

##### 6.1.1.为什么需要BFD？

通常**动态协议**会依靠自身的`Hello`报文机制来进行故障检测。这些协议的检测时间通常在秒级，当数据传输速率达到`GB`级别时，秒级检测时间内，大量数据将会丢失。

在三层网络协议中，`Hello`报文检测机制无法针对所有路由来检测故障，如静态路由。

------

##### 6.1.2.BFD的优点

`BFD`协议就是在这种背景下产生的，`BFD`提供了一个通用的标准化的介质无关和协议无关的快速故障检测机制，它具有以下优点：

- 提供轻负荷、短周期的故障检测，故障检测时间可达到毫秒级，可靠性更高。
- 支持多种故障检测，如接口故障、数据链路故障、转发引擎本身故障等。
- 不依赖硬件，能够对任何介质、任何协议层进行实时检测。

------

#### 6.2.BFD的典型应用场景

通常，`BFD`不能独立运行，而是作为辅助与接口状态或与路由协议（如静态路由、`OSPF`、`IS-IS`、`BGP`等）联动使用，此处介绍两种典型应用。

##### 6.2.1.BFD与接口状态联动

`BFD`与接口状态联动提供一种简单的机制，使得`BFD`检测行为可以关联接口状态，提高了接口感应链路故障的灵敏度，减少了非直连链路故障导致的问题。`BFD`检测到链路故障会立即上报`Down`消息到相应接口，使接口进入一种特殊的`Down`状态：`BFD Down`状态。该状态等效于链路协议`Down`状态，在该状态下只有`BFD`的报文可以正常处理，从而使接口也可以快速感知链路故障。

![BFD与接口状态联动](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922000820640.png)

如上图，`SwitchA`和`SwitchB`链路之间存在其他二层设备，一旦链路故障，两端设备的接口状态依旧是`UP`。如果运行了上层协议（如`ospf`）需要一段时间才能感知到。

此时，可在两端上配置`BFD`会话，配置接口联动后，当`BFD`检测到链路出现故障后，立即上报`Down`消息到相应接口，使接口进入`BFD Down`状态。

------

##### 6.2.2.BFD与OSPF联动

链路故障或拓扑变化都会导致`OSPF`重新计算路由，为了提高网络可用性，需要缩短路由协议的收敛时间。由于链路故障无法完全避免，所以加快故障感知速度并将故障快速通告给路由协议是一种可行方案。

![OSPF协议收敛速度](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922001409833.png)

如下图，`SwitchA`分别与`SwitchC`和`SwitchD`建立`OSPF`邻居关系，`SwitchA`到`SwitchB`的路由出接口为`Interface 1`，经过`SwitchC`到`达SwitchB`。邻居状态到达`FULL`状态时通知`BFD`建立`BFD`会话。

当`SwitchA`和`SwitchC`之间链路出现故障，BFD首先感知到并通知`SwitchA`。`SwitchA`处理邻居`Down`事件，重新计算路由，新的路由出接口为`Interface 2`，经过`SwitchD`到达`SwitchB`。

![BFD与OSPF联动](https://download.huawei.com/mdl/image/download?uuid=939d50ffee90411b855fd238da4f9964)

------

**总结：**

通过上述两个例子我们可以理解`BFD`简单来讲有两个显著的作用：

- 感知非直连链路的状态（`up/down`）

- 加快上层协议对故障的感知速度（收敛）

------

#### 6.3.BFD工作详解

`BFD`的检测机制是两个系统建立`BFD`会话，并沿它们之间的路径周期性发送`BFD`报文，如果一方在既定的时间内没有收到`BFD`报文，`BFD`会话状态变为`Down`，则认为路径上发生了故障。

##### 6.3.1.BFD报文结构

**端口号：**

**单跳检测：**

- 用于直接相连的两台设备之间。
  - 传输层协议：UDP
    - 目的端口号 (Destination Port)：3784
  
    ![image-20250922155847801](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922155847940.png)

**多跳检测：**

- 用于检测非直连的、跨越多个路由器的路径。
  - 传输层协议：UDP
    - 目的端口号：4784

**回声报文：**

- 用于BFD Echo功能，实现快速检测。
  - 传输层协议：通常也是 **UDP**（更为常见）
    - 目的端口号：3785

- 另一种封装：直接封装在IP层（原始IP）

通过命令`multi-hop destination-port`可修改。

****

`BFD`控制报文根据场景不同封装不同，报文结构由强制部分和可选的认证字段组成。

**强制部分：**

![image-20250922002525668](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922002525798.png)

| 字段名 (Field Name)               | 比特位 (Bits) | 说明 (Description)                                           |
| :-------------------------------- | :------------ | :----------------------------------------------------------- |
| **Vers**                          | 0-3           | **版本**。标识 BFD 版本，目前为 `3`。                        |
| **Diag**                          | 4-7           | **诊断码**。指示会话断开的原因。例如：`0`：控制检测超时；`1`：回声功能超时等。 |
| **Sta**                           | 8-10          | **状态**。当前 BFD 会话状态： `0`：AdminDown (管理关闭)  `1`：Down (断开)  `2`：Init (初始化)  `3`：Up (正常) |
| **P**                             | 11            | **Poll**。置 `1`表示发送方请求确认或改变参数，接收方必须用 `F`位回应。 |
| **F**                             | 12            | **Final**。置 `1`表示是对带有 `P`位的报文的响应。            |
| **C**                             | 13            | **Control Plane Independent**。置 `1`表示本机 BFD 实现不依赖控制平面（即硬件实现，检测更快）。 |
| **A**                             | 14            | **Authentication Present**。置 `1`表示报文包含认证部分。     |
| **D**                             | 15            | **Demand**。置 `1`表示希望运行在“按需”模式（一种优化模式，不常用）。 |
| **R**                             | 16            | **Reserved**。保留位，必须设为 `0`。                         |
| **Detect Mult**                   | 8             | **检测倍数**。用于计算检测超时时间。`超时时间 = Detect Mult × 协商的RX间隔`。 |
| **Length**                        | 8             | **报文总长度**（以字节为单位）。标准 BFD 控制报文是 `24`字节，如果带认证会更长。 |
| **My Discriminator**              | 32            | **我的鉴别符**。由发送方生成的一个**唯一、非零**的随机数，用于标识本端的 BFD 会话。 |
| **Your Discriminator**            | 32            | **对端鉴别符**。从对端收到的 `My Discriminator`值。在会话未建立 (`Down`) 时，此字段为 `0`。 |
| **Desired Min TX Interval**       | 32            | **期望的最小发送间隔**。发送方期望发送 BFD 报文的最小间隔（微秒）。 |
| **Required Min RX Interval**      | 32            | **要求的最小接收间隔**。接收方能够接收 BFD 报文的最小间隔（微秒）。 |
| **Required Min Echo RX Interval** | 32            | **要求的最小回声接收间隔**。接收方能够接收 BFD 回声报文的最小间隔（微秒）。未实现回声功能时设为 `0`。 |

**可选部分：**

![image-20250922002539669](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922002539784.png)

------

##### 6.3.2.BFD会话建立

`BFD`会话的建立有两种方式，即静态建立`BFD`会话和动态建立`BFD`会话。`BFD`通过控制报文中的本地标识符和远端标识符区分不同的会话。静态和动态创建`BFD`会话的主要区别在于`Local Discriminator`和`Remote Discriminator`的配置方式不同。

**静态建立BFD会话：**

静态建立`BFD`会话是指通过命令行手工配置`BFD`会话参数，包括配置本地标识符和远端标识符等，然后手工下发`BFD`会话建立请求。

![image-20250922003218300](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922003218423.png)

------

**动态建立BFD会话：**

动态`BFD`是指**上层路由协议（如OSPF、BGP、IS-IS）能够自动发现、创建并绑定BFD会话**。

**工作原理：**

1. **协议联动**：在路由器上同时开启BFD功能和某个路由协议（如OSPF）的BFD检测功能。
2. **自动建立**：当路由协议（如OSPF）建立起邻居关系（Neighbor）后，它会**自动**通知本地的BFD进程：“我有了一个邻居，它的IP是X.X.X.X，请为它创建一个BFD会话。”
3. **自动绑定**：BFD会话建立后，路由协议会**自动**将这条邻居链路的状态与BFD会话的状态绑定。
4. **自动检测**：一旦BFD检测到链路故障，会**立即通知**绑定的路由协议。路由协议随之快速将邻居关系断开，并撤销从该邻居学到的路由。

**标识符协商过程：**

1. **唯一性**：每个设备独立生成自己的 `My Discriminator`（通常是一个随机数），只需保证在本机唯一即可。
2. **匹配验证**：会话建立的关键在于收到一个 `Your Discriminator`与自身 `My Discriminator`相匹配的报文。这就像对暗号，暗号对上了，就确认了彼此的身份。
3. **状态驱动**：整个协商由状态机（`Down`-> `Init`-> `Up`）驱动，而状态的变迁又依赖于 `Discriminator`的匹配验证。

![image-20250922003627934](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922003628054.png)

------

##### 6.3.3.BFD会话状态

BFD会话有四种状态：`Down`、`Init`、`Up`和`AdminDown`。

| 状态            | 名称         | 描述                                           |
| :-------------- | :----------- | :--------------------------------------------- |
| **`Down`**      | **断开**     | 会话的初始状态或表示检测到故障。               |
| **`Init`**      | **初始化**   | 表示本端希望建立会话，并已收到对端的一个报文。 |
| **`Up`**        | **正常**     | 会话已成功建立，双向通信正常。                 |
| **`AdminDown`** | **管理关闭** | 由管理员手动关闭会话，并非链路故障。           |

会话状态变化通过`BFD`报文的`State`字段传递，系统根据自己本地的会话状态和接收到的对端`BFD`报文驱动状态改变，如下图所示。`BFD`状态机的建立和拆除都采用三次握手机制，以确保两端系统都知道状态的变化。

![image-20250922003858800](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922003858921.png)

**第一步：down**

1. **Router A** 和 **Router B** 的 BFD 会话状态均为 `Down`。

2. A 开始向 B 发送 BFD 控制报文：

   - `State = Down`

   - `My Discriminator = 100`(A生成的随机数)

   - `Your Discriminator = 0`(因为A还不知道B的标识符)

**第二步：down --> init**

1. **Router B** 收到来自 A 的报文。

   - 检查报文：状态为 `Down`, `Your Discriminator = 0`。

   - 根据规则，B 知道 A 想要建立会话。B 将本地状态变为 `Init`。

2. B 开始向 A 回复报文：

   - `State = Init`

   - `My Discriminator = 200`(B生成的随机数)

   - `Your Discriminator = 100`(B将A的标识符填进去，表示“我认识你A了”)

**第三步：down --> up**

1. **Router A** 收到来自 B 的报文。

   - **关键检查**：报文中 `Your Discriminator = 100`，这与 A 自己的 `My Discriminator (100)`**匹配**

   - 并且报文状态是 `Init`。

   - 根据规则，A 将本地状态变为 `Up`。

2. A 向 B 发送报文：

   - `State = Up`

   - `My Discriminator = 100`

   - `Your Discriminator = 200`(A将B的标识符填进去)

**第四步：init --> up**

- **Router B** 收到来自 A 的报文。

  - **关键检查**：报文中 `Your Discriminator = 200`，这与 B 自己的 `My Discriminator (200)`**匹配**

  - 并且报文状态是 `Up`。

  - B 将本地状态变为 `Up`。

------

##### 6.3.4.BFD检测模式

`BFD`的检测模式分为两种：异步模式和查询模式。**BFD是双向检测**。

**异步模式：**

1. **双向心跳**：通信双方（Router A和Router B）都会**周期性地**向对端发送BFD控制报文。
2. **检测机制**：每一方都**独立地**监视是否能在规定时间内收到对端发来的BFD控制报文。
   - 如果收到，就认为路径是通的。
   - 如果在**检测时间（Detection Time）** 内没有收到，就宣告会话`Down`。

![image-20250922004740572](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922004740709.png)

**回声模式（很少用）：**

与异步模式不同，**查询模式**并非用于持续的链路监控，而是用于**按需验证**连接性的场景。当系统需要主动确认某条路径是否畅通时，它会主动发起一次查询过程：连续向对端发送一系列（通常是多个）`BFD`控制报文，并期待收到对端的回应。

在此模式下，发送查询的一方会启动一个计时器。如果在检测时间内没有收到应有的回复报文，它就宣布会话`Down`。这种模式更像是传统网络中的“心跳请求”或“ Ping ”机制的精确定时版，但其协议格式和会话状态机仍然是`BFD`的标准。它适用于那些不需要长期、持续发送检测报文，仅在特定事件触发时才需要验证连通性的场合，有助于节省网络带宽和系统资源。

![image-20250922005531174](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922005531307.png)

------

##### 6.3.5.BFD检测时间

`BFD`会话检测时长由`TX（Desired Min TX Interval）`期望最小发送间隔，`RX（Required Min RX Interval）`要求最小接收间隔，`DM（Detect Multi）`检测倍数，三个参数决定。`BFD`报文的实际发送时间间隔，实际接受时间间隔由`BFD`会话协商决定。

| 缩写   | 英文全称                     | 中文含义             | 作用                                      |
| :----- | :--------------------------- | :------------------- | :---------------------------------------- |
| **DX** | **Desired Min TX Interval**  | **期望最小发送间隔** | 本端**希望**发送 BFD 报文的频率。         |
| **RX** | **Required Min RX Interval** | **要求最小接收间隔** | 本端**能够处理**接收 BFD 报文的最高频率。 |
| **DM** | **Detect Multiplier**        | **检测倍数**         | 允许连续丢失多少个报文后宣告故障。        |

**实际发送时间间隔：**

本地BFD报文实际发送时间间隔＝MAX { 本地配置的发送时间间隔，对端配置的接收时间间隔 }

**实际接收时间间隔：**

本地BFD报文实际接收时间间隔＝MAX { 对端配置的发送时间间隔，本地配置的接收时间间隔 }

**本地检测时间间隔：**

- 异步模式：本地BFD报文实际检测时间＝本地BFD报文实际接收时间间隔×对端配置的BFD检测倍数
- 查询模式：本地BFD报文实际检测时间 = 本地BFD报文实际接收时间间隔×本端配置的BFD检测倍数

![image-20250922010010579](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922010010720.png)

------

##### 6.3.6.BFD Echo功能

`BFD Echo`也称为`BFD`单臂回声功能，是一种**自我检测**机制。适用于一端支持`BFD`另一端不支持`BFD`的场景中。

**工作原理：**

1. **主动端发送**：由一端（主动端）周期性地发送一种特殊的 **BFD Echo 报文**。
2. **对端环回**：对端（被动端）在**数据平面（硬件层面）** 收到此报文后，**不将其上送到控制平面（CPU）处理**，而是直接将其**原路环回（Loopback）** 给发送方。
3. **自我判断**：发送端通过计算发出`Echo`报文和收到环回报文之间的时间差，来判断链路的延迟和连通性。

![image-20250922010520575](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922010520712.png)

------

#### 6.4.实操

##### 6.4.1.静态路由与BFD联动配置

![image-20250922155242781](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922155242914.png)

如上图，`AR1`与`AR2`三层直连，但物理链路被交换机相隔。在`AR1`配置目的地址为`2.2.2.2/32`的静态路由，在`AR2`配置目的地址为`1.1.1.1/32`的静态路由。

为了实现故障快速检测和路径快速收敛，在`AR1`和`AR2`之间建立`BFD`会话并与静态路由绑定。

**基础配置：**

```
[AR1]ip route-static 2.2.2.2 32 12.1.1.2

[AR2]ip route-static 1.1.1.1 32 12.1.1.1
```

**测试：**

```
[AR1]ping -a 1.1.1.1 2.2.2.2
  PING 2.2.2.2: 56  data bytes, press CTRL_C to break
    Reply from 2.2.2.2: bytes=56 Sequence=1 ttl=255 time=190 ms
    Reply from 2.2.2.2: bytes=56 Sequence=2 ttl=255 time=60 ms
    Reply from 2.2.2.2: bytes=56 Sequence=3 ttl=255 time=30 ms
    Reply from 2.2.2.2: bytes=56 Sequence=4 ttl=255 time=30 ms
    Reply from 2.2.2.2: bytes=56 Sequence=5 ttl=255 time=60 ms

  --- 2.2.2.2 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 30/74/190 ms
```

**配置BFD之前的故障测试：**

手工关闭交换机的`Ethernet0/0/2`接口，观察`AR1`上的静态路由是否会消失：

```
[Huawei]interface Ethernet 0/0/2	
[Huawei-Ethernet0/0/2]shutdown 
[Huawei-Ethernet0/0/2]quit
```

![image-20250922155537121](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922155537272.png)

------

**两端配置BFD：**

- `AR1`的`BFD`配置：

  ```
  [AR1]bfd
  [AR1-bfd]quit	
  [AR1]bfd 1 bind peer-ip 12.1.1.2 interface g0/0/0
  [AR1-bfd-session-1]discriminator local 10
  [AR1-bfd-session-1]discriminator remote 20
  [AR1-bfd-session-1]commit
  [AR1-bfd-session-1]quit
  ```

- `AR2`的`BFD`配置：

  ```
  [AR2]bfd
  [AR2-bfd]quit
  [AR2]bfd 1 bind peer 12.1.1.1 interface g0/0/0
  [AR2-bfd-session-1]discriminator local 20
  [AR2-bfd-session-1]discriminator remote 10
  [AR2-bfd-session-1]commit
  [AR2-bfd-session-1]quit
  ```

**查看BFD状态：**

需要在两端都配置完`BFD`会话后才会进入`UP`状态：

![image-20250922160115996](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922160116154.png)

![image-20250922160747360](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922160747520.png)

------

**在AR1将BFD与静态路由绑定：**

```
[AR1]undo ip route-static 2.2.2.2 32 12.1.1.2
[AR1]ip route-static 2.2.2.2 32 12.1.1.2 track bfd-session 1
```

**测试现象：**

关闭交换机的`Ethernet0/0/2`接口观察静态路由还是否存在：

```
[Huawei]interface Ethernet0/0/2
[Huawei-Ethernet0/0/2]shutdown 
[Huawei-Ethernet0/0/2]quit
```

![image-20250922160549405](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922160549561.png)

![image-20250922160600456](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922160600598.png)

------

**在AR2将BFD与静态路由绑定：**

```
[AR2]undo ip route-static 1.1.1.1 32 12.1.1.1
[AR2]ip route-static 1.1.1.1 32 12.1.1.1 track bfd-session 1
```

**测试现象：**

关闭交换机的`Ethernet0/0/1`接口观察静态路由还是否存在：

```
[Huawei]interface Ethernet0/0/1
[Huawei-Ethernet0/0/1]shutdown 
[Huawei-Ethernet0/0/1]quit
```

![image-20250922161226120](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922161226265.png)

![image-20250922161250043](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922161250193.png)

------

##### 6.4.2.OSPF与BFD联动配置

![image-20250922162234512](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922162234662.png)

如上图，`AR1`与`AR2`三层直连，但物理链路被交换机相隔。在`AR1`和`AR2`上配置`OSPF`传递`1.1.1.1`和`2.2.2.2`。

**基础配置：**

```
[AR1]ospf 1 router-id 1.1.1.1
[AR1-ospf-1]area 0
[AR1-ospf-1-area-0.0.0.0]network 12.1.1.1 0.0.0.0
[AR1-ospf-1-area-0.0.0.0]network 1.1.1.1 0.0.0.0
[AR1-ospf-1-area-0.0.0.0]quit
[AR1-ospf-1]quit

[AR2]ospf 1 router-id 2.2.2.2
[AR2-ospf-1]area 0
[AR2-ospf-1-area-0.0.0.0]network 12.1.1.2 0.0.0.0
[AR2-ospf-1-area-0.0.0.0]network 2.2.2.2 0.0.0.0
[AR2-ospf-1-area-0.0.0.0]quit
[AR2-ospf-1]quit
```

**测试：**

```
[AR1]ping -a 1.1.1.1 2.2.2.2
  PING 2.2.2.2: 56  data bytes, press CTRL_C to break
    Reply from 2.2.2.2: bytes=56 Sequence=1 ttl=255 time=50 ms
    Reply from 2.2.2.2: bytes=56 Sequence=2 ttl=255 time=30 ms
    Reply from 2.2.2.2: bytes=56 Sequence=3 ttl=255 time=40 ms
    Reply from 2.2.2.2: bytes=56 Sequence=4 ttl=255 time=50 ms
    Reply from 2.2.2.2: bytes=56 Sequence=5 ttl=255 time=50 ms

  --- 2.2.2.2 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 30/44/50 ms
```

![image-20250922162449811](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922162449972.png)

------

**BFD配置：**

```
[AR1]ospf 1 
[AR1-ospf-1]bfd all-interfaces enable
[AR1-ospf-1]bfd all-interfaces min-rx-interval 100 min-tx-interval 100 detect-mu
ltiplier 3
[AR1-ospf-1]quit

[AR2]ospf 1 
[AR2-ospf-1]bfd all-interfaces enable
[AR2-ospf-1]bfd all-interfaces min-rx-interval 100 min-tx-interval 100 detect-mu
ltiplier 3
[AR2-ospf-1]quit
```

**现象查看：**

![image-20250922162814762](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922162814910.png)

![image-20250922162834340](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922162834491.png)

------

##### 6.4.3.双机热备与BFD联动配置

![image-20250915183638331](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250922163422255.png)

**配置部分：**

```
HRP_M[FW1]bfd
HRP_M[FW1]bfd 1 bind peer-ip 202.100.100.10 
HRP_M[FW1-bfd-session-1]discriminator local 10
HRP_M[FW1-bfd-session-1]discriminator remote 20
HRP_M[FW1-bfd-session-1]quit
HRP_M[FW1]hrp track bfd-session 10

HRP_S[FW2]bfd
HRP_S[FW2]bfd 1 bind peer-ip 202.100.100.11
HRP_S[FW2-bfd-session-1]discriminator local 10
HRP_S[FW2-bfd-session-1]discriminator remote 20
HRP_S[FW2-bfd-session-1]commit
HRP_S[FW2-bfd-session-1]quit
HRP_S[FW2]hrp track bfd-session 10

[AR1]bfd 
[AR1-bfd]quit
[AR1]bfd 1 bind peer-ip 202.100.100.2
[AR1-bfd-session-1]discriminator local 20
[AR1-bfd-session-1]discriminator remote 10
[AR1-bfd-session-1]commit 

[AR2]bfd
[AR2-bfd]bfd 1 bind peer-ip 202.100.100.3
[AR2-bfd-session-1]discriminator local 20
[AR2-bfd-session-1]discriminator remote 10
[AR2-bfd-session-1]commit
```

**查看bfd**

```
HRP_M[FW1]display bfd session all
2025-09-15 17:29:48.890 
--------------------------------------------------------------------------------
Local Remote     PeerIpAddr      State     Type         InterfaceName           
--------------------------------------------------------------------------------
10    20         202.100.100.10  Up        S_IP_PEER          -                 
--------------------------------------------------------------------------------
     Total UP/DOWN Session Number : 1/0
```

对于`bfd`方式来说，故障探测的速度是非常快的，一个`bfd`会话失败后立刻就会进行切换。

------

