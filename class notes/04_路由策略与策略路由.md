# 04_路由策略与策略路由

### 1.路由策略

路由策略（`Routing Policy`）是一套用于对路由信息进行过滤、属性设置等操作的方法，通过对路由的控制，可以影响数据流量转发操作。

实际上**路由策略**并非单一的技术或者协议，而是一个技术专题或方法论，里面包含着多种工具及方法。

![image-20250822121623632](https://gitee.com/chouhama/pic/raw/master/20250822121630738.png)

如上图，网络中存在`OSPF`和`IS-IS`两种路由协议，默认情况下这两种路由协议的路由信息不会彼此交互，需要在`R3`进行**双向引入**。但是，引入完成后`IS-IS`中就拥有`OSPF`的所有路由了，可处于各种情况考虑，我只希望**业务B**被引入到`IS-IS`怎么办呢？

- 在`R3`将`OSPF`路由引入到`IS-IS`时，使用**路由策略**进行过滤，只将业务`B`的路由信息引入到`IS-IS`。

------

**作用**

1. **控制路由的发布：**通过路由策略对发布的路由进行过滤，只发布满足条件的路由。
2. **控制路由的接收：**通过路由策略对接收的路由进行过滤，只接收满足条件的路由。
3. **控制路由的引入**：通过路由策略控制从其他路由协议引入的路由条目，只有满足条件的路由才会被引入。
4. **控制路由的属性**：针对不同的路由设置不同的路由属性（例如度量值、路由的优先级或路由的标记等）。

![image-20250822123305007](https://gitee.com/chouhama/pic/raw/master/20250822123305071.png)

------

#### 1.1.路由匹配工具

无论现在你需要路由策略帮助你完成何种目的，都有一个前提，需要匹配一个或多个网段。路由匹配工具就是用来实现该功能的，并且它比你想象的要强大。

------

##### 1.1.1.访问控制列表

访问控制列表（`Access control List,ACL`）是一个匹配工具，能够对报文及路由进行匹配和区分。

`ACL`由若干条`permit`或`deny`语句组成。每条语句就是该`ACL`的一条**规则**，每条语句中的`permit`或`deny`就是与这条规则相对应的处理动作。

![image-20250822141050114](https://gitee.com/chouhama/pic/raw/master/20250822141050173.png)

`ACL`最初是为过滤数据包设计的，但也可以用来匹配路由。**当它被用作匹配路由时，它检查的是路由条目本身的目的==网络地址==，而不是数据包的`IP`头。**

------

**通配符**

在`ACL`中采用**通配符**的方式匹配网段掩码。

- 通配符是一个`32`位比特的数值，用于指示`IP`地址中哪些比特位需要严格匹配，哪些比特位无需匹配。
- 通配符通常采用类似网络掩码的点分十进制形式表示，但是含义却与网络掩码完全不同。

例如：

```
acl number 2000
rule 5 deny source 10.1.1.1 0
rule 10 deny source 10.1.1.2 0
rule 15 deny permit 10.1.1.0 0.0.0.255
```

- **匹配规则**：`0`表示匹配，`1`表示无需匹配。

![image-20250822153843088](https://gitee.com/chouhama/pic/raw/master/20250822153843147.png)

------

**ACL的分类**

![image-20250822154034839](https://gitee.com/chouhama/pic/raw/master/20250822154034896.png)

**匹配规则**

![image-20250822154516713](https://gitee.com/chouhama/pic/raw/master/20250822154516772.png)

------

##### 1.1.2.IP前缀列表 ip-prefix

`ACL`并不适合所有的场景，因为`ACL`在匹配时检查路由的网络地址，而不是**掩码**。如下：

![image-20250822155039451](https://gitee.com/chouhama/pic/raw/master/20250822155039535.png)

`R3`与`R1`和`R2`建立了`IS-IS`邻居关系，与`R4`建立了`OSPF`邻居关系。现在需要将`IS-IS`路由重分发到`OSPF`中，并且在重分发时需要过滤掉`172.16.0.0/16`这一条路由，保留其他的路由。

**过滤之前：**

![image-20250822160139817](https://gitee.com/chouhama/pic/raw/master/20250822160139904.png)

**如果用`ACL`正确做法应该这么做：**

```
acl 2000
	rule deny source 172.16.0.0 0.0.0.0
	rule permit
	quit
route-policy hcip permit node 10
	if-match acl 2000
	quit
ospf 1
	import-route isis route-policy hcip
```

此时的现象是`R4`的路由表中`172.16.0.0/16`和`172.16.0.0/24`这两条路由都被过滤掉了。

![image-20250822160254196](https://gitee.com/chouhama/pic/raw/master/20250822160254272.png)

**大多数同学的做法应该和下面一样：**

```
acl 2000
	rule deny source 172.16.0.0 0.0.255.255
	rule permit
	quit
route-policy hcip permit node 10
	if-match acl 2000
	quit
ospf 1
	import-route isis route-policy hcip
```

此时的现象是不会有任何一条`172.16`开头的路由了。

![image-20250822160505000](https://gitee.com/chouhama/pic/raw/master/20250822160505087.png)

------

先分析一下这两种不同的做法，一定要清楚的是`ACL`匹配的是**目的路由的网络地址**，这是一个**地址**，而不是掩码。所以，当你写`172.16.0.0 0.0.0.0`时，他会匹配所有路由中地址开头为`172.16.0.0`的，当你写`172.16.0.0 0.0.0.255`，它会匹配所有`172.16.0`开头的，当你写`172.16.0.0 0.0.255.255`它会匹配所有`172.16`开头的。

**那从上面的分析大家也能看出来，对于`ACL`来说它并不灵活，无法提供地址加掩码的方式进行匹配。**只适用于一些较为简单的路由环境中使用，当面对更复杂的场景时，需要考虑另一个工具，`IP Prefix List`

------

一个路由条目由**目的网络地址**（`IP`前缀）和**掩码长度**（前缀长度）共同标识。`IP`前缀列表在匹配路由时，能够同时指定**目的网络地址**和**掩码**，从而实现对路由的精确匹配。

现在，我们可以使用`IP`前缀列表实现刚刚的例子：

![image-20250822155039451](https://gitee.com/chouhama/pic/raw/master/20250822163532440.png)

```
ip ip-prefix test deny 172.16.0.0 16
ip ip-prefix test permit 0.0.0.0 0 less-equal 32
route-policy hcip permit node 10
	if-match ip-prefix test
	quit
ospf 1
	import-route isis route-policy hcip
```

![image-20250822164020560](https://gitee.com/chouhama/pic/raw/master/20250822164020659.png)

------

**结构**

一条IP-Prefix List规则由三部分组成：

1. **索引号 (index)**： 决定规则的匹配顺序，从小到大的顺序匹配。
2. **匹配模式 (permit/deny)**： 定义匹配后的动作是“允许”还是“拒绝”。
3. **匹配条件 (网络号/掩码长度 + 范围参数)**： 定义匹配的具体内容

```
ip ip-prefix [列表名称] index [序号] [permit | deny] [网络号]/[掩码长度] [匹配掩码范围参数]
```

------

**关键参数：**

这是`IP-Prefix List`的灵魂所在，它们用于定义一个**掩码长度的匹配范围**。

- `greater-equal <ge-value>`： 掩码长度 **大于等于**`ge-value`
- `less-equal <le-value>`： 掩码长度 **小于等于** `le-value`

现在我们要分为以下几种情况来判断匹配路由时的掩码长度：

1. 如果只写了**掩码长度**，没有写`ge`和`le`，则标识精确匹配该掩码长度。

```
ip ip-prefix test deny 172.16.0.0 16
```

2. 如果写了`ge`，没写`le`，则`le`值默认为`32`
   - 如下，此时这条规则的含义是匹配前`16`位为`172.16.`并且掩码大于等于`24`，小于等于`32`的路由。

```
ip ip-prefix test deny 172.16.0.0 16 gre 24
```

![image-20250822165752232](https://gitee.com/chouhama/pic/raw/master/20250822165752322.png)

3. 如果写了`le`，没写`ge`，则`ge`值默认为**掩码长度**参数的值。
   - 如下，这条规则的含义是匹配`172.16`且掩码范围为`16-32`。

```
ip ip-prefix test deny 172.16.0.0 16 le 32
```

4. 如果同时写了`ge、le`（`ge`必须小于等于`le`）
   - 如下，这条规则的含义是匹配`172.16`且掩码范围为`24-30`

```
ip ip-prefix test deny 172.16.0.0 16 gre 24 le 32
```

------

**测试：**

为什么在最初的例子中，我放通路由要写`0.0.0.0 0 le 32`，只写`0.0.0.0 0`为什么不行？？

------

#### 1.2.策略工具

##### 1.2.1.Route-Policy

`Route-Policy`是一个策略工具，用于过滤路由信息，以及为过滤后的路由信息设置路由属性。`Route-Policy`是拥有一个或多个节点（`Node`）的列表，每一个节点都可以是一系列条件语句及执行语句的集合。这些节点（`Node`）按照编号从小到达的顺序排列。

在每个节点（`Node`）中，用户可以定义条件语句及执行语句，类似于`If-Then`（如果-则）。节点内的多个条件语句之间的关系为**与**，即匹配所有条件语句才会执行本节点内的动作。

在`Route-Policy`中节点之间的关系为**或**，在执行`Route-Policy`时，自上而下从编号最小的节点开始进行匹配，如果被匹配的对象满足所有条件，则执行该节点中的执行语句（动作），并且不会再向下进行匹配。如果第一个节点在匹配时，有任何一个条件不满足，则向下继续匹配，以此类推。

![image-20250823151537899](https://gitee.com/chouhama/pic/raw/master/20250823151545031.png)

------

如下图，该`Route-Policy`的名称为`hcnp`，一共有三个节点，序号分别是`5、10、15`。默认情况的排序方式就是这样，每个序号之间预留了`4`个数，这么做的目的是为了考虑扩展性。每个节点中都由**条件语句**`if-match`和**执行语句**`apply`组成。

当该`Route-Policy`被调用且开始执行时，路由匹配的操作将从序号最小的节点`node5`开始，只有满足了`Node5`中所有的**条件语句**`if-match`后，才会执行`apply`的动作。如果`node5`的任何一个条件没有被满足，则向下继续匹配。

![image-20250823151616870](https://gitee.com/chouhama/pic/raw/master/20250823151616962.png)

------

**创建一个Route-Policy节点**

`route-policy-name`可以根据自己的需要进行自定义。

```
route-policy <route-policy-name> {permit|deny} node <node>
```

- `Permit`：指定该节点的匹配模式为允许。
- `Deny`：指定节点的匹配模式为拒绝。

`Route-Policy`的末尾隐含着一个类似拒绝所有的节点。如果你指定的所有节点都没被匹配上，那么就会被拒绝。

------

**if-match（可选）**

在`Route-Policy`的节点视图下，使用`if-match`命令可定义匹配条件，所匹配的对象是路由信息的一些属性，例如路由的目的网络地址或掩码长度、度量值、标记（`Tag`）或下一跳地址等。以下是常用的`if-match`命令：

- **匹配`ACL`**：
  - `if-match acl {acl-number|acl-name}`
- **匹配前缀列表**
  - `if-match ip-prefix ip-prefix-name`
- **匹配度量值**
  - `if-match metric metric`
- **匹配路由的出接口**
  - `if-match interface interface-type interface-number`
- **匹配路由标签**
  - `if-match tag tag`

一个节点可以包含多条`if-match`语句，这些`if-match`语句之间是**与**的关系，也就是所有的`if-match`必须同时满足，被匹配对象才被视为匹配该节点，但是`if-match route-type`和`if-match interface`等除外，这些命令各自的`if-match`语句之间是**或**的关系。

一个节点中可以不包含任何`if-match`语句，当这种情况出现时，则视为匹配所有，也就是任何的被匹配对象都满足该节点的条件。

------

**apply（可选）**

在`Route-Policy`的节点视图下，使用`apply`命令指定需执行的动作，这些动作主要是对所匹配的路由的某些属性进行修改，例如修改路由的度量值、优先级值、标记等。

- **设置路由的度量值：**
  - `apply cost [+|-] cost`
- **设置路由的度量值类型：**
  - `apply cost-type { external | internal}`设置`IS-IS`的度量值类型。
  - `apply cost-type { type-1 | type-2 }`设置`OSPF`的度量值类型。
- **设置路由的下一跳地址：**
  - `apply ip-address next-hop {ipv4-address | peer-address}`
- **设置路由的优先级：**
  - `apply preference`
- **设置路由标记**
  - `apply tag`

一个节点可以不包含任何`apply`语句，此时该节点只被用于执行路由过滤，而不用于设置路由的属性。

------

**实验1：**

![image-20250823193015959](https://gitee.com/chouhama/pic/raw/master/20250823193016044.png)

`AR1`和`AR2`建立`OSPF`邻居，`AR1`有三条指向`AR3`的静态路由：

- `192.168.10.0/24`
- `192.168.20.0/24`
- `192.168.30.0/24`

要求将静态路由引入到`OSPF`时，只放行`192.168.20.0/24`。

![image-20250823193748356](https://gitee.com/chouhama/pic/raw/master/20250823193755479.png)

在`AR1`创建`ip-prefix`匹配`192.168.20.0/24`：

```
[AR1]ip ip-prefix static-to-ospf permit 192.168.20.0 24
```

在`AR1`创建`route-policy`并绑定`ip-prefix`：

```
[AR1]route-policy static-to-ospf permit node 10
[AR1-route-policy]if-match ip-prefix static-to-ospf 
[AR1-route-policy]quit
```

在`AR1`的`OSPF`重分布`Static`并绑定`Route-Policy`：

```
[AR1]ospf 1
[AR1-ospf-1]import-route static route-policy static-to-ospf 
[AR1-ospf-1]quit
```

![image-20250823194557378](https://gitee.com/chouhama/pic/raw/master/20250823194557481.png)

------

**实验2：**

![image-20250823193015959](https://gitee.com/chouhama/pic/raw/master/20250823194640663.png)

`AR1`和`AR2`建立`OSPF`邻居，`AR1`有三条指向`AR3`的静态路由：

- `192.168.10.0/24`
- `192.168.20.0/24`
- `192.168.30.0/24`

要求将静态路由引入到`OSPF`时，过滤`192.168.20.0/24`。

**方法一：**

```
[AR1]ip ip-prefix static-to-ospf deny 192.168.20.0 24
[AR1]ip ip-prefix static-to-ospf permit 192.168.10.0 24
[AR1]ip ip-prefix static-to-ospf permit 192.168.30.0 24
```

![image-20250823194838178](https://gitee.com/chouhama/pic/raw/master/20250823194838292.png)

**方法二：**

```
[AR1]dis ip ip-prefix 
Prefix-list static-to-ospf
Permitted 2
Denied 4
        index: 10               permit  192.168.20.0/24

[AR1]dis route-policy 
Route-policy : static-to-ospf
  deny : 10 (matched counts: 4)
    Match clauses : 
      if-match ip-prefix static-to-ospf
  permit : 20 (matched counts: 13)
```

![image-20250823200158742](https://gitee.com/chouhama/pic/raw/master/20250823200158854.png)

**问题：**

为什么下面这种方式不可行？？

```
[AR1]dis ip ip-prefix
Prefix-list static-to-ospf
Permitted 4
Denied 11
        index: 10               deny    192.168.20.0/24
        
<AR1>dis route-policy
Route-policy : static-to-ospf
  permit : 10 (matched counts: 11)
    Match clauses : 
      if-match ip-prefix static-to-ospf
  permit : 20 (matched counts: 3)
```

**原因：**

此时`192.168.20.0/24`的路由会进行`Route-Policy`的匹配，策略首先从`node 10`开始执行。`ip ip-prefix`在这里的角色是一个匹配工具，而不是执行动作的工具，它的`permit`和`deny`的含义是**匹配**和**不匹配**。

所以，在这里`deny 192.168.20.0/24`代表不匹配，那么理所当然这条路由会到下一个`node`进行匹配工作，而`node 20`没有规定任何的`if-match`，代表匹配所有。

最终，`192.168.20.0/24`就会被顺利的引入到`ospf`，所以这种方式不可行。

------

##### 1.2.2.匹配工具在路由策略中的作用

无论是`ACL`还是`ip-prefix`一定要记住一点，在路由策略的情况下（站在路由策略的角度上），它们只是**匹配工具**，那也就代表只有被它们`permit`的才是被成功匹配的，`deny`了就是不匹配。

举个例子：

你是公司的`HR`，你的工作就是让符合条件的人来公司面试（`permit`）以及过滤掉不符合条件的人（`deny`）。那站在公司（路由策略）的角度，只有来面试（`permit`）的才能算进`HR`的业绩（匹配成功），`deny`的理所当然不算。

------

##### 1.2.3.Filter-Policy

`Filter-Policy`（过滤-策略）是一个很常用的路由信息过滤工具，能够对接收、发布、引入的路由进行过滤，可应用于`IS-IS`、`OSPF`、`BGP`等协议。

`Filter-policy`可以调用`ACL、ip-prefilx、route-policy`等工具来匹配路由，用于控制对路由的发布或接收。在`IGP`和`BGP`都能够使用，`filter-policy`分为`import`和`export`。

- `import`：主要影响路由器接收路由，影响自身路由表的变化，适合于任何路由协议。但是，不同类型的路由协议也是有差别的：
  - 距离矢量路由协议基于自身路由表来通告，传递的是路由表信息。通过`filter-policy`可以过滤路由的接收。
  - 链路状态协议基于`LSA`，并不是路由信息，`filter-policy import`不能过滤`LSA`，而是阻止路由表的生成。

- `export`：在距离矢量路由协议中用于向邻居发路由时的控制，影响邻居路由器的路由表变化。**在链路状态协议中往往用在`ASBR`上控制外部路由的引入。**
  - 在一些书籍中可能会提到，`export`可以过滤`3`类`LSA`，实际上无论你用模拟器还是真机，它都是做不到的。所以，`filter-policy export`在`ospf`中只能过滤`5`和`7`。

------

**案例一：对`OSPF`接收的路由过滤（区域内）**

下图中，三台路由器同属于`OSPF Area 0`，`AR1`发布网段`192.168.10.0/24`，要求在`AR2`上部署`filter-policy import`，使`AR2`的路由表中不允许出现`192.168.10.0/24`这条路由。

在`AR1`的`loo0`接口修改类修为`broadcast`，就可以宣告出`24`位的路由。

![image-20250823232339615](https://gitee.com/chouhama/pic/raw/master/20250823232339719.png)

**配置如下：**

```
[AR2]ip ip-prefix huawei index 10 deny 192.168.10.0 24
[AR2]ip ip-prefix huawei index 20 permit 0.0.0.0 0 le 32
[AR2]ospf 1
[AR2-ospf-1]filter-policy ip-prefix huawei import
```

**现象：**

此时，`AR2`的路由表中不会再出现`192.168.10.0/24`这条路有。但是，`AR2`的`LSDB`中依旧会存在`192.168.10.0/24`，并且`AR3`的路由表中依旧会有`192.168.10.0/24`。

所以，可得出结论，当前的`filter-policy`只会影响`AR2`不将该路由放进路由表，但不会影响底层`OSPF LSA`的收发。

![image-20250823232936833](https://gitee.com/chouhama/pic/raw/master/20250823232936946.png)

![image-20250823232951868](https://gitee.com/chouhama/pic/raw/master/20250823232951994.png)

**分析：**

在这个实验中，无论你在哪台设备上使用`export`都无法成功做到影响其他设备的路由表。因为，`OSPF`使用`LSA`进行交互，`filter-policy`本身是无法控制`LSA`的，且`LSA1、LSA2`在`OSPF`里一个区域必须一致。所以，你没有任何办法通过`export`影响对方。

------

**案例2：对`OSPF`接收的路由过滤（区域间）**

对于下图，`AR2`的配置于第一个案例一致，依旧需要使用`import`。当使用`import`时，首先`192.168.10.0/24`不会出现在`AR2`的路由表中，因此`AR2`不能够再产生描述区域间路由的这个`Type3-LSA`，因此`SwitchC`上不会再学习到`10.1.1.0/24`这条路由。

当然，你也可以直接选择在`AR3`上进行路由过滤，配置与上一个案例一致。

```
[AR2]ip ip-prefix huawei index 10 deny 192.168.10.0 24
[AR2]ip ip-prefix huawei index 20 permit 0.0.0.0 0 le 32
[AR2]ospf 1
[AR2-ospf-1]filter-policy ip-prefix huawei import
```

![image-20250823234308185](https://gitee.com/chouhama/pic/raw/master/20250823234308294.png)

**分析：**

同样，如果在`AR2`上使用`export`也无法生效，按照书籍等一些资料的说法，`filter-policy`在`export`方向上可以过滤`LSA 3、LSA 5、LSA7`。所以，这里暂时存疑，可能是模拟器的问题。

真机上也经过测试，无法做出在`ABR`上过滤`3`类`LSA`的效果。

![image-20250824003743417](https://gitee.com/chouhama/pic/raw/master/20250824003743516.png)

------

**案例3：对`OSPF`发出的路由过滤（外部路由）**

对于下图，`AR1`的`loo2`接口地址为`192.168.20.0/24`，将该地址以直连的形式重分发进入`OSPF`。然后使用`filter-policy export`过滤掉该路由。

![image-20250824000821342](https://gitee.com/chouhama/pic/raw/master/20250824000821452.png)

```
[AR1]ip ip-prefix test1 deny 192.168.20.0 24
[AR1-ospf-1]filter-policy ip-prefix test1 export
```

![image-20250824003528897](https://gitee.com/chouhama/pic/raw/master/20250824003529024.png)

![image-20250824003730743](https://gitee.com/chouhama/pic/raw/master/20250824003730843.png)

------

#### 1.3.双点双向路由重分布

![image-20250824122027603](https://gitee.com/chouhama/pic/raw/master/20250824122034760.png)

##### 1.3.1.何为双点双向？

在边界路由器上把两个路由域的路由互相引入，称之为双向路由重分布。

两个路由域存在两个边界路由器，并且都执行双向路由重分发，此时称为双点双向路由重分布。

------

##### 1.3.2.为什么需要双点双向

双点双向路由重分布是一种经典的路由模型，因单点的双向路由重分布缺乏**冗余性**，一旦单点的边界路由器故障，那么两个路由域之间的通信可能就会出现问题，因此在大型网络部署中一般采用双点双向路由重分布。

双点双向路由重分布虽然增强了网络的可靠性，但是容易引发：次优路径、路由环路等问题。

------

##### 1.3.3.准备工作

在上图中，需要将`AR1`的`192.168.10.0/24`路由引入到`OSPF`中：

```
<AR1>dis ip ip-prefix 
Prefix-list permit
Permitted 1
Denied 2
        index: 10               permit  192.168.10.0/24         

<AR1>dis route-policy
Route-policy : permit
  permit : 10 (matched counts: 1)
    Match clauses : 
      if-match ip-prefix permit
```

![image-20250824131430070](https://gitee.com/chouhama/pic/raw/master/20250824131430383.png)

------

在`AR2`和`AR3`上执行**双向引入**。

```
[AR2]isis 1
[AR2-isis-1]import-route ospf 1
[AR2]ospf 1	
[AR2-ospf-1]import-route isis 1

[AR3]ospf 1
[AR3-ospf-1]import-route isis 1
[AR3]isis 1
[AR3-isis-1]im ospf 1
```

------

##### 1.3.4.问题一：次优路径

由于做了**双点双向重分布**，当前`AR1`在`OSPF`中宣告了外部路由`192.168.10.0/24`，`AR2`会将该`OSPF`路由引入到`IS-IS`，并将`IS-IS`引入到`OSPF`，同时`AR3`也做了这件事。

**即使，只做了`OSPF`引入`IS-IS`的单向重分布，也会出现这个问题。**

但是，此时`AR3`会同时从`OSPF`和`IS-IS`学习到`192.168.10.0/24`的路由，那现在它会选择将`OSPF`的`192.168.10.0/24`加入路由表，还是`IS-IS`的`192.168.10.0/24`加入路由表呢？

众所周知，当路由前缀相同时，先比较**路由优先级**，才是`OSPF`中的`192.168.10.0/24`因为是外部路由，所以优先级为`150`，而`IS-IS`的`192.168.10.0/24`路由优先级是`15`。故`AR3`的路由表中只保存`IS-IS`学习到的`192.168.10.0/24`。

次优路径就此产生，`AR3`应该选择从`OSPF`走向`AR1`作为最优路径，但因为双点双向重分发引起的路由选路流程，选择了路由优先级最优的`IS-IS`。

**为什么是`AR3`有这个现象，`AR2`会产生么？**

- 哪台路由器**后做**高优先级引入低优先级这个动作，谁就会产生这个现象。

**为什么`AR2`此时不会从`IS-IS`学习到这条路由？**

- 因为`AR2`先做了重分发导致`AR3`只能从`IS-IS`学习到这条路有，那么`AR3`就不会将`IS-IS`的路由引入进`IS-IS`，所以`AR2`只会从`OSPF`学习到`192.168.10.0/24`。

![image-20250824134109203](https://gitee.com/chouhama/pic/raw/master/20250824134109401.png)

------

##### 1.3.5.解决方法一：

在`R3`的`IS-IS`进程内，通过`Filter-Policy`禁止来自`R4`的`192.168.10.0/24`路由加入本地路由表。

```
[AR3]ip ip-prefix deny deny 192.168.10.0 24
[AR3]ip ip-prefix deny permit 0.0.0.0 0 le 32

[AR3]isis 1	
[AR3-isis-1]filter-policy ip-prefix deny import 
[AR3-isis-1]quit
```

![image-20250824133919315](https://gitee.com/chouhama/pic/raw/master/20250824133919634.png)

![image-20250824133952800](https://gitee.com/chouhama/pic/raw/master/20250824133952979.png)

------

##### 1.3.6.解决方法二：

此时，可能需要在`R2`上继续往下做，因为次优路径出现在`R2`上了。如果上一种解决方法做了，你就可能会发现即使在`R3`拿掉`filter-policy`的配置，次优路径在`R3`上也看不到了，已经改变出现在`R2`上了。

`R2`通过`route-policy`匹配`192.168.10.0/24`这条路有，并将其**路由优先级**改小（小于`IS-IS`）。并在`OSPF`中使用`preference ase`进行调用。

```
[AR2]ip ip-prefix test1 permit 192.168.10.0 24
[AR2]route-policy test1 permit node 10
[AR2-route-policy]if-match ip-prefix test1
[AR2-route-policy]apply preference 14
[AR2-route-policy]quit
[AR2]ospf 1
[AR2-ospf-1]preference ase route-policy test1
[AR2-ospf-1]quit
```

![image-20250824134700698](https://gitee.com/chouhama/pic/raw/master/20250824134700967.png)

![image-20250824134651429](https://gitee.com/chouhama/pic/raw/master/20250824134651623.png)

------

##### 1.3.7.问题二：路由环路

假设，没有解决**次优路径**的问题，此时`AR2`的路由表中依旧是从`IS-IS`学习到`192.168.10.0/24`的路由。

![image-20250824141015318](https://gitee.com/chouhama/pic/raw/master/20250824141015523.png)

如果，现在`AR1`的`192.168.10.0/24`因为各种各样的问题从`AR1`的路由表中消失了。

此时`AR1`的路由表中立马会从`AR2`学习到`192.168.10.0/24`，`AR2`的`192.168.10.0/24`依旧是从`AR4 IS-IS`学习到的，`AR4`的也依旧是从`AR3 IS-IS`学习到的。

那请问`AR3`呢？

`AR1`从`AR2`学习到后，就会把这条路有泛洪给`AR3`，所以`AR3`通过`OSPF`学习到了`192.168.10.0/24`下一跳是`AR1`。

所以现在的顺序是：

```
AR1 --> AR2 --> AR4 --> AR3 --> AR1
```

环路就此产生：

![image-20250824142137192](https://gitee.com/chouhama/pic/raw/master/20250824142137387.png)

------

##### 1.3.8.解决方法一：

在`R2`的`OSPF`中引入`IS-IS`路由时，通过`Route-Policy`或者`Filter-Policy`过滤掉`192.168.10.0/24`这条路有。

```
[AR2]ip ip-prefix test2 deny 192.168.10.0 24
[AR2-ospf-1]filter-policy ip-prefix test2 export
```

或者

```
ip ip-prefix test2 deny 192.168.10.0 24
ip ip-prefix test2 permit 0.0.0.0 0 le 32
route-policy test2 permit node 10
if-match ip-prefix test2
ospf 1
import-route isis 1 route-policy test2
```

![image-20250824142856527](https://gitee.com/chouhama/pic/raw/master/20250824142856746.png)

------

##### 1.3.9.解决方法二：

- 记得先把环境恢复到出现路由环路问题，可能得重新重分发。演示环境中，切换后`AR3`从`IS-IS`学到`192.168.10.0/24`的路由。

使用`Tag`实现选择性的路由引入，在`AR2`将路由`192.168.10.0/24`从`OSPF`引入到`IS-IS`时打上`Tag`，在`R3`上将`IS-IS`引入到`OSPF`中时，过滤携带`Tag`的路由。

需要注意，`IS-IS`必须是`Wide`模式的`Cost`才可以携带`Tag`。

1. 在`AR2`上使用`ip-prefix`匹配`192.168.10.0/24`的路由。

```
[AR2]ip ip-prefix hcip permit 192.168.10.0 24
```

2. 在`AR2`上使用`Route-Policy`绑定`ip-prefix`并打上`Tag 200`。

```
[AR2]route-policy hcip permit node 10
[AR2-route-policy]if-match ip-prefix hcip
[AR2-route-policy]apply tag 200
[AR2-route-policy]quit
```

3. 在`AR2`的`IS-IS`引入`OSPF`时，绑定`Route-Policy`。

```
[AR2]isis 1
[AR2-isis-1]import-route ospf route-policy hcip
```

4. 在`AR3`上配置`Route-Policy`，匹配`Tag 200`的路由，并将其过滤。

```
[AR3]route-policy hcip deny node 10	
[AR3-route-policy]if-match  tag 200
[AR3-route-policy]quit
[AR3]route-policy hcip permit node 20
[AR3-route-policy]quit
[AR3]ospf 1
[AR3-ospf-1]import-route isis route-policy hcip
[AR3-ospf-1]quit
```

![image-20250824175807962](https://gitee.com/chouhama/pic/raw/master/20250824175808149.png)

![image-20250824180428114](https://gitee.com/chouhama/pic/raw/master/20250824180428304.png)

------

### 2.策略路由

![image-20250824184322945](https://gitee.com/chouhama/pic/raw/master/20250824184323090.png)

首先回顾一下`IP`路由的概念，路由器收到一个`IP`报文时，需要根据该报文的**目的**`IP`地址查找**路由表**按照路由条目所指示的出接口或下一跳`IP`地址转发该报文。所以，路由行为只关心报文的目的`IP`地址，而并不关心报文的源地址。

如下图，假设`R3`的路由表中只有一条静态路由`ip route-static 10.1.1.0 24 10.1.13.1`，那么`R3`在收到`PC1`或`PC2`去往`10.1.1.0/24`的报文时，都只会将该报文传递给`10.1.13.1`。即使负载均衡也是较为随机的交给`R1`或`R2`。

在这个例子中，你所能控制的无非就是使用**路由策略**影响`PC1`和`PC2`的数据包的下一跳，依旧是以目的地址查找路由表。你无法将`PC1`和`PC2`的流量精确控制，分担到两条链路上。

假设，我现在有一个需求，`PC1`的流量`R3`必须给`R1`，`PC2`的流量`R3`必须给`R2`。如果，还有其他`PC`的流量`R3`根据路由表转发。你无法再使用之前所学的知识做到这个需求了，你需要学习**策略路由**。

![image-20250824182735487](https://gitee.com/chouhama/pic/raw/master/20250824182735653.png)

------

#### 2.1.PBR基本概念

`PBR(Policy-Based Routing)`策略路由

- `PBR`使网络设备不仅能够基于报文的目的`IP`地址进行数据转发，更能基于其他元素进行数据转发，例如：
  - 源`IP`地址
  - 源`MAC`地址
  - 目的`MAC`地址
  - 源端口号
  - 目的端口号
  - `VLAN-ID`等

- 用户也可以使用匹配工具，匹配特定的报文，然后针对性的进行`PBR`部署。
- **若设备部署了`PBR`，则被匹配的报文优先根据`PBR`的策略进行转发，==即PBR策略的优先级高于传统路由==。**

![image-20250824183831846](https://gitee.com/chouhama/pic/raw/master/20250824183832016.png)

------

##### 2.1.1.结构介绍

`Policy-Based Routing`的配置方式与`Route-Policy`基本一致：[PBR Apply](https://support.huawei.com/enterprise/zh/doc/EDOC1100332384/7da6de95)

![image-20250824184250078](https://gitee.com/chouhama/pic/raw/master/20250824184250229.png)



------

##### 2.1.2.PBR的分类

`PBR`分为**接口PBR**和**本地PBR**，这里有一个需要注意的地方，在`PPT`里很明确的说`PBR`可以用作本地也可以用作接口，但事实上华为认为针对本地的策略路由应该使用`PBR`，而针对接口的策略路由应该使用`MQC`。

你这个时候很有可能会反驳我，用`PBR`明明也可以实现接口`PBR`。

- 只有少部分设备的`PBR`支持接口策略路由，模拟器也不支持。

![image-20250824184450287](https://gitee.com/chouhama/pic/raw/master/20250824184450458.png)

------

##### 2.1.3.典型应用场景

![image-20250824184715778](https://gitee.com/chouhama/pic/raw/master/20250824184715957.png)

![image-20250824184734839](https://gitee.com/chouhama/pic/raw/master/20250824184735003.png)

------

##### 2.1.4.实验：本地策略路由

在下图中，有三台路由器，其中`AR2`和`AR3`都有一个回环口地址。

**要求：**

- `AR1`不允许配置静态路由，`AR1`能够成功`ping`通两条回环口地址。

![image-20250824225645194](https://gitee.com/chouhama/pic/raw/master/20250824225645367.png)

```
[AR1]acl 3000
[AR1-acl-adv-3000]rule permit ip source 0.0.0.0 0 destination 2.2.2.2 0
[AR1-acl-adv-3000]quit

[AR1]acl 3001
[AR1-acl-adv-3001]rule permit ip source 0.0.0.0 0 destination 3.3.3.3 0
[AR1-acl-adv-3001]quit

[AR1]policy-based-route hcip permit node 10	
[AR1-policy-based-route-hcip-10]if-match acl 3000
[AR1-policy-based-route-hcip-10]apply ip-address next-hop 12.1.1.2
[AR1-policy-based-route-hcip-10]quit

[AR1]policy-based-route hcip permit node 20
[AR1-policy-based-route-hcip-20]if-match acl 3001
[AR1-policy-based-route-hcip-20]apply ip-address next-hop 13.1.1.2
[AR1-policy-based-route-hcip-20]quit

[AR1]ip local policy-based-route hcip
```

![image-20250824230303886](https://gitee.com/chouhama/pic/raw/master/20250824230304082.png)

![image-20250824230318394](https://gitee.com/chouhama/pic/raw/master/20250824230318612.png)

------

#### 2.2.MQC基本概念

再次重申，现在一定要建立一个观点，`PBR`这个工具用在**本地策略路由**。而针对**接口策略路由**时，需要使用`MQC`。

`MQC(Modular QoS Command-Line Interface)`模块化`QoS`命令行，是指通过将具有某类共同特征的数据流划分为一类，并为同一类数据流提供相同的服务，也可以对不同类的数据流提供不同的服务。

`MQC`包含为三个要素：

- 流分类（`traffic classifier`）
- 流行为（`traffic behavior`）
- 流策略（`traffic policy`）

`MQC`的流行为支持重定向报文，因此可以使用`MQC`实现`IP`单播策略路由。所以，`MQC`是实现策略路由的一种方式，但`MQC`不仅仅可以实现策略路由。

![image-20250824222635071](https://gitee.com/chouhama/pic/raw/master/20250824222635267.png)

------

##### 2.2.1.流分类

**流分类：**定义一组流量匹配规则，以对报文进行分类。

- **可匹配内容：**[策略路由原理描述 ](https://support.huawei.com/enterprise/zh/doc/EDOC1100332384/df2fa186)

![image-20250824222801851](https://gitee.com/chouhama/pic/raw/master/20250824222802119.png)

------

##### 2.2.2.流行为

**流行为：**用来定义执行的动作，支持报文过滤、重标记优先级、重定向、流量统计等动作。

- **可匹配内容：**[策略路由原理描述 ](https://support.huawei.com/enterprise/zh/doc/EDOC1100332384/df2fa186)

![image-20250824223102584](https://gitee.com/chouhama/pic/raw/master/20250824223102764.png)

------

##### 2.2.3.流策略

**流策略：**支持在接口上调用。

- 流策略存在方向（`inbound、outbound`）的概念，策略中的流行为匹配入、出方向的报文，对匹配中的报文执行相应的流动作。

![image-20250824223228649](https://gitee.com/chouhama/pic/raw/master/20250824223228863.png)

------

##### 2.2.4.实验：接口策略路由

**实验环境：**

当前`LSW1`上有两个业务`vlan`，`vlan 10 192.168.10.0/24`对接`PC1`，`vlan 20 192.168.20.0/24`对接`PC2`，`PC3 100.100.100.100/24`网关指向了`AR2`，`PC4 100.100.100.200/24`网关指向了`AR3`。所有的路由通过`OSPF`打通。

**实验要求：**

- 通过`MQC`实现`vlan 10`访问`100.100.100.100`从`AR3`走，访问`100.100.100.200`从`AR2`走。

- 通过`MQC`实现`vlan 20`访问`100.100.100.100`从`AR2`走，访问`100.100.100.200`从`AR3`走。

![image-20250824213728335](https://gitee.com/chouhama/pic/raw/master/20250824213735527.png)

------

先分析一下，按照我当前的需求，`vlan 10`访问`100.100.100.100`和`vlan 20`访问`100.100.100.200`流量走向是一致的。`vlan 10`访问`100.100.100.200`和`vlan 20`访问`100.100.100.100`流量走向是一致的。

1. 在`AR1`配置`ACL`匹配下一跳为`AR2`的流量。

```
acl name next_ar2 3000
 rule 5 permit ip source 192.168.10.0 0.0.0.255 destination 100.100.100.200 0
 rule 10 permit ip source 192.168.20.0 0.0.0.255 destination 100.100.100.100 0
```

2. 在`AR1`配置`ACL`匹配`vlan 20`

```
acl name next_ar3 3001
 rule 5 permit ip source 192.168.10.0 0.0.0.255 destination 100.100.100.100 0
 rule 10 permit ip source 192.168.20.0 0.0.0.255 destination 100.100.100.200 0
```

3. 创建**流分类**，分别匹配`ACL 3000、30001`

```
[AR1]traffic classifier 1	
[AR1-classifier-1]if-match acl 3000
[AR1-classifier-1]quit

[AR1]traffic classifier 2	
[AR1-classifier-2]if-match acl 3001
[AR1-classifier-2]quit
```

4. 创建**流行为**分别执行将报文重定向到`12.1.1.2、13.1.1.2`

```
[AR1]traffic behavior 1
[AR1-behavior-1]redirect ip-nexthop 12.1.1.2
[AR1-behavior-1]quit

[AR1]traffic behavior 2
[AR1-behavior-2]redirect ip-nexthop 13.1.1.2
[AR1-behavior-2]quit
```

5. 创建**流策略**`Redirect`，将流分类与流行为一一绑定

```
[AR1]traffic policy Redirect
[AR1-trafficpolicy-Redirect]classifier 1 behavior 1
[AR1-trafficpolicy-Redirect]classifier 2 behavior 2
[AR1-trafficpolicy-Redirect]quit
```

6. 将`AR1`的`GE0/0/2`接口入方向调用流策略`Redirect`

```
[AR1]int g0/0/2	
[AR1-GigabitEthernet0/0/2]traffic-policy Redirect inbound 
[AR1-GigabitEthernet0/0/2]quit
```

![image-20250824225420136](https://gitee.com/chouhama/pic/raw/master/20250824225420424.png)

------

### 3.流量过滤

为提高网络安全性，管理人员需要控制进入网络的流量，将不信任的报文丢弃在网络边界。所谓的不信任报文是指对用户来说存在安全隐患或者不愿意接收的报文。同时保证数据访问安全性，企业网络中经常会要求一些部门之间不能相互访问。

![image-20250824231500596](https://gitee.com/chouhama/pic/raw/master/20250824231500831.png)

#### 3.1.流量过滤工具

`Traffic-Filter`只能应用在接口视图下，而`MQC`可以调用在多种视图。

![image-20250824231522273](https://gitee.com/chouhama/pic/raw/master/20250824231522498.png)

##### 3.1.1.Traffic-Filter部署位置

使用`Traffic-Filter`过滤流量可以灵活地选择部署位置，在流量进入设备或者离开设备的接口上执行过滤动作，双向访问的业务禁止其中一个方向即可实现阻断业务的需求。

![image-20250824231628698](https://gitee.com/chouhama/pic/raw/master/20250824231628914.png)

**实验：**

要求阻止`PC1`与`PC2`的互访。

![image-20250824232002841](https://gitee.com/chouhama/pic/raw/master/20250824232003032.png)

**方法一：**

- **方向：**`PC1 --> PC2`
- **匹配策略：**`source:192.168.10.1 destination:192.168.20.1`
- **调用接口：**`GE0/0/0 in`

```
[AR1]acl 3000	
[AR1-acl-adv-3000]rule deny ip source 192.168.10.1 0 destination 192.168.20.1 0
[AR1-acl-adv-3000]rule permit ip
[AR1-acl-adv-3000]quit

[AR1]int g0/0/0
[AR1-GigabitEthernet0/0/0]traffic-filter inbound acl 3000
[AR1-GigabitEthernet0/0/0]quit
```

![image-20250824232421634](https://gitee.com/chouhama/pic/raw/master/20250824232421864.png)

------

**方法二：**

- **方向：**`PC1 --> PC2`
- **匹配策略：**`source:192.168.10.1 destination:192.168.20.1`
- **调用接口：**`GE0/0/1 out`

```
[AR1]acl 3000	
[AR1-acl-adv-3000]rule deny ip source 192.168.10.1 0 destination 192.168.20.1 0
[AR1-acl-adv-3000]rule permit ip
[AR1-acl-adv-3000]quit

[AR1]int g0/0/1
[AR1-GigabitEthernet0/0/1]traffic-filter outbound acl 3000
[AR1-GigabitEthernet0/0/1]quit
```

------

**方法三：**

- **方向：**`PC2 --> PC1`
- **匹配策略：**`source:192.168.20.1 destination:192.168.10.1`
- **调用接口：**`GE0/0/1 in`

```
[AR1]acl 3001
[AR1-acl-adv-3001]rule deny ip source 192.168.20.1 0 destination 192.168.10.1 0
[AR1-acl-adv-3001]rule permit ip
[AR1-acl-adv-3001]quit

[AR1]int g0/0/1
[AR1-GigabitEthernet0/0/1]traffic-filter inbound acl 3001
```

------

**方法四：**

- **方向：**`PC2 --> PC1`
- **匹配策略：**`source:192.168.20.1 destination:192.168.10.1`
- **调用接口：**`GE0/0/0 out`

```
[AR1]acl 3001
[AR1-acl-adv-3001]rule deny ip source 192.168.20.1 0 destination 192.168.10.1 0
[AR1-acl-adv-3001]rule permit ip
[AR1-acl-adv-3001]quit

[AR1]int g0/0/0
[AR1-GigabitEthernet0/0/1]traffic-filter outbound acl 3001
```

------

##### 3.1.2.使用MQC过滤流量

**方法一：**

- **方向：**`PC1 --> PC2`
- **匹配策略：**`source:192.168.10.1 destination:192.168.20.1`
- **调用接口：**`GE0/0/0 in`

```
[AR1]acl 3000	
[AR1-acl-adv-3000]rule deny ip source 192.168.10.1 0 destination 192.168.20.1 0
[AR1-acl-adv-3000]rule permit ip
[AR1-acl-adv-3000]quit

[AR1]traffic classifier 1-2	
[AR1-classifier-1-2]if-match acl 3000
[AR1-classifier-1-2]quit

[AR1]traffic behavior 1-2
[AR1-behavior-1-2]deny
[AR1-behavior-1-2]quit	

[AR1]traffic policy 1-2
[AR1-trafficpolicy-1-2]classifier 1-2 behavior 1-2
[AR1-trafficpolicy-1-2]quit

[AR1]int g0/0/0
[AR1-GigabitEthernet0/0/0]traffic-policy 1-2 inbound 
[AR1-GigabitEthernet0/0/0]quit
```

------

**方法二：**

- **方向：**`PC1 --> PC2`
- **匹配策略：**`source:192.168.10.1 destination:192.168.20.1`
- **调用接口：**`GE0/0/1 out`

```
[AR1]acl 3000	
[AR1-acl-adv-3000]rule deny ip source 192.168.10.1 0 destination 192.168.20.1 0
[AR1-acl-adv-3000]rule permit ip
[AR1-acl-adv-3000]quit

[AR1]traffic classifier 1-2	
[AR1-classifier-1-2]if-match acl 3000
[AR1-classifier-1-2]quit

[AR1]traffic behavior 1-2
[AR1-behavior-1-2]deny
[AR1-behavior-1-2]quit	

[AR1]traffic policy 1-2
[AR1-trafficpolicy-1-2]classifier 1-2 behavior 1-2
[AR1-trafficpolicy-1-2]quit

[AR1]int g0/0/1
[AR1-GigabitEthernet0/0/1]traffic-policy 1-2 outbound 
[AR1-GigabitEthernet0/0/1]quit
```

------

**方法三：**

- **方向：**`PC2 --> PC1`
- **匹配策略：**`source:192.168.20.1 destination:192.168.10.1`
- **调用接口：**`GE0/0/1 in`

```
[AR1]acl 3001
[AR1-acl-adv-3001]rule deny ip source 192.168.20.1 0 destination 192.168.10.1 0
[AR1-acl-adv-3001]rule permit ip
[AR1-acl-adv-3001]quit

[AR1]traffic classifier 2-1	
[AR1-classifier-2-1]if-match acl 3001
[AR1-classifier-2-1]quit

[AR1]traffic behavior 2-1	
[AR1-behavior-2-1]deny 
[AR1-behavior-2-1]quit

[AR1]traffic policy 2-1	
[AR1-trafficpolicy-2-1]classifier 2-1 behavior 2-1
[AR1-trafficpolicy-2-1]quit

[AR1]int g0/0/1
[AR1-GigabitEthernet0/0/1]traffic-policy 2-1 inbound 
[AR1-GigabitEthernet0/0/1]quit
```

------

**方法四：**

- **方向：**`PC2 --> PC1`
- **匹配策略：**`source:192.168.20.1 destination:192.168.10.1`
- **调用接口：**`GE0/0/0 out`

```
[AR1]acl 3001
[AR1-acl-adv-3001]rule deny ip source 192.168.20.1 0 destination 192.168.10.1 0
[AR1-acl-adv-3001]rule permit ip
[AR1-acl-adv-3001]quit

[AR1]traffic classifier 2-1	
[AR1-classifier-2-1]if-match acl 3001
[AR1-classifier-2-1]quit

[AR1]traffic behavior 2-1	
[AR1-behavior-2-1]deny 
[AR1-behavior-2-1]quit

[AR1]traffic policy 2-1	
[AR1-trafficpolicy-2-1]classifier 2-1 behavior 2-1
[AR1-trafficpolicy-2-1]quit

[AR1]int g0/0/0
[AR1-GigabitEthernet0/0/0]traffic-policy 2-1 outbound 
[AR1-GigabitEthernet0/0/0]quit
```

------

