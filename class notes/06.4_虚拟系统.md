# 04_虚拟系统

### 1.虚拟系统的基本概念

#### 1.1.什么是虚拟化？

虚拟化`Virtualization`的含义很广泛，将任何一种形式的资源抽象成另一种形式，都可以称为虚拟化。虚拟化是资源的逻辑表示，是资源的分配不受物理限制。

虚拟化使得在一台物理的服务器上可以跑多台虚拟机，虚拟机共享物理机的`CPU`、内存、`I/O`硬件资源，但逻辑上虚拟机之间是相互隔离的。虚拟化可以达到节省硬件成本、能耗和空间的目的。

![image-20250923225002232](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250923225002262.png)

------

#### 1.2.什么是虚拟系统？

虚拟系统（`virtual System,VSYS`）是一种虚拟化技术，指在一台物理设备上划分出多个相互独立的逻辑设备。每个虚拟系统相当于一台真实的设备，拥有自己的资源，管理员可以对虚拟系统内部的业务和资源进行单独的配置和管理。

由于网络管理变得越来越复杂，用户对于业务隔离、系统安全性和可靠性等方面的要求越来越高，使用虚拟系统技术可以从资源上进行物理隔离、实现业务隔离、同时简化网络部署和管理、加强系统安全性和可靠性。

![image-20250923231053934](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250923231053957.png)

**虚拟系统的特点：**

- **管理独立：**每个虚拟系统由独立的管理员进行管理，使得多个虚拟系统的管理更加清晰简单，所以非常适合大规模的组网环境。
- **资源分配：**可以为每个虚拟系统分配固定的系统资源，保证不会因为一个虚拟系统的业务繁忙而影响其他虚拟系统。
- **流量隔离：**虚拟系统之间的流量相互隔离，更加安全。在需要的时候，虚拟系统之间也可以进行安全互访。
- **配置独立：**每个虚拟系统拥有独立的配置及路由表，这使得虚拟系统下的局域网`IP`地址范围可以一致。

![image-20250923234118850](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250923234118883.png)

------

#### 1.3.虚拟系统的类型

在华为防火墙设备上存在两种类型的虚拟系统：

- 根系统（`public`）：
  - 根系统是防火墙上缺省存在的一个特殊的虚拟系统。即使没有开启虚拟系统功能，根系统也依然存在。此时，管理员对防火墙的配置等同于对根系统进行配置。当启用虚拟系统功能后，根系统会继承先前防火墙上的配置。
  - 在虚拟系统这个特性中，根系统的作用是管理其他虚拟系统，并为虚拟系统间的通信提供服务。
- 虚拟系统（`VSYS`）：
  - 虚拟系统是在防火墙上划分出来的、独立运行的逻辑设备。

![image-20250923231736552](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250923231736574.png)

------

#### 1.4.虚拟系统管理

虚拟系统的管理和配置是相互独立的，所对应的管理员也是不同的。根据虚拟系统的类型，管理员分为根系统管理员和虚拟系统管理员。两类管理员的作用范围和功能都不相同。

![image-20250923231947469](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250923231947498.png)

****

#### 1.5.虚拟系统资源分配

在防火墙虚拟系统中**合理分配资源**可以对单个虚拟系统的资源进行约束，避免因某个虚拟系统占用过多的资源，导致其他虚拟系统无法获取或业务无法正常运行。

在防火墙中资源分配有三种方式：

- **定额分配**
- **手工分配**
- **共享抢占**

防火墙实现**虚拟系统业务**的基础资源支持定额分配和手工分配，其他资源使用共享抢占的方式进行资源分配。

![image-20250923232328679](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250923232328711.png)

##### 1.5.1.带宽资源

带宽资源指的是网络中关键业务所需的带宽，支持管理员手工分配，避免线路繁忙时影响关键业务。

带宽资源分为**入方向带宽、出方向带宽和整体带宽**。一条数据流是受哪类带宽资源限制与流量的出接口或入接口有关。

![image-20250923232740955](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250923232740986.png)

------

#### 1.6.虚拟系统的分流

当防火墙上开启了虚拟系统功能后，一个报文进入到防火墙，如何判断报文与虚拟系统的归属关系呢？

防火墙通过**分流**将进入设备的报文送入正确的虚拟系统处理，分流方式有以下三种：

- **基于接口：**接口工作在三层时，采用基于接口的分流方式。
- **基于VLAN：**接口工作在二层时，采用基于`VLAN`的分流方式。
- **基于VNI：**虚拟系统和`VXLAN`结合使用时，采用基于`VNI`的分流方式。

所谓的**分流**实际上指的是**确定报文与虚拟系统归属关系的过程**。

**分流**完毕之后，报文仅根据虚拟系统内的策略和表项对报文进行处理，转发也仅需根据虚拟系统内的路由表。

------

##### 1.6.1.基于接口的虚拟系统分流

将接口与虚拟系统绑定后，该接口收到的报文将根据虚拟系统配置进行处理。

![image-20250923233543780](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250923233543808.png)

如上图，当防火墙的`GE0/0/1`接口收到报文后，根据分流将报文归属于`VSYS_A`，后续对报文的所有处理（包括路由查找和策略等）都依赖于`VSYS_A`。

------

##### 1.6.2.基于VLAN的虚拟系统分流

![image-20250923233735205](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250923233735234.png)

如上图，防火墙上配置了虚拟系统，并为防火墙上的不同接口配置了`VLAN Tag`。当防火墙收到报文时，根据其对应的`VLAN`来判断属于哪个虚拟系统。然后再根据该虚拟系统的`MAC`地址表查询出接口，确定报文出入接口的域间关系，最后通过策略决定报文是否允许转发。

------

### 2.虚拟系统互访

#### 2.1.虚拟接口

一台防火墙上的多个虚拟系统背后的网络是通过**虚拟接口**实现互访的。虚拟接口是创建虚拟系统时自动为其创建的一个逻辑接口，作为虚拟系统自身与其他虚拟系统之间通信的接口。

虚拟接口名字的格式为`Virtual-if + 接口号`，根系统的虚拟接口名称为`Virtual-if 0`，其他虚拟系统的`Virtual-if`接口号从`1`开始，根据先后配置顺序依次分配。

![image-20250923235528015](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250923235528042.png)

------

#### 2.2.虚拟系统与根系统互访

虚拟系统与根系统互访有两种场景：

- 虚拟系统访问根系统
- 根系统访问虚拟系统

------

##### 2.2.1.虚拟系统访问根系统

![image-20250923235815756](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250923235815789.png)

如上图，内部`PC`主动访问服务器。防火墙开启了虚拟系统功能，并在原有`Public`系统基础上创建了`VSYS_A`。该防火墙的`GE0/0/2`接口属于`VSYS_A`承载`10.3.0.0/24`网段的流量。该防火墙的`GE0/0/1`接口属于`Public`承载整个内网（通过`VSYS`），并与互联网相连。

当防火墙的`GE0/0/2`接口接收到流量后，根据分流被分配到`VSYS_A`。此时根据报文的**目的地址**查找`VSYS_A`的**路由表**，发现匹配到默认路由，出接口为`Virtual-if 0`。随即，`VSYS_A`会检查其安全策略是否允许该流量通过，若允许则通过自身的`Virtual-if1`接口将报文转发给`Public`。

`Public`接收到之后，会根据路由表查找出接口和下一跳，并查看安全策略是否允许通过。

当服务器返回数据包时，当该数据包到达`GE0/0/1`接口后会被防火墙分配给`Public`。**根系统此时不需要配置去往`10.3.0.0`的路由，也不会查找路由表，它会根据会话表直接发送到虚拟系统中处理。**

------

##### 2.2.2.根系统访问虚拟系统

![image-20250924000931540](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250924000931575.png)

此时，防火墙将内网服务器映射到公网供外网客户端进行访问。当数据包进入防火墙时，由于是从`GE0/0/1`接口收到的报文，所以根据分流该数据包交由`Public`处理。此时，根系统会根据路由表将报文转发给`VSYS_A`前提是拥有对应安全策略。

`VSYS_A`收到后，同样是根据路由表和安全策略指导数据报文转发。

当服务器返回报文给客户端时，`VSYS_A`不再需要配置回程路由，匹配到会话表后直接发送到`Public`进行处理。

------

##### 2.2.3.引流表

之前我们介绍的场景中，虚拟系统和根系统都会按照防火墙转发流程对报文进行处理。针对互访的业务，虚拟系统和根系统都需要配置策略和建立会话。

这么做一方面增加了配置的复杂性，一方面每条连接都需要创建两条绘画，业务量大时会造成整机的会话资源紧张。

当配置引流表时，引流表中记录的是`IP`地址和虚拟系统的归属关系。若报文命中引流表，根系统无需建立会话，直接按照路由表或引流表转发报文，从而避免以上问题。

![image-20250924003134867](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250924003134900.png)

------

**正向命中：**

![image-20250924003159754](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250924003159787.png)

如上图，外网客户端访问内网服务器。此时，在根系统上配置了引流表，当目的地址为`10.3.0.8`时直接转发到`VSYS_A`，不再建立会话。

当`VSYS_A`收到该报文后，根据路由表进行转发并创建对应会话。

------

**反向命中：**

![image-20250924003413880](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250924003413916.png)

当内网`PC`主动访问外网服务器，且引流表的配置如上图时，数据包经过`VSYS_A`时根据路由表与策略进行转发并创建会话表。当数据包到达根系统时，由于源地址和源实例匹配到了引流表的目的地址和目的实例，所以这是**反向命中**。

当报文反向命中引流表时，根系统根据自身的路由表指导报文转发，但不需要建立会话表。

------

**总结：**

正向命中和反向命中在这里的区别就是**如何指导报文转发，都不建立会话表**。

- **正向命中：**根据引流表转发。
- **反向命中：**根据路由表转发。

------

### 3.实验演示

#### 3.1.实验一：虚拟系统通过路由表互访

![image-20250924152119715](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250924152119775.png)

![image-20250925225052057](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250925225052107.png)

##### 3.1.1.实验需求

当前防火墙上存在三个虚拟系统分别是：`Public、VSYS_A、VSYS_B`。需要实现这三个虚拟系统后的网络互联互通，即`1.1.1.1、2.2.2.2、3.3.3.3`能够互访。

防火墙的`G1/0/0、G1/0/1、G1/0/2`属于`Trust`区域，`Virtual-if`接口都属于`Untrust`区域。

------

##### 3.1.2.实验演示

**防火墙开启虚拟系统功能：**

```
[FW1]vsys enable
```

**创建虚拟系统并分配接口：**

```
[FW1]vsys name VSYS_A	# 创建虚拟系统
[FW1-vsys-VSYS_A]assign interface g1/0/0	# 将物理接口划分到虚拟系统
[FW1-vsys-VSYS_A]quit

[FW1]vsys name VSYS_B
[FW1-vsys-VSYS_B]assign interface g1/0/1
[FW1-vsys-VSYS_B]quit
```

**根系统的配置：**

```
[FW1]firewall zone trust 
[FW1-zone-trust]add interface g1/0/2
[FW1-zone-trust]quit

[FW1]firewall zone untrust 
[FW1-zone-untrust]add interface Virtual-if 0
[FW1-zone-untrust]quit

[FW1]interface g1/0/2
[FW1-GigabitEthernet1/0/2]ip add 13.1.1.2 30
[FW1-GigabitEthernet1/0/2]quit

[FW1]ip route-static 0.0.0.0 0 13.1.1.1
[FW1]ip route-static 1.1.1.1 32 vpn-instance VSYS_A
[FW1]ip route-static 2.2.2.2 32 vpn-instance VSYS_B

[FW1-policy-security]rule name hufang	
[FW1-policy-security-rule-1_to_3]source-zone trust untrust 	
[FW1-policy-security-rule-1_to_3]destination-zone trust untrust 
[FW1-policy-security-rule-1_to_3]action permit
[FW1-policy-security-rule-1_to_3]quit
[FW1-policy-security]quit
```

**虚拟系统VSYS_A的配置：**

```
[FW1]switch vsys VSYS_A	# 切换到虚拟系统视图
<FW1-VSYS_A>sys

[FW1-VSYS_A]interface g1/0/0
[FW1-VSYS_A-GigabitEthernet1/0/0]ip add 11.1.1.2 30
[FW1-VSYS_A-GigabitEthernet1/0/0]quit

[FW1-VSYS_A]firewall zone trust 
[FW1-VSYS_A-zone-trust]add int g1/0/0
[FW1-VSYS_A-zone-trust]quit

[FW1-VSYS_A]firewall zone untrust 	
[FW1-VSYS_A-zone-untrust]add int Virtual-if 1
[FW1-VSYS_A-zone-untrust]quit

[FW1-VSYS_A]ip route-static 0.0.0.0 0 11.1.1.1
[FW1-VSYS_A]ip route-static 3.3.3.3 32 public

[FW1-VSYS_A]security-policy 
[FW1-VSYS_A-policy-security]rule name hufang	
[FW1-VSYS_A-policy-security-rule-hufang]source-zone trust untrust 
[FW1-VSYS_A-policy-security-rule-hufang]destination-zone trust untrust 
[FW1-VSYS_A-policy-security-rule-hufang]action permit
[FW1-VSYS_A-policy-security-rule-hufang]quit
[FW1-VSYS_A-policy-security]quit
```

**虚拟系统VSYS_B的配置：**

```
[FW1]switch vsys VSYS_B
<FW1-VSYS_B>sys

[FW1-VSYS_B]interface g1/0/1
[FW1-VSYS_B-GigabitEthernet1/0/1]ip add 12.1.1.2 30
[FW1-VSYS_B-GigabitEthernet1/0/1]quit

[FW1-VSYS_B]firewall zone trust 
[FW1-VSYS_B-zone-trust]add int g1/0/1
[FW1-VSYS_B-zone-trust]quit
	
[FW1-VSYS_B]firewall zone untrust 	
[FW1-VSYS_B-zone-untrust]add int Virtual-if 2
[FW1-VSYS_B-zone-untrust]quit

[FW1-VSYS_B]ip route-static 3.3.3.3 32 public
[FW1-VSYS_B]ip route-static 0.0.0.0 0 12.1.1.1

[FW1-VSYS_B]security-policy 
[FW1-VSYS_B-policy-security]rule name fuhang	
[FW1-VSYS_B-policy-security-rule-fuhang]source-zone trust untrust 
[FW1-VSYS_B-policy-security-rule-fuhang]destination-zone trust untrust  	
[FW1-VSYS_B-policy-security-rule-fuhang]action permit
[FW1-VSYS_B-policy-security-rule-fuhang]quit
[FW1-VSYS_B-policy-security]quit
```

**实现虚拟系统VSYS_A和VSYS_B互访的方式一：**

```
[FW1]ip route-static vpn-instance VSYS_A 2.2.2.2 32 vpn-instance VSYS_B

[FW1]ip route-static vpn-instance VSYS_B 1.1.1.1 32 vpn-instance VSYS_A
```

**互访测试：**

```
[AR1]ping 2.2.2.2
  PING 2.2.2.2: 56  data bytes, press CTRL_C to break
    Reply from 2.2.2.2: bytes=56 Sequence=1 ttl=253 time=30 ms
    Reply from 2.2.2.2: bytes=56 Sequence=2 ttl=253 time=20 ms
    Reply from 2.2.2.2: bytes=56 Sequence=3 ttl=253 time=20 ms
    Reply from 2.2.2.2: bytes=56 Sequence=4 ttl=253 time=20 ms
    Reply from 2.2.2.2: bytes=56 Sequence=5 ttl=253 time=30 ms

  --- 2.2.2.2 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 20/24/30 ms

[AR1]ping 3.3.3.3
  PING 3.3.3.3: 56  data bytes, press CTRL_C to break
    Reply from 3.3.3.3: bytes=56 Sequence=1 ttl=253 time=10 ms
    Reply from 3.3.3.3: bytes=56 Sequence=2 ttl=253 time=20 ms
    Reply from 3.3.3.3: bytes=56 Sequence=3 ttl=253 time=10 ms
    Reply from 3.3.3.3: bytes=56 Sequence=4 ttl=253 time=20 ms
    Reply from 3.3.3.3: bytes=56 Sequence=5 ttl=253 time=20 ms

  --- 3.3.3.3 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 10/16/20 ms
    
[AR2]ping 3.3.3.3
  PING 3.3.3.3: 56  data bytes, press CTRL_C to break
    Reply from 3.3.3.3: bytes=56 Sequence=1 ttl=253 time=30 ms
    Reply from 3.3.3.3: bytes=56 Sequence=2 ttl=253 time=20 ms
    Reply from 3.3.3.3: bytes=56 Sequence=3 ttl=253 time=20 ms
    Reply from 3.3.3.3: bytes=56 Sequence=4 ttl=253 time=20 ms
    Reply from 3.3.3.3: bytes=56 Sequence=5 ttl=253 time=30 ms

  --- 3.3.3.3 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 20/24/30 ms
```

```
<FW1>display firewall session table verbose vsys VSYS_A
<FW1>display firewall session table verbose vsys VSYS_B
<FW1>display firewall session table verbose
```

#### 3.2.实验二：虚拟系统与根系统通过引流表互访

![image-20250924152119715](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250925215245841.png)

通过引流表使`3.3.3.3`能够成功访问`1.1.1.1`和`2.2.2.2`，并观察现象。

由于基础配置一致，只演示引流表部分，配置前需要将`Public`的路由和安全策略删除

```
[FW1]firewall import-flow public 1.1.1.1 1.1.1.1 vpn-instance VSYS_A
[FW1]firewall import-flow public 2.2.2.2 2.2.2.2 vpn-instance VSYS_B
```

**现象：**

`AR3`主动`ping`其他两个地址时，正向触发引流表，`Public`不会生成会话表也不需要安全策略允许直接放行。进入到虚拟系统时，需要检查对应安全策略以及路由并生成会话。

`AR1`或`AR2`主动访问`AR3`时，反向出发引流表，`VSYS_A`根据安全策略、路由放行并生成会话。当数据被传输到`Public`时不需要安全策略直接根据路由指导报文转发，且不会生成会话表。

------

#### 3.3.实验三：旁挂式防火墙

![image-20250925231029503](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250925231029567.png)

如上图，内网业务网段分别有两个`vlan`其网关分别是`LSW2`和`LSW3`。内网中所有网络设备通过`OSPF`的方式打通网络。

- `LSW1`的`vlan 206、208、209`都属于`vpn-instance qyt`建立`OSPF 2`，`vlan 210、204`属于`public`建立`OSPF 1`。

- `FW1`的`vlan 204、206`都属于`vpn-instance qyt`建立`OSPF 2`。

------

##### 3.3.1.汇聚交换机配置

`LSW2`的基本配置演示：

```
[LSW2]vlan ba 208 10
[LSW2]int g0/0/2
[LSW2-GigabitEthernet0/0/2]port link acc
[LSW2-GigabitEthernet0/0/2]port def vlan 10
[LSW2-GigabitEthernet0/0/2]quit
[LSW2]int g0/0/1
[LSW2-GigabitEthernet0/0/1]port link trunk
[LSW2-GigabitEthernet0/0/1]port trunk all vlan 208
[LSW2-GigabitEthernet0/0/1]quit
[LSW2]int vlan 10
[LSW2-Vlanif10]ip add 192.168.10.254 24
[LSW2-Vlanif10]quit
[LSW2]int vlan 208
[LSW2-Vlanif208]ip add 12.1.1.2 30
[LSW2-Vlanif208]quit
```

`LSW3`的基本配置演示：

```
[LSW3]int g0/0/1
[LSW3-GigabitEthernet0/0/1]port link trunk
[LSW3-GigabitEthernet0/0/1]port trunk all vlan 209
[LSW3-GigabitEthernet0/0/1]quit
[LSW3]int g0/0/2
[LSW3-GigabitEthernet0/0/2]port link acc
[LSW3-GigabitEthernet0/0/2]port def vlan 20
[LSW3-GigabitEthernet0/0/2]quit
[LSW3]int vlan 209
[LSW3-Vlanif209]ip add 13.1.1.2 30
[LSW3-Vlanif209]quit
[LSW3]int vlan 20
[LSW3-Vlanif20]ip add 192.168.20.254 24
[LSW3-Vlanif20]quit
```

`LSW2`的`OSPF`配置演示：

```
[LSW2]ospf 1 router-id 2.2.2.2
[LSW2-ospf-1]area 0
[LSW2-ospf-1-area-0.0.0.0]network 12.1.1.2 0.0.0.0
[LSW2-ospf-1-area-0.0.0.0]network 192.168.10.254 0.0.0.0
[LSW2-ospf-1-area-0.0.0.0]quit
[LSW2-ospf-1]quit
```

`LSW3`的`OSPF`配置演示：

```
[LSW3]ospf 1 router-id 3.3.3.3
[LSW3-ospf-1]area 0
[LSW3-ospf-1-area-0.0.0.0]network 13.1.1.2 0.0.0.0
[LSW3-ospf-1-area-0.0.0.0]network 192.168.20.254 0.0.0.0
[LSW3-ospf-1-area-0.0.0.0]quit
[LSW3-ospf-1]quit
```

------

##### 3.3.2.核心交换机配置

基础配置：

```
[LSW1]ip vpn-instance qyt	#创建vpn实例
[LSW1-vpn-instance-qyt]ipv4-family
[LSW1-vpn-instance-qyt-af-ipv4]quit
[LSW1-vpn-instance-qyt]quit
[LSW1]vlan ba 208 209 204 206 210
[LSW1]int g0/0/1
[LSW1-GigabitEthernet0/0/1]port link trunk
[LSW1-GigabitEthernet0/0/1]port trunk all vlan 208
[LSW1-GigabitEthernet0/0/1]quit
[LSW1]int g0/0/2
[LSW1-GigabitEthernet0/0/2]port link trunk
[LSW1-GigabitEthernet0/0/2]port trunk all vlan 209
[LSW1-GigabitEthernet0/0/2]quit
[LSW1]int g0/0/3
[LSW1-GigabitEthernet0/0/3]port link trunk
[LSW1-GigabitEthernet0/0/3]port trunk all vlan 204
[LSW1-GigabitEthernet0/0/3]undo port trunk all vlan 1
[LSW1-GigabitEthernet0/0/3]quit
[LSW1]int g0/0/4
[LSW1-GigabitEthernet0/0/4]port link trunk
[LSW1-GigabitEthernet0/0/4]port trunk all vlan 206
[LSW1-GigabitEthernet0/0/4]undo port trunk all vlan 1
[LSW1-GigabitEthernet0/0/4]quit
[LSW1]int g0/0/5
[LSW1-GigabitEthernet0/0/5]port link acc
[LSW1-GigabitEthernet0/0/5]port def vlan 210
[LSW1-GigabitEthernet0/0/5]quit
[LSW1]int vlan 208
[LSW1-Vlanif208]ip bin vpn-instance qyt
[LSW1-Vlanif208]ip add 12.1.1.1 30
[LSW1-Vlanif208]quit
[LSW1]int vlan 209
[LSW1-Vlanif209]ip bin vpn qyt
[LSW1-Vlanif209]ip add 13.1.1.1 30
[LSW1-Vlanif209]quit
[LSW1]int vlan 210
[LSW1-Vlanif210]ip add 11.1.1.1 30
[LSW1-Vlanif210]quit
[LSW1]int vlan 204
[LSW1-Vlanif204]ip add 10.1.1.1 30
[LSW1-Vlanif204]quit
[LSW1]int vlan 206
[LSW1-Vlanif206]ip bin vpn qyt
[LSW1-Vlanif206]ip add 10.1.2.1 30
[LSW1-Vlanif206]quit
```

`OSPF`配置：

```
[LSW1]ospf 1
[LSW1-ospf-1]area 0
[LSW1-ospf-1-area-0.0.0.0]network 11.1.1.1 0.0.0.0
[LSW1-ospf-1-area-0.0.0.0]network 10.1.1.1 0.0.0.0
[LSW1-ospf-1-area-0.0.0.0]quit
[LSW1-ospf-1]quit
[LSW1]ospf 2 vpn-instance qyt
[LSW1-ospf-2]area 0
[LSW1-ospf-2-area-0.0.0.0]network 10.1.2.1 0.0.0.0
[LSW1-ospf-2-area-0.0.0.0]network 12.1.1.1 0.0.0.0
[LSW1-ospf-2-area-0.0.0.0]network 13.1.1.1 0.0.0.0
[LSW1-ospf-2-area-0.0.0.0]quit	
[LSW1-ospf-2]vpn-instance-capability simple 
在MCE（Multi-VPN-Instance CE）设备上部署OSPF VPN多实例时，如果有Type3、Type5或Type7 LSA中设置DN Bit，就会导致这些路由无法计算，因为OSPF进行路由计算会进行防环路检测。这种情况下，通过配置vpn-instance-capability simple命令可以取消OSPF路由环路检测，不检查DN Bit和Route-tag而直接计算出所有OSPF路由，Route-tag恢复为缺省值1。
[LSW1-ospf-2]quit
```

------

##### 3.3.3.防火墙配置

基础配置：
```
[FW1]vlan ba 204 206
[FW1]interface g1/0/0
[FW1-GigabitEthernet1/0/0]portswitch
[FW1-GigabitEthernet1/0/0]port link trunk
[FW1-GigabitEthernet1/0/0]port trunk all vlan 204
[FW1-GigabitEthernet1/0/0]undo port trunk all vlan 1
[FW1-GigabitEthernet1/0/0]quit
[FW1]int g1/0/1
[FW1-GigabitEthernet1/0/1]portswitch 
[FW1-GigabitEthernet1/0/1]port link trunk
[FW1-GigabitEthernet1/0/1]port trunk all vlan 206
[FW1-GigabitEthernet1/0/1]undo port trunk all vlan 1
[FW1-GigabitEthernet1/0/1]quit

[FW1]vsys enable 
[FW1]vsys name qyt
[FW1-vsys-qyt]assign vlan 204
[FW1-vsys-qyt]assign vlan 206
[FW1-vsys-qyt]quit

[FW1]interface vlan 206
[FW1-Vlanif206]ip add 10.1.2.2 30
[FW1-Vlanif206]quit
[FW1]interface vlan 204
[FW1-Vlanif204]ip add 10.1.1.2 30
[FW1-Vlanif204]quit

[FW1]switch vsys qyt
[FW1-qyt]firewall zone trust 
[FW1-qyt-zone-trust]add int vlan 206
[FW1-qyt-zone-trust]quit
[FW1-qyt]firewall zone untrust 
[FW1-qyt-zone-untrust]add int vlan 204
[FW1-qyt-zone-untrust]quit
```

安全策略：

```
[FW1-qyt]security-policy 
[FW1-qyt-policy-security]rule name in_to_out
[FW1-qyt-policy-security-rule-in_to_out]source-zone trust 
[FW1-qyt-policy-security-rule-in_to_out]destination-zone untrust 
[FW1-qyt-policy-security-rule-in_to_out]source-address 192.168.10.0 24
[FW1-qyt-policy-security-rule-in_to_out]source-address 192.168.20.0 24
[FW1-qyt-policy-security-rule-in_to_out]action permit
[FW1-qyt-policy-security-rule-in_to_out]quit
[FW1-qyt-policy-security]quit
```

`OSPF`配置：

```
[FW1]ospf 1 vpn-instance qyt
[FW1-ospf-1]vpn-instance-capability simple 
[FW1-ospf-1]area 0
[FW1-ospf-1-area-0.0.0.0]network 10.1.1.2 0.0.0.0
[FW1-ospf-1-area-0.0.0.0]network 10.1.2.2 0.0.0.0
[FW1-ospf-1-area-0.0.0.0]quit
[FW1-ospf-1]quit
```

------

##### 3.3.4.AR1配置

基础配置：

```
[AR1]int g0/0/0
[AR1-GigabitEthernet0/0/0]ip add 11.1.1.2 30
[AR1-GigabitEthernet0/0/0]quit
[AR1]int g0/0/1
[AR1-GigabitEthernet0/0/1]ip add 202.100.100.1 30
[AR1-GigabitEthernet0/0/1]quit

[AR1]ip route-sta 0.0.0.0 0 202.100.100.2
```

`OSPF`配置：

```
[AR1]ospf 1
[AR1-ospf-1]area 0
[AR1-ospf-1-area-0.0.0.0]network 11.1.1.2 0.0.0.0
[AR1-ospf-1-area-0.0.0.0]quit
[AR1-ospf-1]default-route-advertise 
[AR1-ospf-1]quit
```

`nat`配置：

```
[AR1]acl 2000
[AR1-acl-basic-2000]rule permit source 192.168.10.0 0.0.0.255
[AR1-acl-basic-2000]rule permit source 192.168.20.0 0.0.0.255
[AR1-acl-basic-2000]quit

[AR1]interface g0/0/1
[AR1-GigabitEthernet0/0/1]nat outbound 2000
[AR1-GigabitEthernet0/0/1]quit
```

##### 3.3.5.AR2配置

```
[AR2]int g0/0/0
[AR2-GigabitEthernet0/0/0]ip add 202.100.100.2 30
[AR2-GigabitEthernet0/0/0]quit
[AR2]int g0/0/1
[AR2-GigabitEthernet0/0/1]ip add 100.100.100.254 24
[AR2-GigabitEthernet0/0/1]quit
```

##### 3.3.6.验证

**AR1查看路由表：**

```
<AR1>dis ip routing-table protocol ospf
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 6        Routes : 6        

OSPF routing table status : <Active>
         Destinations : 6        Routes : 6

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       10.1.1.0/30  OSPF    10   2           D   11.1.1.1        GigabitEthernet
0/0/0
       10.1.2.0/30  OSPF    10   3           D   11.1.1.1        GigabitEthernet
0/0/0
       12.1.1.0/30  OSPF    10   4           D   11.1.1.1        GigabitEthernet
0/0/0
       13.1.1.0/30  OSPF    10   4           D   11.1.1.1        GigabitEthernet
0/0/0
   192.168.10.0/24  OSPF    10   5           D   11.1.1.1        GigabitEthernet
0/0/0
   192.168.20.0/24  OSPF    10   5           D   11.1.1.1        GigabitEthernet
0/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0
```

**client访问server**

![image-20250925235336823](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250925235336890.png)

**PC2 tracert测试：**

```
PC>tracert 100.100.100.100

traceroute to 100.100.100.100, 8 hops max
(ICMP), press Ctrl+C to stop
 1  192.168.20.254   16 ms  16 ms  31 ms
 2  13.1.1.1   31 ms  47 ms  47 ms
 3    *  *  *
 4  10.1.1.1   78 ms  78 ms  78 ms
 5    *  *  *
 6  202.100.100.2   94 ms  109 ms  125 ms
 7  100.100.100.100   110 ms  78 ms  109 ms
```

------

### 4.VRF

#### 4.1.背景

![image-20250926141722506](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250926141722577.png)

如上图，企业内部有生产和管理两个网络，这两张网络独占接入和汇聚层交换机，共享核心层交换机。核心交换机上同时连接了生产网络和管理网络的服务器群，两个网段均为`192.168.100.0/24`网段。

现在需要实现生产和管理网络内部的数据正常通信，同时隔离两张网络之间的通信。

##### 4.1.1.通过部署ACL实现

根据我们所学习过的内容，当前这种场景下可以通过`ACL`也就是过滤的方式实现。在核心交换机部署`ACL`，禁止生产和管理网络之间的互访流量。

但是这么做的缺点很明显：

- 配置繁琐，扩展性差。
- 无法解决两张网络使用重叠网段的问题，需要在部署时规避重叠网段。

![image-20250926142144669](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250926142144739.png)

------

##### 4.1.2.增加核心交换机

另一种方法是在现有设备的基础上再增加一台核心交换机，从物理层面进行隔离。但是会额外增加设备的投入（成本）。

![image-20250926142137058](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250926142137126.png)

##### 4.1.3.通过VRF技术实现

`VRF`又称为（`VPN Instance`），是一种虚拟化技术。在物理设备上创建多个`VRF`，每个`VRF拥有独立的接口、路由表和路由协议进程等。

![image-20250926144502514](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250926144502584.png)

![image-20250926144509508](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250926144509572.png)

------

#### 4.2.VRF的实现过程

`VRF`是对物理设备的一个逻辑划分，每个逻辑单元都被称为一个`VPN`示例，实例之间在路由层面是隔离的。

`VRF`实现过程如下：

1. 创建实例，并将三层接口（物理接口、子接口、`vlanif`）绑定到实例。
2. 配置与实例绑定的路由协议或静态路由。
3. 基于与实例绑定的接口和路由协议等建立实例路由表并基于实例路由表转发数据，实现实例间隔离。

![image-20250926144844236](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250926144844304.png)

#### 4.3.VRF基本配置命令

1. 创建`VPN`实例（进入`VPN`实例视图）：

   ```
   [Huawei] ip vpn-instance vpn-instance-name
   ```

2. 使能`VPN`实例的`IPv4`类型的路由通告和数据转发功能：

   ```
   [Huawei-vpn-instance-InstanceName] ipv4-family
   ```

   - 该命令用于使能`VPN`实例的地址族，缺省情况下未使能`VPN`实例的`IPv4`地址族，接口不能与未只能任何地址族的`VPN`实例绑定。

3. 将接口绑定到`VPN`实例：

   ```
   [Huawei-GigabitEthernet0/0/0] ip binding vpn-instance vpn-instance-name
   ```

   - 配置接口与`VPN`实例绑定后，或取消接口与`VPN`实例的绑定，都会清除该接口的`IP`地址、三层特性和`IP`相关的路由协议，如果需要应重新配置。

------

#### 4.4.实验举例

![image-20250926145908855](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250926145908925.png)

**创建VRF：**

```
[AR1]ip vpn-instance test1	
[AR1-vpn-instance-test1]ipv4-family
[AR1-vpn-instance-test1-af-ipv4]quit
[AR1-vpn-instance-test1]quit

[AR1]ip vpn-instance test2
[AR1-vpn-instance-test2]ipv4-family
[AR1-vpn-instance-test2-af-ipv4]quit
[AR1-vpn-instance-test2]quit
```

**绑定端口：**

```
[AR1]interface g0/0/0	
[AR1-GigabitEthernet0/0/0]ip binding vpn-instance test1
[AR1-GigabitEthernet0/0/0]ip add 192.168.100.254 24
[AR1-GigabitEthernet0/0/0]quit

[AR1]interface g0/0/1	
[AR1-GigabitEthernet0/0/1]ip binding vpn-instance test2
[AR1-GigabitEthernet0/0/1]ip add 192.168.200.254 24
[AR1-GigabitEthernet0/0/1]quit

[AR1]interface g0/0/2.1
[AR1-GigabitEthernet0/0/2.1]dot1q termination vid 10
[AR1-GigabitEthernet0/0/2.1]ip binding vpn-instance test1
[AR1-GigabitEthernet0/0/2.1]ip add 192.168.1.254 24
[AR1-GigabitEthernet0/0/2.1]arp broadcast enable
[AR1-GigabitEthernet0/0/2.1]quit

[AR1]interface g0/0/2.2
[AR1-GigabitEthernet0/0/2.2]dot1q termination vid 20	
[AR1-GigabitEthernet0/0/2.2]ip binding vpn-instance test2
[AR1-GigabitEthernet0/0/2.2]ip add 192.168.2.254 24
[AR1-GigabitEthernet0/0/2.2]arp broadcast enable
[AR1-GigabitEthernet0/0/2.2]quit
```

**交换机配置：**

```
[LSW1]vlan ba 10 20

[LSW1]interface Ethernet0/0/1
[LSW1-Ethernet0/0/1]port link trunk
[LSW1-Ethernet0/0/1]port trunk all vlan 10 20
[LSW1-Ethernet0/0/1]quit
	
[LSW1]int Ethernet0/0/2
[LSW1-Ethernet0/0/2]port link acc
[LSW1-Ethernet0/0/2]port def vlan 10
[LSW1-Ethernet0/0/2]quit
	
[LSW1]int Ethernet0/0/3
[LSW1-Ethernet0/0/3]port link acc
[LSW1-Ethernet0/0/3]port def vlan 20
[LSW1-Ethernet0/0/3]quit
```

**查看路由表：**

```
[AR1]display ip routing-table vpn-instance test1
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Tables: test1
         Destinations : 7        Routes : 7        

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

    192.168.1.0/24  Direct  0    0           D   192.168.1.254   GigabitEthernet
0/0/2.1
  192.168.1.254/32  Direct  0    0           D   127.0.0.1       GigabitEthernet
0/0/2.1
  192.168.1.255/32  Direct  0    0           D   127.0.0.1       GigabitEthernet
0/0/2.1
  192.168.100.0/24  Direct  0    0           D   192.168.100.254 GigabitEthernet
0/0/0
192.168.100.254/32  Direct  0    0           D   127.0.0.1       GigabitEthernet
0/0/0
192.168.100.255/32  Direct  0    0           D   127.0.0.1       GigabitEthernet
0/0/0
255.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0

[AR1]display ip routing-table vpn-instance test2
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Tables: test2
         Destinations : 7        Routes : 7        

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

    192.168.2.0/24  Direct  0    0           D   192.168.2.254   GigabitEthernet
0/0/2.2
  192.168.2.254/32  Direct  0    0           D   127.0.0.1       GigabitEthernet
0/0/2.2
  192.168.2.255/32  Direct  0    0           D   127.0.0.1       GigabitEthernet
0/0/2.2
  192.168.200.0/24  Direct  0    0           D   192.168.200.254 GigabitEthernet
0/0/1
192.168.200.254/32  Direct  0    0           D   127.0.0.1       GigabitEthernet
0/0/1
192.168.200.255/32  Direct  0    0           D   127.0.0.1       GigabitEthernet
0/0/1
255.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0
```

------

