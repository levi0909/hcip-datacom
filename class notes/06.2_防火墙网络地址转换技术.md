# 02_防火墙网络地址转换技术

### 0.NAT的分类

根据应用场景的不同，`NAT`可以分为以下三类：

- **源NAT(Source NAT)：**适用于用户通过私网地址访问`Internet`的场景。
- **目的NAT(Destination Nat)**：适用于用户通过公网地址访问私网服务器的场景。
- **双向NAT(Bidirectional NAT)：**适用于通信双方访问对方的时候目的地址都不是真实的地址，而是NAT转换后的地址的场景。

**NAT的优点：**

- 实现`IP`地址复用，节约宝贵的地址资源；
- 有效避免来自外网的攻击，对内网用户提供隐私保护，可以很大程度上提高网络安全性。

**NAT的缺点：**

- 网络监控难度加大；
- 限制某些具体应用。

------

### 1.源NAT

#### 1.1.技术背景

随着网络设备的数量不断增长，对`IPv4`地址的需求也不断增加，导致可用的公网`IPv4`地址空间已经耗尽。解决这个问题的方式是**分配可重复使用的私网地址给企业内部或家庭使用**。

但是**私网地址**是无法直接与公网进行通信的，也就是说当设备需要访问外部网络（微博、百度、抖音）时，发出的数据包在**公网上**必须拥有一个**公网地址**。

- **公网地址：**由专门的机构管理、分配，可以在`Internet`上直接通信的地址。
- **私有地址：**组织和个人可以任意使用，无法在`Internet`上直接通信，只能在内网使用的`IP`地址。
  - **A类：**`10.0.0.0 ~ 10.255.255.255`
  - **B类：**`172.16.0.0 ~ 172.31.255.255`
  - **C类：**`192.168.0.0 ~ 192.168.255.255`

**网络地址转换**就是一种当前流行的解决方法。

------

#### 1.2.源NAT原理

##### 1.2.1.什么是源nat？

当私网用户访问公网的报文到达网关设备后，如果网关设备上部署了`NAT`功能，设备将收到的报文的源`IP`地址转换为**公网地址**，端口号也转换为一个随机高端口，然后转发给公网设备。

在这个过程中，`NAT`设备可以用同一个公网地址来转换多个私网用户发过来的报文，通过端口号来区分不同的私网用户，从而达到**地址复用**的目的。`NAT`设备会使用`NAT`转换表来记录这个过程。

当公网回包到达`NAT`设备后，设备查找`NAT`转换表，将该数据包的**目的地址**转换为对应的私网地址和端口，然后转发给正确的私网设备。

![image-20250905210640916](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905211351012.png)

早期的`NAT`是指`Basic NAT`，`Basic Nat`在技术上实现比较简单，只支持地址转换，不支持端口转换。那么就代表`Basic Nat`只能实现私网地址和公网地址一对一转换，无法做到**公网地址复用**。所以，`Basic Nat`其实并没有解决`IPv4`短缺的问题。

现在我们真正在使用的源`NAT`技术实际上指的是`NAPT`，`NAPT`既支持地址转换也支持端口转换，允许多台私网主机共享一个公网`IP`地址访问公网，因此`NAPT`才是真正改善了`IPv4`地址短缺的技术。

------

#### 1.3.源NAT的类型

![源NAT分类](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905213430301.png)

**ICMP**协议是没有端口号的，所以在经过防火墙`NAT`后，会将`ICMP`报文中的`Identifier(BE)`字段记录下来，充当源端口，目的端口固定为`2048`。

![image-20250906204915459](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906204915512.png)

------

##### 1.3.1.No-PAT

` NAT No-PAT(No-Port Address Translation)`非端口地址转换，它是一种只转换地址，不转换端口，实现私网地址与公网地址一对一的地址转换方式。

它只适用于上网用户较少且公网地址与同是上网的用户数量相同的场景。

这种方式与`Basic`唯一不同的点在于，`Basic Nat`提前在`NAT`设备上将私网地址与公网地址做了绑定，只有绑定好的私网地址才能上网。

而`No-PAT`这种方式是，在`NAT`设备上提前规划了一个**公网地址池**，先到先得用完为止。

![image-20250905213809154](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905213809175.png)

------

**实验：**

在防火墙上配置`no-pat`实现网络地址转换：

![image-20250906202814184](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906202814220.png)

1. 防火墙配置：

   1. 配置接口地址：

      ```
      [FW1]int g1/0/0
      [FW1-GigabitEthernet1/0/0]ip add 192.168.10.254 24
      [FW1-GigabitEthernet1/0/0]quit
      
      [FW1]int g1/0/1
      [FW1-GigabitEthernet1/0/1]ip add 192.168.20.254 24
      [FW1-GigabitEthernet1/0/1]quit
      ```

   2. 配置接口区域：

      ```
      [FW1]firewall zone trust
      [FW1-zone-trust]add interface g1/0/0
      [FW1-zone-trust]quit
      
      [FW1]firewall zone untrust
      [FW1-zone-untrust]add interface g1/0/1
      [FW1-zone-untrust]quit
      ```

   3. 配置安全策略：

      ```
      [FW1]security-policy 
      [FW1-policy-security]rule name in_to_out
      [FW1-policy-security-rule-in_to_out]source-zone trust 
      [FW1-policy-security-rule-in_to_out]destination-zone untrust 
      [FW1-policy-security-rule-in_to_out]action permit
      [FW1-policy-security-rule-in_to_out]quit
      [FW1-policy-security]quit
      ```

   4. 配置`nat-pool`：

      - **local**：代表生成的`Server-map`表中包含**安全区域**参数，严格匹配收到回包的接口安全区域，如果不一致则拒绝。
      - **Global**：代表生成的`Server-map`表中不包含**安全区域**参数，不对回包的安全区域进行检查。

      ```
      [FW1]nat address-group group1
      [FW1-address-group-group1]mode no-pat local
      [FW1-address-group-group1]section 192.168.20.10 192.168.20.20
      [FW1-address-group-group1]quit
      ```

   5. 配置`nat-policy`：

      ```
      [FW1]nat-policy 
      [FW1-policy-nat]rule name internet	
      [FW1-policy-nat-rule-internet]source-zone trust	
      [FW1-policy-nat-rule-internet]destination-zone untrust
      [FW1-policy-nat-rule-internet]source-address 192.168.10.0 24
      [FW1-policy-nat-rule-internet]action source-nat address-group group1
      [FW1-policy-nat-rule-internet]quit
      [FW1-policy-nat]quit
      ```

2. 配置两台`PC`的地址与网关

   - `PC1`

     ![image-20250906203758016](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906203758063.png)

   - `PC2`

     ![image-20250906203811544](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906203811591.png)

3. 测试！

   1. `PC1` ping `PC2`：

      ![image-20250906203921346](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906203921386.png)

   2. 抓包查看

      ![image-20250906203956081](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906203956131.png)

   3. 查看`server-map`

      ![image-20250906204020668](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906204020716.png)

   4. 查看会话表

      ![image-20250906204036059](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906204036112.png)

------

##### 1.3.2.NAPT

`NAPT(Network Address and Port Translation)`网络地址端口转换，是一种同时转换地址和端口，实现多个私网地址共用一个或多个公网地址的地址转换方式。适用于公网地址数量少，需要上网的私网用户数量大的场景。

![image-20250905214634924](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905214634953.png)

`NAPT`和`No-PAT`有一个相似点，它们都需要提前在`NAT`设备上配置**公网地址池**，将其分配给私有用户。不同点是`NAPT`公网地址池中的地址可以**复用**。

![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905214822528.png)

**实验：**

![image-20250906202814184](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906205256969.png)

与`No-PAT`实验中只有一个地方不一致，`nat group`的模式：

```
[FW1]nat-policy 
[FW1-policy-nat]rule name internet
[FW1-policy-nat-rule-internet]undo action source-nat 
[FW1-policy-nat-rule-internet]quit
[FW1-policy-nat]quit

[FW1]nat address-group group1
[FW1-address-group-group1]mode pat
[FW1-address-group-group1]quit

[FW1]nat-policy 
[FW1-policy-nat]rule name internet
[FW1-policy-nat-rule-internet]action source-nat address-group group1
[FW1-policy-nat-rule-internet]quit
[FW1-policy-nat]quit
```

![image-20250906205608309](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906205608366.png)

从上图可看出，`NAPT`是不会生成`Server-map`的，只会有会话表。

- `No-PAT`有`Server-map`：因为它创建了一个稳定、可预测的端口映射，防火墙可以基于此生成一条固定的、允许反向访问的策略。
- `NAPT`没有`Server-map`：因为它创建的是动态、随机、与会话绑定的临时映射，默认拒绝所有未被请求的入站连接，因此不需要也无法生成固定的反向访问策略。

------

##### 1.3.3.Easy IP

`Easy IP`的实现原理和`NAPT`相同，同时转换`IP`地址和端口，区别在于`Easy IP`没有地址池的概念，使用设备出接口的公网地址作为`NAT`转换后的地址。适用于不具备固定公网`IP`地址的场景。例如：拨号上网（`PPPoE`）。

![image-20250905215006643](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250905215006669.png)

**实验：**

![image-20250906202814184](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906211652638.png)

与之前两个实验不同，`Easy IP`方式更为简单，不需要配置`NAT GROUP`：

```
[FW1]nat-policy
[FW1-policy-nat]undo rule name internet
[FW1-policy-nat]rule name easy_ip
[FW1-policy-nat-rule-easy_ip]action source-nat easy-ip
[FW1-policy-nat-rule-easy_ip]quit
[FW1-policy-nat]quit
```

![image-20250906211900785](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906211900843.png)

![image-20250906211929944](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906211930000.png)

`Easy-IP`方式也不会生成`server-map`。

------

##### 1.3.4.三元组NAT

**前言：**

之前提到的如`NAPT`属于**五元组**`NAT`，在这种方式下**外部设备**无法通过访问**经过NAT转换后的源地址和源端口**与**内部设备**通信。

因为`NAT`设备上的`NAT`转换表明确记录了源地址、目的地址、源端口、目的端口与协议。所以，这种情况下你想要实现上述情况除非外部设备发出的报文的**源地址和端口**与`NAT`转换表上一致。

说的再简单一些，因为**五元组**`NAT`需要严格匹配的内容中包含了**外部主机的地址和端口**。

此时，我们就可以使用**三元组**`NAT`来实现我们的目的。

**三元组：**

1. 内网源`IP`地址
2. 内网源端口号
3. 传输层协议

------

**案例分析：**

当我们需要使用到`P2P`软件时，传统的五元组`NAT`无法满足我们的需求。

![image-20250906200938314](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906200938352.png)

`PC1`运行了`P2P`应用，它首先会和`P2P`服务器进行交互（登录、认证等操作），服务器会记录客户端的地址和端口。当`PC2`需要和`PC1`通信（下载文件等），服务器会将`PC1`的地址和端口发送给`PC2`，然后`PC2`就会向`PC1`发送请求，并从`PC1`上下载文件。

这个过程中，防火墙会将`PC1`发给服务器的数据包进行`NAT`转换，此时`P2P`服务器记录的是转换后的地址和端口号。此时，因为`PC1`从来没有主动访问过`PC2`，所以在防火墙上没有任何记录（`NAT`、`Server-map`、会话表），所以防火墙不会允许`PC2`访问`PC1`的。

**三元组的解决方法：**

1. 支持外网主动访问：
   - 无论内网主机是否主动访问过某个外网主机，只要外网主机知道内网主机`NAT`转换后的地址和端口，就可以主动向该内网主机发起访问。因为三元组和五元组的区别。
2. 动态对外端口一致性：
   - 内网主机做`NAT`转换后的地址和端口将在一段时间内保持不变，在此时间段内，内网主机固定使用此`NAT`后地址和端口访问任意外网主机，任意外网主机也可以通过此`NAT`后地址和端口访问内网主机。

**实现原理：**

从实现角度上看，三元组`NAT`是通过`Serve-map`使外网主机可以主动访问内网主机，并保证`NAT`转换关系在一段时间内保持不变。

------

**实验：**

三台`PC`均为`openEuler`服务器，通过`ensp`桥接实现连接到防火墙的两个接口。通过在防火墙上部署三元组`NAT`，实现`PC1`访问`PC2`指定端口后，`PC3`主动访问`PC1`转换后的地址与端口，通过抓包查看是否有数据包被防火墙放行。

![image-20250906194757199](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906194757234.png)

1. 拓扑图配置如下：

   - `ENSP`拓扑图如下：

   ![image-20250906194038509](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906194038533.png)

   - `Cloud1`配置：

   ![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906194023753.png)

   - `Cloud2`配置：

   ![image-20250906194031228](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906194031266.png)

2. 防火墙配置如下：

   1. 配置接口地址：

      ```
      [FW1]int g1/0/0
      [FW1-GigabitEthernet1/0/0]ip add 192.168.10.254 24
      [FW1-GigabitEthernet1/0/0]quit
      
      [FW1]int g1/0/1
      [FW1-GigabitEthernet1/0/1]ip add 192.168.20.254 24
      [FW1-GigabitEthernet1/0/1]quit
      ```

   2. 配置接口区域：

      ```
      [FW1]firewall zone trust
      [FW1-zone-trust]add int g1/0/0
      [FW1-zone-trust]quit
      
      [FW1]firewall zone untrust 
      [FW1-zone-untrust]add int g1/0/1
      [FW1-zone-untrust]quit
      ```

   3. 配置安全策略：

      ```
      [FW1]security-policy 
      [FW1-policy-security]rule name in_to_out
      [FW1-policy-security-rule-in_to_out]source-zone trust 
      [FW1-policy-security-rule-in_to_out]destination-zone untrust 	
      [FW1-policy-security-rule-in_to_out]action permit
      [FW1-policy-security-rule-in_to_out]quit
      [FW1-policy-security]quit
      ```

   4. 配置三元组`NAT`：

      ```
      [FW1]nat address-group group1
      [FW1-address-group-group1]mode full-cone global 
      [FW1-address-group-group1]section 192.168.20.50
      [FW1-address-group-group1]quit
      
      [FW1]nat-policy 
      [FW1-policy-nat]rule name internet
      [FW1-policy-nat-rule-internet]action source-nat address-group group1
      [FW1-policy-nat-rule-internet]quit
      [FW1-policy-nat]quit
      ```

3. 配置内网服务器与两台外网服务器，安装`socat`。

   ```
   [root@PC1 ~]# yum install socat -y
   [root@PC2 ~]# yum install socat -y
   [root@PC3 ~]# yum install socat -y
   ```

4. 提前抓包，开始测试：

   1. `PC2`使用`socat`命令监听端口`UDP100`：

      ```
      [root@PC2 ~]# socat -v UDP4-RECVFROM:100,fork -
      ```

   2. `PC1`使用`socat`命令与`PC2`的`UDP100`通信：

      ```
      [root@PC1 ~]# echo "Hello" | socat - UDP4:192.168.20.100:100  
      ```

   3. 在外网卡抓包查看

      ![image-20250906200302388](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906200302431.png)

   4. 在防火墙上查看`server-map`

      ![image-20250906200334577](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906200334639.png)

   5. `PC3`使用`socat`命令与`NAT`后的端口通信：

      ```
      [root@PC3 ~]# echo "Hello" | socat - UDP4:192.168.20.50:10240  
      ```

   6. 查看内网接口抓包

      ![image-20250906200434863](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906200434903.png)

   7. 查看防火墙上的`session table`：

      ![image-20250906200617617](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906200617654.png)

------

### 2.目的NAT与NAT Server

#### 2.1.目的NAT

当公司内网部署了多台服务器，需要使公网用户可以顺利访问到这些私网服务器时，就可以使用**目的NAT**。

目的`NAT`是指当防火墙接收到访问其指定**公网地址和端口的报文时**，对报文中的目的地址和端口进行转换。通过目的`NAT`技术将公网`IP`地址转换成私网`IP`地址，使公网用户可以利用公网地址访问内部`Server`。

当外网用户访问内部`Server`时，防火墙的处理过程如下：

- 当外网用户访问内网`Server`的报文到达防火墙时，防火墙将报文的目的`IP`地址由公网转换为私网地址。
- 当回程报文返回至防火墙时，防火墙再将报文的源地址由私网地址转换为公网地址。

![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250906215634634.png)

实际上目的`NAT`的工作方式类似于代理，防火墙上先映射出一个虚拟`IP`地址供外网访问，并在防火墙上使用地址池的方式定义内网主机。当防火墙接收到访问**虚拟地址**的数据包后，将该数据包的目的地址修改为地址池中的地址。

**功能：**

1. 一对一静态映射。
2. 一对多动态映射。
3. 端口重定向。

根据转换后的目的地址是否固定，目的`NAT`分为静态和动态。

------

##### 2.1.1.实验

![image-20250907160153253](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907160153301.png)

1. 防火墙接口配置：

   ```
   [FW1]int g1/0/0
   [FW1-GigabitEthernet1/0/0]ip add 192.168.1.254 24
   [FW1-GigabitEthernet1/0/0]quit
   
   [FW1]int g1/0/1
   [FW1-GigabitEthernet1/0/1]ip add 203.0.113.254 24
   [FW1-GigabitEthernet1/0/1]quit
   ```

2. 防火墙接口区域配置：

   ```
   [FW1]firewall zone dmz
   [FW1-zone-dmz]add int g1/0/0
   [FW1-zone-dmz]quit
   
   [FW1]fire zone untrust
   [FW1-zone-untrust]add int g1/0/1
   [FW1-zone-untrust]quit
   ```

3. 防火墙安全策略配置：

   ```
   security-policy
    rule name policy1
     source-zone untrust
     destination-zone dmz
     action permit
   ```

4. 防火墙目的地址池配置：

   ```
   destination-nat address-group group1 0
    section 192.168.1.2 192.168.1.2
   ```

5. 防火墙`NAT`策略配置：

   ```
   nat-policy
    rule name policy_nat1
     source-zone untrust
     destination-address 192.51.100.2 mask 255.255.255.255
     service http
     service icmp
     action destination-nat static address-to-address address-group group1
   ```

6. 服务器配置：

   ![image-20250907155544858](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907155545630.png)

7. 客户端配置：

   ![image-20250907155600610](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907155600668.png)

8. 测试：

   ![image-20250907155627559](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907155627617.png)

9. 会话表：

   ![image-20250907155700007](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907155700060.png)

10. 抓包：

    1. 外网：

       ![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907155755827.png)

    2. 内网：

       ![image-20250907155807791](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907155807852.png)

------

#### 2.2.NAT Server

`NAT Server`也称为**静态映射**，是一种转换报文目的`IP`地址的方式，它提供了公网地址和私网地址的映射关系，实现外部网络用户通过公网地址访问私网内部服务器的需求。

##### 2.2.1.与目的NAT的区别

你现在肯定有一个疑问，好像`NAT Server`和目的`NAT`没有啥区别啊？

首先我们要确定一点`NAT Server`严格意义上属于目的`NAT`中的一种，它们的目的都是为了让公网用户可以顺利访问到私网的服务器，但是工作原理和类型不太一样。

- **实现效果：**

  - **目的NAT：**这种方式类似于“代理”或者“负载均衡”，当收到一个来自于外网的数据包，一旦访问的是虚拟地址，我就会将这个数据包的目的地址修改为提前定义好的**范围**中的地址。通过这个范围就可以实现负载均衡了，分担服务器的流量。在负载均衡的场景下是**一对多的**，一个公网`VIP`对多个内网服务器。

  - **NAT Server：**这种方式类似于“绑定”或者“映射”，是**一对一**，提前将内网中的某一个地址或者端口与防火墙的外网地址和端口进行一对一绑定。当收到一个来自于外网并且访问特定端口的数据包后，防火墙会根据**映射表**将该数据包的目的地址或端口修改为提前设置后的内网地址或端口，并转发。

  - 如果你的目的`NAT`和我上面的例子一样，只是一对一的，那实现的**效果**和**NAT Server**是一致的。

- **设计意图：**
  - **NAT Server**：这个术语的设计初衷就是**专门用于发布内网服务器**。因此，它的配置界面和命令通常更直观，直接让你填写“内网IP”、“内网端口”、“外网IP”、“外网端口”。它隐含着“一对一静态映射”的假设。
  - **目的NAT (DNAT)**：这个术语更底层、更通用。它是一个**广义的技术工具**，你可以用这个工具实现多种功能：
    - 功能一：**一对一静态映射**（此时完全等于NAT Server）。
    - 功能二：**一对多动态映射**（负载均衡）。
    - 功能三：**灵活的端口重定向**（例如，将访问公网IP `8080`端口的流量，转发到内网服务器 `192.168.1.100`的 `80`端口）。

------

##### 2.2.2.详解

`NAT Server`有如下三种场景：

- **一对一地址映射：**该场景中将私网服务器的地址与`NAT`服务器的公网地址进行绑定，当外网主机访问任何`NAT`服务器的端口时都会被修改目的`IP`并转发。
- **一对多端口映射：**该场景中将多个私网服务器的地址与端口和`NAT`服务器的不同端口进行绑定，当外网主机访问`NAT`服务器的指定端口时会被修改地址（或端口）并转发到指定服务器的端口。

- **端口重定向：**该场景的主要目的是隐藏内网服务器的端口或实现修改端口的目的。

------

**一对一地址映射：**

![image-20250907224904897](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907224904938.png)

此时，公司只有一台服务器需要被公网访问。在防火墙上配置静态一对一地址映射，将内网服务器`192.168.10.1`与防火墙公网地址`223.23.1.3`绑定。当公网客户端向防火墙的公网地址`223.23.1.3`的任何端口发起连接，都会被防火墙将数据包的目的地址修改为`192.168.10.1`，并转发到内网服务器。

------

**一对多端口映射：**

![image-20250907225215774](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907225215837.png)

此时，公司内部有多台服务器同时需要被公网客户端访问。防火墙根据服务器映射的端口，将`192.168.10.1`的`80`端口绑定到公网地址的`80`端口，将`192.168.10.2`的`53`端口绑定到公网地址的`53`端口。

当防火墙收到公网客户端向`80`端口发起的连接，就会修改数据包的目的地址并转发到指定服务器。所以，此时防火墙可以根据不同服务器的端口进行转发，做到同时服务于多个内网服务器，通过端口进行区分。但需要注意防火墙上映射出来的端口是不能冲突的，比如这两台服务器不能同时映射在防火墙的`80`端口。

------

**端口重定向：**

![image-20250907225546175](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907225546240.png)

出于对内网服务器的保护与防端口冲突的考虑，防火墙上映射内部服务器端口时进行修改。例如内部服务器的暴露的端口是`666`，而防火墙在进行绑定时，将自身的`443`与其映射。

此时，公网主机访问防火墙的`443`端口时，就会被防火墙同时修改地址与端口并进行转发。

这么做的其中一个好处是，有一些协议，例如`Web`。它们在互联网上访问时是有固定端口的，出于多种原因内部服务器在部署`Web`服务时不能用规定的`443`端口，那么就可以在防火墙上做**端口重定向**。

------

##### 2.2.3.一对一地址映射

![image-20250907230100382](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907230100438.png)

**防火墙配置：**

1. **接口地址配置：**

   ```
   [FW1]int g1/0/0
   [FW1-GigabitEthernet1/0/0]ip add 192.168.10.254 24
   [FW1-GigabitEthernet1/0/0]quit
   
   [FW1]int g1/0/1
   [FW1-GigabitEthernet1/0/1]ip add 202.100.100.254 24
   [FW1-GigabitEthernet1/0/1]quit
   ```

2. **接口区域配置：**

   ```
   [FW1]firewall zone dmz
   [FW1-zone-dmz]add interface g1/0/0
   [FW1-zone-dmz]quit
   
   [FW1]firewall zone untrust 	
   [FW1-zone-untrust]add interface g1/0/1
   [FW1-zone-untrust]quit
   ```

3. **安全策略配置：**

   ```
   [FW1]security-policy 
   [FW1-policy-security]rule name out_to_in	
   [FW1-policy-security-rule-out_to_in]source-zone untrust 
   [FW1-policy-security-rule-out_to_in]destination-zone dmz	
   [FW1-policy-security-rule-out_to_in]action permit
   [FW1-policy-security-rule-out_to_in]quit
   ```

4. **NAT Server 配置：**

   ```
   nat server global 202.100.100.254 inside 192.168.10.100
   ```

**服务器配置：**

![image-20250907230622547](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907230622621.png)

![image-20250907230626491](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907230626560.png)

**客户端配置：**

![image-20250907230636022](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907230636087.png)

![image-20250907230640766](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907230640833.png)

**抓包分析**

- **公网接口**

  ![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907231037662.png)

- **私网接口**

  ![image-20250907231051721](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907231051796.png)

**会话表与Server-map**

![image-20250907231200224](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907231200274.png)

**反向：**

根据上述`Server-map`我们会发现，此时`NAT`允许内网主机`192.168.10.100`访问任何外网主机，一旦内网主机发起请求就会被防火墙将私网地址转换成`202.100.100.254`。

但是，你需要额外为该需求做一条**安全策略**：

```
[FW1-policy-security]rule name in_to_out
[FW1-policy-security-rule-in_to_out]source-zone dmz
[FW1-policy-security-rule-in_to_out]destination-zone untrust 	
[FW1-policy-security-rule-in_to_out]action permit
[FW1-policy-security-rule-in_to_out]quit
```

当我们在`Server`上`ping client`：

![image-20250907231853561](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907231853631.png)

**查看会话表：**

![image-20250907231732451](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907231732515.png)

**抓包：**

![image-20250907231809150](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907231809217.png)

------

##### 2.2.4.一对多端口映射与端口重定向

![image-20250907232049054](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907232049122.png)

此时`Server1`和`Server2`都开放`80`端口部署`WEB Server`。在防火墙上配置`NAT Server`，将防火墙的外网地址的`80`端口与`Server1`的`80`端口进行绑定，将防火墙的外网地址的`8080`端口与`Server2`的`80`端口进行绑定。

**其他配置不变，只需要修改防火墙的NAT Server：**

```
[FW1]undo nat server all
Warning:Undo all NAT server will affect the system's normal service.
Continue? [Y/N]:y

[FW1]nat server protocol tcp global 202.100.100.254 80 inside 192.168.10.100 80 

[FW1]nat server protocol tcp global 202.100.100.254 8080 inside 192.168.10.200 8
0
```

**Server2的配置：**

![image-20250907232500088](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907232500166.png)

![image-20250907232503643](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907232503712.png)

------

###### **客户端访问Server1：**

![image-20250907232534633](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907232534708.png)

**会话表与Server-map**

![image-20250907232607702](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907232607771.png)

![image-20250907232654116](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907232654193.png)

**抓包：**

- **公网**

  ![image-20250907232819602](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907232819668.png)

- **内网**

  ![image-20250907232834517](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907232834587.png)

**反向流量：**依旧可以在不做源NAT的情况下访问公网

![image-20250907232919744](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907232919816.png)

------

###### 客户端访问Server2：

![image-20250907233459478](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907233459554.png)

**会话表与Server-map**

![image-20250907233544419](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907233544507.png)

**抓包：**

- **公网**

  ![image-20250907233616687](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907233616753.png)

- **内网**

  ![image-20250907233630800](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907233630870.png)

**反向流量：**

![image-20250907233703843](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907233703916.png)

------

### 3.NAT ALG

`NAT ALG`（`Application Layer Gateway`，NAT应用层网关）在NAT实现中为特殊的应用程序提供透明转换的功能。

很多应用层协议在协议报文中包含了用户`IP`地址、端口等信息，当做`NAT`转换时，由于未对协议报文内部的`IP`地址、端口做识别和转换，可能造成协议交互失败。当使用`NAT ALG`技术时，`NAT`不仅针对`IP`地址、端口号做地址端口映射，同时还对应用层协议中包含的`IP`地址、端口号等做同步转换。

![image-20250907235618623](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907235618687.png)

`NAT ALG`支持的应用协议有`ICMP`、基于`UDP`的`SIP`、基于`TCP`的`RTSP、PPTP、DNS`和`FTP`。

**以FTP主动模式为例：**

客户端会在一个应用层的命令里对服务器说：“请你接下来把数据发送到我的 **`192.168.1.100:20`** 端口吧。”

但是`192.168.1.100`是客户端的**内网地址**，服务器在公网上根本找不到这个地址，连接自然就会失败。

如果没有ALG，NAT设备只修改了IP和TCP头，但对FTP命令中的内嵌地址 `192.168.1.100:20`毫不知情，原封不动地传给了服务器。服务器试图向这个私有地址发起连接，必然失败。

------

#### 3.1.工作模式

NAT ALG 作为一个深度包检测（DPI）模块，嵌入在NAT设备（如防火墙、路由器）中。它的工作流程如下：

1. **识别**：ALG会监听特定的知名端口（如FTP的21端口），识别出经过的设备是FTP、SIP等需要它处理的协议流量。
2. **解析**：它**深度解析**这些协议的应用层数据包，“读懂”里面的内容。
3. **翻译**：当发现包内嵌了IP地址或端口信息时（如FTP的PORT命令），ALG会将其中的**内网IP和端口**替换为NAT转换后的**公网IP和端口**。
   - 在上面的FTP例子中，ALG会把 `192.168.1.100:20`**翻译成** `203.0.113.10:5678`，然后再发给FTP服务器。
4. **同步**：同时，ALG会动态地**开放一个临时通道**（在防火墙上创建一个临时的ASPF策略或server-map表项），允许FTP服务器发起的反向数据连接能够顺利进入内网。
5. **反向操作**：对于从公网发往内网的报文，ALG也会进行反向的翻译，将公网地址翻译回对应的私网地址。

**最终结果**：FTP服务器收到的是它能够访问的公网地址，连接得以成功建立。整个过程对客户端和服务器来说都是透明的，它们感知不到NAT的存在。

![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250907235844608.png)

1. 私网主机和公网FTP服务器之间通过TCP三次握手成功建立控制连接；
2. 控制连接建立后，私网主机向FTP服务器发送Port报文，报文中携带私网主机指定的数据连接的目的地址和端口，用于通知服务器使用该地址和端口和自己进行数据连接；
3. Port报文在经过支持ALG特性的NAT设备时，报文载荷中的私网地址和端口会被转换成对应的公网地址和端口，也就是设备收到的Port报文载荷中的私网地址192.168.0.10转换成公网地址1.1.1.1，端口1024转换成5000；
4. 公网的FTP服务器收到Port报文后，解析其内容，并向私网主机发起数据连接，该数据连接的目的地址为1.1.1.1，端口为5000；
5. 由于该目的地址是一个公网地址，在经过NAT设备时可以被转换为内部主机的私有地址和端口，因此后续的数据连接就能够成功建立，从而实现私网主机对公网服务器的访问。

------

#### 3.2.NAT ALG支持FTP

FTP协议有被动模式和主动模式两种方式，按照其特点称为PORT模式（主动）、PASV模式（被动）。FTP的NAT ALG需要按照如下两种分类对FTP协议进行处理：

- FTP服务器在外部网络、使用PORT方式访问，需要开启FTP ALG；FTP服务器在内部网络、使用PORT方式访问，不需要开启FTP ALG。
- FTP服务器在外部网络、使用PASV方式访问，不需要开启FTP ALG；FTP服务器在内部网络、使用PASV方式访问，需要开启FTP ALG。

##### 3.2.1.NAT ALG FTP主动模式

![image-20250908002721678](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908002721753.png)

此场景为`FTP`的主动模式：

![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908002753310.jpeg)

**防火墙配置：**

```
nat server 2 protocol tcp global 202.100.100.254 ftp inside 192.168.10.100 ftp
```

**Server配置：**

![image-20250908002906496](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908002906576.png)

![image-20250908002912315](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908002912392.png)

**客户端配置：**

![image-20250908002923330](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908002923403.png)

![image-20250908002928426](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908002928511.png)

**抓包对比FTP载荷：**

- **私网：**

![image-20250908003055151](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908003055249.png)

- **公网：**

![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908003028872.png)

此时，可以看出经过防火墙后`FTP`的载荷确实被防火墙修改过了。

**抓包对比后续端口：**

- **私网：**

![image-20250908003222849](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908003222936.png)

- **公网：**

![image-20250908003329057](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908003329141.png)

经过上述查看，发现后续的数据包交互，端口确实也经过防火墙的修改，且与之前的载荷一致。

------

### 4.路由黑洞

![image-20250908145013651](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908145013702.png)

**以`NAPT`为例**

1. 防火墙配置接口地址：

```
[FW1]int g1/0/0
[FW1-GigabitEthernet1/0/0]ip add 192.168.10.254 24
[FW1-GigabitEthernet1/0/0]quit

[FW1]int g1/0/1
[FW1-GigabitEthernet1/0/1]ip add 202.100.100.2 30
[FW1-GigabitEthernet1/0/1]quit
```

2. 防火墙配置接口区域：

```
[FW1]firewall zone trust 
[FW1-zone-trust]add int g1/0/0
[FW1-zone-trust]quit

[FW1]firewall zone untrust 
[FW1-zone-untrust]add int g1/0/1
[FW1-zone-untrust]quit
```

3. 防火墙配置静态路由：

```
[FW1]ip route-static 0.0.0.0 0 202.100.100.1
```

4. 防火墙配置安全策略：

```
[FW1]security-policy 
[FW1-policy-security]rule name in_to_out	
[FW1-policy-security-rule-in_to_out]source-zone trust 
[FW1-policy-security-rule-in_to_out]destination-zone untrust 
[FW1-policy-security-rule-in_to_out]action permit
[FW1-policy-security-rule-in_to_out]quit
[FW1-policy-security]quit

[FW1]security-policy 
[FW1-policy-security]rule name any	
[FW1-policy-security-rule-any]action permit
[FW1-policy-security-rule-any]quit
[FW1-policy-security]quit
```

5. 防火墙配置`nat group`：

```
[FW1]nat address-group group1
[FW1-address-group-group1]mode no-pat local	
[FW1-address-group-group1]section 202.100.100.10 202.100.100.20
[FW1-address-group-group1]quit
```

6. 防火墙配置`nat policy`

```
[FW1]nat-policy 
[FW1-policy-nat]rule name internet	
[FW1-policy-nat-rule-internet]source-zone trust 	
[FW1-policy-nat-rule-internet]destination-zone untrust 
[FW1-policy-nat-rule-internet]source-address 192.168.10.0 24
[FW1-policy-nat-rule-internet]action source-nat address-group group1
[FW1-policy-nat-rule-internet]quit
[FW1-policy-nat]quit
```

7. 路由器配置接口地址和路由：

```
[AR2]int g0/0/0
[AR2-GigabitEthernet0/0/0]ip add 202.100.100.1 30
[AR2-GigabitEthernet0/0/0]quit

[AR2]int g0/0/1
[AR2-GigabitEthernet0/0/1]ip add 192.168.20.254 24
[AR2-GigabitEthernet0/0/1]quit

[AR2]ip route-static 0.0.0.0 0 202.100.100.2
```

8. 使用公网`PC`访问防火墙地址池地址：

![image-20250908145508884](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908145508964.png)

此时，使用`-c`参数指定只发送一个`icmp`报文，抓包如下：

![image-20250908145537682](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20250908145537785.png)

此时，在防火墙和路由之间产生了环路。原因是防火墙的`nat`地址与自身不在一个网段，会根据默认路由转发数据包到`AR1`，而`AR1`也只能通过默认路由再将该数据包转发会防火墙，至此环路产生。

解决这个问题的方法很简单，在防火墙上针对`NAT`地址池中的地址配置黑洞路由。

```
[FW1]ip route-static 202.100.100.12 32 null 0
```

再去`PC2`测试，发现只能抓到一个`ICMP`包被发到防火墙后，防火墙没有进行任何回应，这是因为匹配到了黑洞路由，被丢弃了。

配置黑洞路由还有一个好处是，防火墙可以通过动态路由协议将黑洞路由引入进去，传递给其他路由器。
