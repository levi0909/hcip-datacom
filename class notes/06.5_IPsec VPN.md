# 05_IPsec VPN

### 1.VPN技术简介

`VPN(Virtual Private Network)`虚拟专用网，是一种在**公用网络**上建立专用网络的技术。它被称为虚拟专用网的原因是建立`VPN`的两个节点之间没有像传统专用网那样使用**端到端**的物理链路，而是架构在**公用网络**之上的逻辑网络，用户数据通过**逻辑隧道**传输。

![IPsec VPN](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251002191125064.png)

`VPN`技术的应用场景主要分为如下几种：

1. **总部与分支结构互联：**
   - 这是**站点到站点**`VPN`的经典场景。公司将总部、各个分公司、数据中心的局域网通过`VPN`连接在一起，形成一个大型、统一的私有网络。
2. **员工远程办公：**
   - **远程接入**`VPN`场景。出差或居家员工通过个人电脑或手机上的`VPN`客户端接入公司内网，访问资源。
3. **云资源接入：**
   - 现在企业将业务部署在云端（华为云、阿里云）。为了管理云上服务器，企业内部与云上服务器建立`VPN`实现混合云架构。

------

#### 1.1.VPN技术的分类

##### 1.1.1.根据建设者分类

这种分类根据`VPN`网络端点设备由**运营商**提供，还是由企业自己提供来划分：

- **VPN专线：**租用运营商专线搭建企业`VPN`网络，例如`MPLS VPN`专线，增值服务需要付费。

  ![image-20251002193349597](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251002193349627.png)

- **用户自建VPN：**基于`Internet`建立企业`VPN`网络，包括`GRE、L2TP、IPsec、SSL VPN`等。这种方案不需要支付专线费用，另外由于是企业自主搭建，所以在网络控制方面有更多的主动权、方便进行网络调整。

  ![image-20251002193622470](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251002193622497.png)

------

##### 1.1.2.根据组网方式分类

下面这两种方式主要区别在于针对的对象以及用户是否有感知。

- **远程接入VPN：**适合出差员工`VPN`拨号接入的场景。员工可以在任何能够接入公网的地方，通过远程拨号介入企业内网，从而访问内网资源。

  ![image-20251002193945060](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251002193945087.png)

- **站点到站点VPN：**适用于公司两个或以上的异地机构的局域网互联。

  ![image-20251002193953208](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251002193953229.png)

------

##### 1.1.3.按照工作层次进行分类

此种分类方式指按照`VPN`技术实现的网络层次进行分类：

- 基于数据链路层的VPN：`L2TP`、`L2F`、`PPTP`、`VPLS`等。
- 基于网络层的VPN：`GRE`、`IPsec`。
- 基于应用层的VPN：`SSL`。

------

### 2.GRE隧道

上世纪九十年代初`Internet`已经快速发展了，越来越多的资源被网络所连接。但是慢慢的私有网络就面临了几个问题：

1. 私有`IP`网络之间无法直接通过`Internet`互通。

   ![image-20251003001841320](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003001841375.png)

2. 异种网络（`IPX、AppleTalk`）之间无法通过`Internet`直接进行通信。

   ![image-20251003001922771](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003001922804.png)

3. 私网之间部署的动态路由无法跨越`Internet`。

在这种背景下`1994`年`GRE`协议问世了，它被`IETF`纳入之后，`RFC`标号为`RFC1701`和`RFC1702`。

`GRE(General Routing Encapsulation)`即通用路由封装协议，使用**封装**的方式使私网之间的数据报文成功在`Internet`上传输。

------

#### 2.1.详解

##### 2.1.1.封装

![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003005241231.png)

**封装**指的是在原有报文的`IP`头部上再嵌套`GRE`头部和一个新的`IP`头。网络封装技术，其基本的构成要素可以分为三个部分：乘客协议、封装协议、运输协议。

- **乘客协议：**
  - 数据本身，也就是你想要传输的内容。
- **封装协议：**
  - 用来保护和包装这个货物的保险箱（**外壳**）。
- **运输协议：**
  - 承载保险箱（**外壳**）在网络上传输的运输工具/道路。

封装协议和运输协议在当今基本都是`IP`协议，而封装协议可以有很多很多中，`GRE`类似于一个纸箱子虽然能起到一定的保护作用，但是非常脆弱。

![image-20251003003348961](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003003348996.png)

##### 2.1.2.封装过程

首先，封装时会在原有网络层（`IP`头）前面添加`GRE`头，然后在`GRE`头前面再加上新的`IP`头。新的`IP`头一般是公网地址，那么就可以将报文通过`Internet`进行传输了。

![私有网络通过GRE隧道互连](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003005258542.png)

封装这个操作是通过**逻辑接口**来实现的，这个逻辑接口叫做`Tunnel`接口，也就是隧道接口。由于`Tunnel`接口是一个**通用**的隧道接口，所以`GRE`协议在使用这个接口的时候，需要手动设置为`GRE`协议。

![image-20251003003937728](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003003937764.png)

1. 企业的私网流量到达防火墙的入接口，防火墙查询路由表对此流量进行转发。
2. 防火墙根据路由查找结果，将此流量引导到`Tunnel`接口进行`GRE`封装。
3. 封装后的`GRE`报文再次查找路由进行流量转发。
4. 防火墙根据路由查找结果，找到出接口，并将流量发送到`Internet`。

------

##### 2.1.3.解封装过程

隧道对端在接收到报文之后，先根据该报文目的地址判断是不是发给自己的（通过运输协议）。然后再判断这个报文是不是`GRE`报文，运输协议（新的`IP`头）中的`Protocol`字段表示了内层协议类型，`47`表示是`GRE`报文。

![image-20251003004732858](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003004732900.png)

------

#### 2.2.实验

![image-20251003010114850](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003010114888.png)

`FW1`与`AR2`通过`GRE`隧道建立虚拟网络，通过`OSPF`协议将两端局域网打通。

##### 2.2.1.基础配置

**防火墙：**

```
[FW1]firewall zone trust 
[FW1-zone-trust]add int g1/0/0
[FW1-zone-trust]quit	
[FW1]firewall zone untrust 
[FW1-zone-untrust]add int g1/0/1
[FW1-zone-untrust]quit

[FW1]security-policy 
[FW1-policy-security]rule name sec_policy1	
[FW1-policy-security-rule-sec_policy1]source-zone local 
[FW1-policy-security-rule-sec_policy1]destination-zone untrust 	
[FW1-policy-security-rule-sec_policy1]source-zone untrust 	
[FW1-policy-security-rule-sec_policy1]destination-zone local 		
[FW1-policy-security-rule-sec_policy1]action permit
[FW1-policy-security-rule-sec_policy1]quit

[FW1]interface g1/0/0
[FW1-GigabitEthernet1/0/0]ip add 192.168.10.254 24
[FW1-GigabitEthernet1/0/0]quit
[FW1]int g1/0/1
[FW1-GigabitEthernet1/0/1]ip add 11.1.1.1 30
[FW1-GigabitEthernet1/0/1]quit

[FW1]ip route-static 0.0.0.0 0 11.1.1.2
```

**路由器：**

```
[AR1]int g0/0/0
[AR1-GigabitEthernet0/0/0]ip add 11.1.1.2 30
[AR1-GigabitEthernet0/0/0]quit
[AR1]int g0/0/1
[AR1-GigabitEthernet0/0/1]ip add 12.1.1.1 30
[AR1-GigabitEthernet0/0/1]quit

[AR2]int g0/0/0
[AR2-GigabitEthernet0/0/0]ip add 12.1.1.2 30
[AR2-GigabitEthernet0/0/0]quit
[AR2]int g0/0/1
[AR2-GigabitEthernet0/0/1]ip add 192.168.20.254 24
[AR2-GigabitEthernet0/0/1]quit
[AR2]ip route-static 0.0.0.0 0 12.1.1.1
```

##### 2.2.2.配置Tunnel接口

**防火墙：**

```
[FW1]interface Tunnel 0
[FW1-Tunnel0]tunnel-protocol gre
[FW1-Tunnel0]ip add 100.100.100.1 24	
[FW1-Tunnel0]source 11.1.1.1	
[FW1-Tunnel0]destination 12.1.1.2
[FW1-Tunnel0]quit

[FW1]firewall zone dmz
[FW1-zone-dmz]add interface Tunnel 0
[FW1-zone-dmz]quit

[FW1]security-policy 
[FW1-policy-security]rule name tunnel
[FW1-policy-security-rule-tunnel]source-zone trust dmz	
[FW1-policy-security-rule-tunnel]destination-zone trust dmz
[FW1-policy-security-rule-tunnel]action permit
[FW1-policy-security-rule-tunnel]quit
[FW1-policy-security]quit

[FW1]interface Tunnel 1	
[FW1-Tunnel1]service-manage ping permit 
[FW1-Tunnel1]quit
```

**路由器：**

```
[AR2]interface Tunnel 0/0/0
[AR2-Tunnel0/0/0]tunnel-protocol gre
[AR2-Tunnel0/0/0]ip add 100.100.100.2 24	
[AR2-Tunnel0/0/0]source 12.1.1.2
[AR2-Tunnel0/0/0]destination 11.1.1.1
[AR2-Tunnel0/0/0]quit
```

##### 2.2.3.OSPF

**防火墙：**

```
[FW1]ospf 1
[FW1-ospf-1]area 0
[FW1-ospf-1-area-0.0.0.0]network 100.100.100.1 0.0.0.0
[FW1-ospf-1-area-0.0.0.0]network 192.168.10.254 0.0.0.0
[FW1-ospf-1-area-0.0.0.0]quit
[FW1-ospf-1]quit
```

**路由器：**

```
[AR2]ospf 1
[AR2-ospf-1]area 0
[AR2-ospf-1-area-0.0.0.0]network 100.100.100.2 0.0.0.0
[AR2-ospf-1-area-0.0.0.0]network 192.168.20.254 0.0.0.0
[AR2-ospf-1-area-0.0.0.0]quit
[AR2-ospf-1]quit
```

##### 2.2.4.验证

```
[AR2]dis ospf peer brief 

	 OSPF Process 1 with Router ID 12.1.1.2
		  Peer Statistic Information
 ----------------------------------------------------------------------------
 Area Id          Interface                        Neighbor id      State    
 0.0.0.0          Tunnel0/0/0                      192.168.10.254   Full        
 ----------------------------------------------------------------------------

[AR2]display ip routing-table protocol ospf
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Public routing table : OSPF
         Destinations : 1        Routes : 1        

OSPF routing table status : <Active>
         Destinations : 1        Routes : 1

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

   192.168.10.0/24  OSPF    10   1563        D   100.100.100.1   Tunnel0/0/0

OSPF routing table status : <Inactive>
         Destinations : 0        Routes : 0
         
PC>ping 192.168.20.1

Ping 192.168.20.1: 32 data bytes, Press Ctrl_C to break
Request timeout!
From 192.168.20.1: bytes=32 seq=2 ttl=126 time=31 ms
From 192.168.20.1: bytes=32 seq=3 ttl=126 time=16 ms
From 192.168.20.1: bytes=32 seq=4 ttl=126 time=16 ms
From 192.168.20.1: bytes=32 seq=5 ttl=126 time=31 ms

--- 192.168.20.1 ping statistics ---
  5 packet(s) transmitted
  4 packet(s) received
  20.00% packet loss
  round-trip min/avg/max = 0/23/31 ms
```

![image-20251003011811108](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003011811148.png)

![image-20251003011818877](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003011818910.png)

------

##### 2.2.5.GRE Key身份校验

我们可以在两端的`Tunnel`中设置`Gre Key`，设备在发送`GRE`报文时，会在`GRE`头中携带这个`Key`字段。对端收到后检查`Gre`报文中的`Key`是否与本隧道配置的`Key`一致。

```
[FW1-Tunnel0]gre key 123456
```

![image-20251003012444099](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003012444136.png)

------

##### 2.2.6.防止篡改

为了防止报文`Internet`传输过程中被其他用户恶意篡改，需要使用到`checksum`，`Gre`封装报文时，会根据报文信息计算校验和，并将这个校验和插入到`Checksum`。对端收到报文后，也会进行校验和计算并于报文中携带的校验和进行比较，如果结果一致则接收，不一致则丢弃。

```
[FW1-Tunnel0]gre checksum
```

![image-20251003012734499](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003012734539.png)

------

##### 2.2.7.Keepalive

`Gre`的安全机制可以实现隧道两端的互信，并保证报文传输的完整性。但是如果隧道对端设备出现故障时如何感知呢？`Gre`是一种无状态类型的隧道，本端不会维护对端的状态（没有探测报文）。

`Gre`隧道提供了保活机制（`Keepalive`），`GRE`隧道会周期性地向对端发送`Keepalive`报文，以检测对端状态。如果`Gre`隧道对端出现问题，则隧道源地`Tunnel`接口状态会设置为`Down`。对端是否支持`Keepalive`功能不影响本端地`Keepalive`功能。

![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003013257482.png)

```
[AR2-Tunnel0/0/0]keepalive period 5 retry-times 3	# 每5秒发送一次Keepalive，重试3次后认为对端失效
[FW1-Tunnel0]keepalive period 5 retry-times 3
```

![image-20251003013120618](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003013120663.png)

![image-20251003013222315](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003013222363.png)

------

#### 2.3.缺点

虽然刚刚介绍了非常非常多的功能，但是`Gre`隧道是没有加密功能地，也就是说它传输的数据别人可以看的一清二楚。所以我们在实际使用中很少单纯使用`Gre`而是将其与其他`VPN`技术组合起来一起使用。

------

### 3.IPsec

`IPsec(Internet Protocol Security)`是为`IP`网络提供安全性的协议和服务的**集合**，它是`VPN`中常用的一种技术。由于`IP`报文本身没有集成任何安全特性，`IP`数据包在公用网络中传输可能会面临**伪造、窃取和篡改的风险**。

通信双方通过`IPsec`建立一条隧道，`IP`数据包通过`IPsec`隧道进行加密传输，有效保证了数据在不安全的网络环境中传输的安全性。

#### 3.1.IPsec（数据通道）

`IPsec`包括如下基本概念：安全联盟、安全协议、安全机制、封装模式。

##### 3.1.1.安全联盟

###### 3.1.1.1.**SA简介：**

![image-20251004001218375](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005154919755.png)

`SA`（`Security Association`，安全联盟）是`IPsec`的基础，也是`IPsec`的本质。`IPsec`在两个端点之间提供安全通信，这类端点被称为`IPsec`对等体。`SA`是`IPsec`对等体间对某些要素的约定，例如，使用的安全协议（AH、ESP或两者结合使用）、协议报文的封装模式（传输模式或隧道模式）、认证算法（`HMAC-MD5、HMAC-SHA1、SM3等`）、加密算法（`DES、3DES、AES、SM`等）、特定流中保护数据的共享密钥以及密钥的生存时间等。

`SA`是单向的，在两个对等体之间的双向通信，最少需要两个`SA`来分别对两个方向的数据流进行安全保护。同时，如果两个对等体希望同时使用`AH`和`ESP`来进行安全通信，则每个对等体都会针对每一种协议来构建一个独立的`SA`。

`SA`由一个三元组来唯一标识，这个三元组包括`SPI`（`Security Parameter Index`，安全参数索引）、目的`IP`地址和安全协议号。其中，`SPI`是用于标识`SA`的一个32比特的数值，它在`AH`和`ESP`头中传输。

****

###### 3.1.1.2.**SA生成方式：**

`SA`有手工配置和`IKE`自动协商两种生成方式：

- **手工方式：**通过命令行配置`SA`的所有信息。该方式的配置比较复杂，而且不支持一些高级特性（例如定时更新密钥），优点是可以不依赖`IKE`而单独实现`IPsec`功能。该方式主要用于需要安全通信的对等体数量较少，或小型静态的组网环境中。

- **IKE自动协商方式：**对等体之间通过IKE协议自动协商生成`SA`，并由`IKE`协议维护该`SA`。该方式的配置相对比较简单，扩展能力强。在中、大型的动态网络环境中，推荐使用`IKE`自动协商建立`SA`。

****

###### 3.1.1.3.SA老化机制：

**老化时间：**

- 手工方式建立的`SA`永不老化。通过`IKE`协商建立的`SA`具有生存时间，当生存时间到达后，旧的`SA`会被删除。
- `IKE`协商建立的`SA`在生存时间到达前会提前协商一个新的`SA`来替换旧的`SA`。从`SA`建立到启动新`SA`协商的这段时间是软超时时间。
  - 缺省情况下，系统会基于`SA`的生存时间使用默认算法计算一个软超时时间。系统允许配置一个软超时缓冲来控制软超时时间，计算公式为：软超时时间=生存时间－软超时缓冲。

**IKE老化形式：**

- 基于时间的生存时间，定义了一个`SA`从建立到删除的时间。

- 基于流量的生存时间，定义了一个`SA`允许处理的最大流量。

- 可同时存在基于时间和基于流量两种方式的`SA`生存时间，只要其中一种到达，就会删除旧的`SA`。

****

##### 3.1.2.加密算法

`IPsec`对数据的加密使用**对称加密算法**，一方在传递消息之前，先用**加密算法和加密密钥**对数据进行加密。另一方在收到消息后，使用相同的加密算法和加密密钥，逆向将消息恢复为**原始数据**。

对称加密用的密钥称作共享密钥，类似于一把锁有两把一模一样的钥匙。一端将物品放到箱子里并用钥匙将锁锁住，当物品被传送到另一端，需要用同样的钥匙将锁打开。

![image-20251003230107234](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003230107296.png)

举个例子，我和你是敌对组织的两个成员，我们经常有书信往来，为了防止书信在传输的过程中被截获并查看到具体内容，我们事先协商好相同的加密算法和加密密钥。假设我要向你发布命令，那我将要传递的信息的字符替换位置，再插入我们协商好的密钥即可。

对称加密算法主要包括以下三种：

![image-20251003231937913](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003231937968.png)

------

##### 3.1.3.认证算法

当接收方收到数据包后，需要对**数据完整性**和**对方身份**进行验证。验证的过程需要用到**签名**，签名类似于古代的兵符，具有无法**伪造**的特点。

![](https://th.bing.com/th/id/R.b110fee561afecd7bd8e60b94179bcf2?rik=JgRypq0kcY8ikA&riu=http%3a%2f%2fk.sinaimg.cn%2fn%2fsinacn%2fw555h424%2f20180304%2f5c69-fxipenm7939354.jpg%2fw700d1q75cms.jpg&ehk=EITq0DdAlkuQaKIRjhUZn0rT8%2f9DlCfnD5STbkpBk1U%3d&risl=&pid=ImgRaw&r=0)

**过程如下：**

1. **发送方**：
   - 对原始 **IP报文** 进行加密，得到**密文**。
   - 将**密文**和**共享的对称验证密钥**通过哈希算法（如HMAC）计算，得到**签名**。
   - 将 **密文 + 签名** 发送给接收方。
2. **接收方**：
   - 收到数据包后，将**密文**和**签名**分离。
   - 使用相同的**共享验证密钥**和哈希算法，对收到的**密文**进行计算，得出**本地签名**。
   - 将**本地签名**与对端发来的**签名**进行比对。
     - **如果不一致**：立即丢弃数据包。**（此时还未解密）**
     - **如果一致**：则同时证明了 **①数据完整性** 和 **②对方身份**。
   - **验证通过后**，再使用**共享的解密密钥**对**密文**进行解密，得到原始数据。

![image-20251003233920223](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251003233920284.png)

------

##### 3.1.4.安全协议

想要实现上述的加密与验证功能，需要借助协议与算法：

| 协议/算法类型    | 功能            | 在 IPsec 中的角色                                       | 好比建筑中的...                                              |
| :--------------- | :-------------- | :------------------------------------------------------ | :----------------------------------------------------------- |
| **AH**           | **认证**        | 提供数据完整性验证和数据源认证                          | **质量检查员**：检查材料是否被掉包，并确认送货人身份。但不负责给材料遮盖上（不加密）。 |
| **ESP**          | **认证 + 加密** | 提供数据完整性验证、数据源认证**和**数据加密            | **带质检的保密运输队**：既把材料用箱子封起来（加密），又检查箱子是否被打开过（认证）。 |
| **对称加密算法** | **加密**        | 为 ESP 协议提供**机密性**，对数据内容进行加密           | **密码锁和保险箱**：用来实际锁住数据，只有有钥匙的人能打开。 |
| **哈希算法**     | **完整性**      | 是 **AH 和 ESP 实现认证功能**的核心工具（用于生成HMAC） | **独一无二的指纹/密封蜡**：生成一个独特的“指纹”，任何改动都会导致指纹失效。 |

------

**AH认证头（IP协议号51）：**

- **核心功能**：**认证**。它提供：
  - **数据完整性校验**：确保数据在传输过程中没有被篡改。
  - **数据源认证**：确保数据来自正确的发送方。
- **不提供**：**机密性**。**AH 不加密数据**，数据是以明文形式传输的。
- **与哈希算法的关系**：
  - AH 的实现极度依赖**哈希算法**。它使用一种叫做 **HMAC** 的技术。
  - **工作流程**：发送方对整个IP数据包（包括IP头部的大部分字段和数据载荷）以及一个**共享的密钥**进行计算，生成一个哈希值（称为 ICV）。接收方进行同样的计算并比对ICV。如果IP包或数据有任何变动，或者发送方没有正确的密钥，ICV 就会对不上，数据包会被丢弃。
  - **常用算法**：MD5, SHA-1, SHA-256 等哈希算法被用于 HMAC 计算。
- **现状**：由于 AH 不加密，且对IP头认证导致与NAT不兼容（因为`AH`需要对整个`IP`头进行认证，而`NAT`需要修改`IP`头部中的`IP`地址），在现代网络中**已很少使用**。ESP 的功能完全可以覆盖并超越它。

------

**ESP封装安全载荷（IP协议号50）：**

- **核心功能**：**加密 + 认证**。它是目前 IPsec 的**主力协议**。

  - **机密性**：通过**对称加密算法**对数据载荷进行加密。
  - **数据完整性校验 & 数据源认证**：和 AH 一样，通过**哈希算法**计算 HMAC 来实现。

- **与对称加密算法和哈希算法的关系**：

  ESP 同时使用这两种算法，分工明确：

  1. **加密（机密性）**：使用**对称加密算法**（如 AES）对原始数据（载荷）进行加密，得到密文。
  2. **认证（完整性）**：使用**哈希算法**（如 SHA-256）对**加密后的密文**（以及ESP头的一部分）计算 HMAC，生成一个签名。

  **注意一个关键点**：在ESP中，**认证操作发生在加密之后**。接收方收到数据包后，也是**先验证签名，再解密**。这样做效率更高、更安全：如果签名验证失败（数据被篡改），就直接丢弃包，无需进行耗时的解密操作。

| **安全协议**   | **AH**                 | **ESP**            |
| -------------- | ---------------------- | ------------------ |
| 协议号         | 51                     | 50                 |
| 数据完整性校验 | 支持（验证整个IP报文） | 支持（不验证IP头） |
| 数据源验证     | 支持                   | 支持               |
| 数据加密       | 不支持                 | 支持               |
| 防报文重放攻击 | 支持                   | 支持               |
| NAT穿越        | 不支持                 | 支持               |

------

**对称加密算法：**

- **角色**：为 ESP 提供**加密**功能的“劳动力”。
- **特点**：加密和解密使用**同一把密钥**。在IPsec中，这把密钥是通过IKE协议协商出来的。
- **常用算法**：
  - **AES**：**黄金标准**，速度快，安全性高。是当前最主流的选择。
  - 3DES：较老的算法，速度慢，作为AES的过渡备选。
  - DES：已过时，绝对不安全。

------

**哈希算法：**

- **角色**：为 **AH 和 ESP 的认证功能**提供核心计算能力。
- **特点**：将任意长度的数据映射为固定长度的“指纹”（哈希值）。具有单向性（无法从哈希值反推原始数据）和抗碰撞性（很难找到两个不同的数据产生相同的哈希值）。
- **在IPsec中的用法**：不是直接使用哈希算法，而是使用其加强版——**HMAC**。HMAC 在计算哈希时引入了密钥，确保了只有拥有密钥的双方才能生成或验证正确的哈希值，从而实现了身份认证。
- **常用算法**：
  - **SHA-256, SHA-384**：**当前推荐**，安全性高。
  - SHA-1：较弱，已不推荐在新系统中使用。
  - MD5：已破解，绝对不安全。

------

##### 3.1.5.封装模式

![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005155141092.png)

在理解了加密、验证、算法、和协议后，我们来看看**封装**，我们大家都知道`VPN`的最终实现或者数据包的加密最终都是依赖于封装实现的，目的是能够隐藏原本的数据包，让他变的“人畜无害”。`IPsec`有两种封装模式：

- **隧道模式：**

  - 在隧道模式下，`AH`头或`ESP`头被插到原始`IP`头之前，另外生成一个新的`IP`报文头放到`AH`头或`ESP`头之前。

  - 这样做可以隐藏原本的`IP`报文头（私网），新的`IP`报文头会填写隧道两端的地址（公网`IP`），如此一来**封装**后的报文就可以穿越公网了。

  ![image-20251004000451037](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251004000451102.png)

- **传输模式：**

  - 在传输模式中，`AH`头或`ESP`头被插入到`IP`头与传输层协议之间。
  - 传输模式不能被称作是`VPN`因为其根本就没有穿越公网的能力，只适用于**点到点**传输下用来**加密**数据。

  ![image-20251004000812150](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251004000812211.png)

------

#### 3.2.IKE协议（管理通道）

通过上文我们了解到，用`IPsec`保护一个数据包之前，必须先建立一个**安全联盟**`IPsec SA`。`IPsec SA`包含了数据包加密时使用到的封装模式、加密算法和**对称密钥**。

`IPsec SA`可以手工建立或动态建立。`IKE`协议为`IPsec`提供了自动建立`IPsec SA`的服务，优点如下：

1. `IKE`协议首先会在通信双方之间建立一个**安全通道**`IKE SA`，并在此安全通道的保护下协商建立`IPsec SA`，降低了手工配置的复杂度，简化`IPsec`的配置和维护工作。
2. `IKE`协议通过`DH(Diffie-Hellman)`交换技术，通过一系列的交换，使通信双方计算出**共享密钥（对称密钥）**。在`IKE`的`DH`交换过程中，每次计算和产生的结果都是不相关的，保证了**共享密钥**会定期变化，不容易被破解。

**总结：**`IPsec`通过`IKE`协议实现`IPsec SA`自动协商、建立，且定期自动变化。减少`IPsec SA`建立的复杂性，并降低**共享密钥（对称密钥）**一尘不变导致的风险。

![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005095555297.png)

**作用：**

- `IKE`协议的作用是保证安全的情况下自动协商建立`IPsec SA`。

------

##### 3.2.1.IKE的安全机制

`IKE`可以在不安全的网络上安全地认证通信双方地身份、分发密钥以及建立`IPsec SA`，具有以下几种安全机制：

1. **身份认证：**确保对端身份可信
   - `IKE`的身份认证机制用于确认通信双方的身份。设备支持三种认证方法：预共享密钥认证、`RSA`数字签名认证和`DSA`数字签名认证。
     - **预共享密钥认证：**通信双方通过共享的密钥认证对端身份。
     - **数字签名认证：**通信双方使用由`CA`颁发的数字证书向对端证明自己的身份。
2. **DH算法：**通过算法确保黑客无法破解生成的密钥
   - `DH`算法是一种公共密钥算法，它允许通信双方在不传输密钥的情况下通过交换一些数据，计算出共享的密钥。即使黑客截获了双方用于计算密钥的所有交换数据，由于其复杂度很高，也不足以算出双方的密钥。
3. **PFS特性：**增加一次`DH`，确保黑客即使截获了相关信息也无法反推出密钥。
   - `PSF`是一种安全特性，它解决了密钥之间相互无关性的需求。由于`IKE`第二阶段协商需要从第一节点协商出的密钥材料中衍生出用于`IPsec SA`的密钥，若攻击者能够破解`IKE SA`的一个密钥，则会非常容易掌握其衍生出的任何`IPsec SA`的密钥。
   - 使用`PFS`特性后，`IKE`第二阶段协商过程中会增加一次`DH`交换，使得`IKE SA`的密钥和`IPsec SA`的密钥之间没有派生关系，即使`IKE SA`的其中一个密钥被破解，也不会影响它协商出的其他密钥的安全性。

------

##### 3.2.2.IKE协议版本

1. **IKEv1：**
   - `IKEv1`协议利用`ISAKMP`互联网安全联盟和密钥管理协议定义密钥交换的过程，是一种对安全服务进行协商的手段。
2. **IKEv2：**
   - `IKEv2`是`IKEv1`的增强版本。`IKEv2`与`IKEv1`相同，具有一套保护机制，可以在不安全的网络上安全地进行身份认证、密钥分发、建立`IPsec SA`。
   - 相对于`IKEv1`，`IKEv2`需要交互的报文数量较少，且`IKEv2`具有更强的抗攻击能力和密钥交换能力。

------

##### 3.2.3.IKEv1协商建立IPsec SA

![image-20251005225136620](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005225136725.png)

###### 3.2.3.1.基本过程

`IKEv1`使用了两个阶段为`IPsec`进行密钥协商以及建立`SA`：

1. **第一阶段：**通信双方彼此建立了一个已通过双方身份认证和对通信数据安全保护的通道，即建立一个`IKEv1 SA`。
2. **第二阶段：**使用在第一阶段建立的`IKEv1 SA`为`IPsec`协商安全服务，即为`IPsec`协商`IPsec SA`，建立用于最终的`IP`数据安全传输的`IPsec SA`。

![image-20251005225105193](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005225105299.png)

------

###### 3.2.3.2.协商模式

第一阶段的`IKEv1`协商模式包括如下三种方式：

- **主模式（Main Mode）**
- **野蛮模式（Aggressive Mode）**
- **国密主模式（GM-Main Mode）：**在主模式的基础上必须使用数字证书的方式进行身份认证。

------

###### 3.2.3.3.主模式协商过程

**主模式的配置：**

1. **加密算法：**定义用于加密`IKE`协商消息的对称加密算法。
2. **认证算法：**定义用于计算哈希值（`HASH`）和验证消息完整性的散列算法。
3. **DH组：**定义用于`Diffie-Hellman`密钥交换的数学组（强度）。组号越大，通常安全性越高，但计算开销也越大。
4. **认证方法：**定义验证对方身份的方式。（预共享密钥或证书）。
5. **对等体标识：**主模式严重依赖**对端的IP地址**作为其身份标识。（`IP`地址）。
6. **生存时间：**定义`IKE SA`的有效期限。到期后需要重新协商。

![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005122419621.png)

**注意：**此为`IKEv1`第一阶段的建立过程，其目的是创建出一条安全通道（`IKE SA`）为后续`IPsec SA`建立打下基础。第一阶段的建立过程总共有三对消息。

- **第一对消息（明文）：**交换`IKE SA`，协商确定后续使用的安全参数。
  - **发起方**发送`IKE SA`，该`SA`中包含一个或多个**安全关联提议**。例如：“我提议使用方案1：`AES256-SHA384-DH19`；或者方案2：`AES128-SHA256-DH14`。你同意哪一个？”
  - **响应方**选定一个**安全关联**。例如：“我同意你的方案1：`AES256-SHA384-DH19`。”

- **第二对消息（明文）：**执行`DH`密钥交换。
  - 双方交换自己的**公钥（非对称加密）**和**随机数**。
  - 交换完成后，双方各自在本地计算出**相同的共享密钥（对称加密）**用于加密和解密后续的`IKE`报文。
- **第三对消息（密文）：**验证对方和自己的身份。
  - 第三对消息使用上一步计算出的**共享密钥**进行加密。
  - 各自向对方发送**ID（如IP地址）**和`HASH`值，这个`HASH`值是为了证明对方拥有正确的**预共享密钥或证书**。
  - 双方收到对方的身份信息和`HASH`值后，会使用本地存储的**预共享密钥**重新计算验证`HASH`值和身份信息，如果匹配则身份认证成功。

------

###### 3.2.3.4.野蛮模式协商过程

**野蛮模式不需要指定对端IP地址**

![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005124257370.png)

`IKEv1`的野蛮模式一共只有三条消息：

- **第一条消息（明文）：**
  - 发起方通过一条消息将`IKE SA`、`DH`公钥、随机数和`ID`（`IP`地址）信息发送给对端。
- **第二条消息（密文）：**
  - 接收方收到发起方的信息后匹配自身是否支持。
  - 若支持则将本端支持的`IKE SA`、`DH`公钥、随机数和`ID`（`IP`地址）和==**哈希值（身份认证）**==发送给对端。
  - 该消息因为已经有了对端所有的参数和公钥，所以可以计算出**共享密钥**并加密。
- **第三条消息（密文）：**
  - 发送**哈希值**用来验证自己的身份。
  - 双方验证**哈希值**，`IKE SA`建立成功。

**主模式与野蛮模式对比**

野蛮模式由于报文数量更少，所以建立`IKEv1 SA`的速度较快。但是由于野蛮模式的密钥交换和身份认证一起进行，所以发起者的身份是暴露的有窃听风险，无法提供身份保护。

另外，主模式的身份认证需要检查对端的`IP`地址是否与本地指定的一致，而野蛮模式仅依赖**哈希**。所以野蛮模式适用于一端`IP`地址不固定的场景，而主模式适用于两端`IP`地址都为固定的场景。

------

###### 3.2.3.5.第二阶段协商过程

`IKEv1`第二阶段的唯一目的，就是在第一阶段建立的安全通道（`IKE SA`）保护下，协商出用于加密真实用户数据的`IPsec SA`。

第二阶段用的模式叫做`Quick Mode`快速模式，有且只有这一种模式。

- **第一条消息（发起者 --> 响应者）：**
  - 在加密通道内，发送希望使用的加密算法、流量范围，以及新的`DH`公钥（可选）。
- **第二条消息（响应者 --> 发起者）：**
  - 同意对方提出的方案，并返回必要的参数（如新`DH`公钥），完成密钥交换的准备工作。
- **第三条消息（发起者 --> 响应者）：**
  - 发送一个确认信息，证明自己参与了整个交换过程。双方据此独立生成最终的数据加密密钥。

------

##### 3.2.4.IKEv2协商建立IPsec SA

`IKEv2`的设计比`IKEv1`更简洁、高效、安全，它通过一次初始交换和一次认证交换（共四条消息）来完成`IKEv1`中两个阶段的工作。

![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005143757176.png)

- **第一对消息（明文传输）：**协商安全参数，交换随机数和`DH`公钥，建立`IKE SA`。
  - 第一对消息交换完成后，双方在本地各自进行计算，计算出对称密钥。此时`IKE SA`已经建立起来了。
- **第二对消息（密文传输）：**在`IKE SA`的保护下，进行身份认证，并建立一个`IPsec SA`。
  - 第二对消息互传身份信息（`IP`地址）和数字签名或预共享密钥用于验证身份。并协商`IPsec SA`的参数信息。

------

##### 3.2.5.关于这两种隧道

学到这里我们已经了解了`IPsec`在加密数据之前，会创建出两条隧道，一条是`IKE`一条是`IPsec`。两端通信时真正的数据报文是通过`IPsec SA`协商出的加密算法等信息，进行加密传输的。

但是`IKE SA`和`IPsec SA`的生命周期是分离的，`IPsec SA`建立完毕后`IKE SA`会被保留。

------

###### 3.2.5.1.IPsec SA的更新

因为`IPsec SA`是有生存周期的，为了防止密钥被破解，它需要定期更新。那么当`IPsec SA`即将过期时，会利用现有的`IKE SA`隧道，快速地进行一次`IKE`第二阶段的协商，协商出新的`IPsec SA`。

另外，即使当网络抖动或意外情况导致`IPsec SA`失效，只要`IKE SA`是存活的，双方就能快速地重新协商`IPsec SA`，而不必重新执行整段协商过程。

------

###### 3.2.5.2.IKE SA的更新

`IKE SA`不像`IPsec SA`那样有固定的短期生命周期，它的更新是按需、手动（或策略触发）的，目的是刷新建立和管理通道的密钥。

**通常如下情况会触发更新条件：**

- **生存时间到期**：IKE SA 本身也有一个生存时间，但这个时间通常非常长（例如 **24小时、7天甚至更长**）。当这个时间到期时，会触发重协商。
- **流量超限**：IKE SA 可以配置为在传输一定量数据后重协商。
- **管理员手动触发**：出于安全考虑，管理员可以手动强制重新进行 IKE 协商。
- **对等体发起**：一端可以主动向另一端发起重协商请求。

**更新的过程：**

1. 双方需要再次进行 **DH 交换**，生成全新的共享秘密。
2. 重新进行**身份认证**。
3. 基于新的材料，派生出**一套全新的 IKE SA 密钥**（`SK_ei`, `SK_ai`, `SK_d`等）。

**注意**：在`IKE SA`重协商期间，**现有的 IPsec SA 通常不会中断**，会继续加密用户数据，直到新的`IKE SA`建立成功。然后，在新的`IKE SA`的保护下，再更新`IPsec SA`。这实现了无缝的密钥轮换。

------

##### 3.2.6.IKE（ISAKMP）报文

![image-20251005155656477](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005155656555.png)

**IP报文头：**

- **源地址：**本端发起`IKE`协商的`IP`地址，可以是接口地址，也可以是通过命令配置的`IP`地址。
- **目的地址：**对端发起`IKE`协商的`IP`地址，由命令配置。

**UDP报文头：**

`IKE`协议使用端口号`500`发起协商、响应协商。在两端都有固定`IP`地址时，这个端口在协商过程中保持不变。

**ISAKMP报文头：**

- **Initiator’s Cookie (SPI)** & **Responder’s Cookie (SPI)**：**Cookie** 或 **安全参数索引**。这是两个8字节的随机数，共同**唯一标识了一个IKE SA（安全关联）**。
  - 发起方生成 Initiator‘s Cookie。
  - 响应方生成 Responder’s Cookie。
  - 两者组合，形成一个唯一的会话ID。后续所有属于这个会话的报文都必须携带这对Cookie。
- **Next Payload**：指向紧接在这个头部之后的**第一个载荷（Payload）的类型**（如：SA载荷、KE载荷等）。
- **Major Ver** & **Min Ver**：主版本号和次版本号。对于IKEv1，这里是 `1.0`。
- **Exchange Type**：**交换类型**。这是非常关键的字段，它定义了此次交换的模式：
  - `2`= **Identity Protect**（身份保护），即**主模式**。
  - `4`= **Aggressive**（积极模式），即**野蛮模式**。
  - `5`= **Informational**（信息交换），用于通知错误或删除SA。
  - `32`= **Quick Mode**（快速模式），即Phase 2交换。
- **Flags**：标志位，例如一位标志位指示是否**加密**（在主模式中，从第5条消息开始设置加密标志）。
- **Message ID**：**消息ID**。在Phase 1中，此值通常为0；在Phase 2（快速模式）中，这是一个随机值，用于关联一次特定的快速模式交换，并提供抗重放保护。
- **Message Length**：整个ISAKMP消息（头部+所有载荷）的总长度。

- **Initiator’s Cookie (SPI)** & **Responder’s Cookie (SPI)**：**Cookie** 或 **安全参数索引**。这是两个8字节的随机数，共同**唯一标识了一个IKE SA（安全关联）**。
  - 发起方生成 Initiator‘s Cookie。
  - 响应方生成 Responder’s Cookie。
  - 两者组合，形成一个唯一的会话ID。后续所有属于这个会话的报文都必须携带这对Cookie。
- **Next Payload**：指向紧接在这个头部之后的**第一个载荷（Payload）的类型**（如：SA载荷、KE载荷等）。
- **Major Ver** & **Min Ver**：主版本号和次版本号。对于IKEv1，这里是 `1.0`。
- **Exchange Type**：**交换类型**。这是非常关键的字段，它定义了此次交换的模式：
  - `2`= **Identity Protect**（身份保护），即**主模式**。
  - `4`= **Aggressive**（积极模式），即**野蛮模式**。
  - `5`= **Informational**（信息交换），用于通知错误或删除SA。
  - `32`= **Quick Mode**（快速模式），即Phase 2交换。
- **Flags**：标志位，例如一位标志位指示是否**加密**（在主模式中，从第5条消息开始设置加密标志）。
- **Message ID**：**消息ID**。在Phase 1中，此值通常为0；在Phase 2（快速模式）中，这是一个随机值，用于关联一次特定的快速模式交换，并提供抗重放保护。
- **Message Length**：整个ISAKMP消息（头部+所有载荷）的总长度。

**实际内容（载荷）：**

这是`IKE`协议**真正要交换的信息内容**。它由多个“载荷”串联而成，每个载荷都有自己的头部和具体数据。

- 例如，在**主模式第一条消息**中，Payload 部分主要包含一个 **SA 载荷**，里面是发起方提议的加密算法列表。
- 其他常见的载荷还有：**KE载荷**（DH公钥）、**Nonce载荷**（随机数）、**ID载荷**（身份信息）、**HASH载荷**（认证凭证）等。

------

##### 3.2.7.IKE 配置参数

| **参数**    | **IKEv1**                                      | **IKEv2**               | **参数说明**                |
| ----------- | ---------------------------------------------- | ----------------------- | --------------------------- |
| IKE工作模式 | 主模式 or 野蛮模式                             | /                       | IKEv1第一阶段有两种工作模式 |
| DH组        | 组编号：14、15、16、18、19、20、21、22等       | DH算法用于协商对称密钥  |                             |
| 加密算法    | DES、3DES、AES、SM4                            | DES、3DES、AES          | 用于IKE SA的报文加密        |
| 认证算法    | MD5、SHA1、SHA2、SM3                           | MD5、SHA1、SHA2         | 用于IKE SA的报文认证        |
| 认证方式    | 预共享密钥、RSA签名、RSA数字信封、国密数字信封 | 用于IPSec对等体身份验证 |                             |
| 超时时间    | 缺省为86400秒                                  | IKE SA的生存周期        |                             |
| PRF算法     | /                                              | MD5、SHA1、SHA2等       | IKEv2伪随机数产生算法       |

------

#### 3.3.定义保护数据流的方法

`IPsec`只对特定的数据流进行保护，至于什么样的数据是需要`IPsec`保护的，可以通过以下两种方式定义：

- **ACL方式：**通过`ACL`规则筛选需要`IPsec`保护的数据流，匹配`ACL permit`规则的报文将受到`IPsec`保护，未匹配任何`permit`规则的报文将不受`IPsec`保护。该方式可以利用`ACL`丰富的功能，灵活的指定`IPsec`保护报文的方法。

- **路由方式：**通过在`Tunnel`隧道接口上创建`IPsec`隧道，路由到`Tunnel`隧道接口上的报文都将受到`IPsec`保护，除非用户指定该报文不需要被`IPsec`保护。该方式可以简化`IPsec`配置的复杂度，同时支持动态路由协议、以及对组播流量进行保护。

  - **封装：**

    1. 设备将从如接口接收到的`IP`明文送到转发模块进行路由处理。
    2. 转发模块根据路由表，将`IP`明文发送到隧道接口进行封装。原始`IP`报文加密后被封装在一个新的`IP`报文中。
    3. 隧道接口完成封装后，将`IP`密文再次送到转发模块进行路由处理。
    4. 转发模块根据新`IP`头中的目的`IP`地址进行二次路由查询后，将报文通过实际物理出接口转发出去。

    ![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005161929821.png)

  - **解封装：**

    1. 设备将从入接口收到的`IP`密文送到转发模块进行路由处理。
    2. 转发模块识别到此`IP`密文的目的`IP`地址为本设备隧道接口源端地址且`IP`协议号为`AH`或`ESP`时，会将`IP`密文送到相应的隧道接口进行解封装，将外层`IP`头去掉，对内层`IP`报文进行解密处理。
    3. 隧道接口完成解封装后，将`IP`明文重新送回转发模块进行路由处理。

    ![img](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005162150299.png)

------

##### 3.3.1.流量不进行NAT转换

缺省情况下，在一个接口上同时配置了`IPsec`与`NAT`的情况下，对于出方向报文，设备先进行`NAT`转换，再进行`IPsec`处理。若需要进行`IPsec`处理的流量进行了`NAT`转换，那么该流量将无法匹配`ACL`规则，从而导致该流量不能按照预期进行`IPsec`处理。此时，必须通过相关的配置对需要`NAT`转换的流量和需要`IPsec`处理的流量进行准确的区分。而准确的区分可能导致配置复杂，难以维护。

开启流量不进行`NAT`转换功能后，当前接口上需要进行`IPsec`处理的流量将不会进行`NAT`转换，减轻划分`NAT`与`IPsec`流量的工作量，进而降低接口上`IPsec`与`NAT`共存时配置的复杂度。

![4b703ace373554a59a6c6809b8741258](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251013184416277.png)

------

#### 3.4.实验演示

##### 3.4.1.实验一：IPsec点到点 ACL模式

![image-20251005225323063](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005225323180.png)

###### 3.4.1.1.**实验需求：**

![image-20251005215046167](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005215046251.png)

当前`FW1`和`FW2`模拟两个园区的出口网关设备，`FW1`和`FW2`需要建立`IPsec`隧道使`PC1`和`PC2`成功互访。另外`FW1`和`FW2`需要保证内网`PC`可以访问互联网设备`AR1`的`Loo0`地址。

该`IPsec`隧道直接应用在防火墙的出接口，使用`ACL`的方式将流量引入到`IPsec`隧道。采用`ISAKMP`方式建立`IPsec SA`，采用预共享密钥认证。

`IPsec`配置：

- **对端地址：**
  - `FW1`：`12.1.1.2`
  - `FW2`：`11.1.1.1`
- **预共享密钥：**
  - `Huawei@123`

------

###### 3.4.1.2.**基础配置演示：**

**FW1基础配置：**

```
[FW1]int g1/0/1
[FW1-GigabitEthernet1/0/1]ip add 192.168.10.254 24
[FW1-GigabitEthernet1/0/1]quit
[FW1]int g1/0/0
[FW1-GigabitEthernet1/0/0]ip add 11.1.1.1 30
[FW1-GigabitEthernet1/0/0]quit	
[FW1]firewall zone trust 
[FW1-zone-trust]add int g1/0/1
[FW1-zone-trust]quit	
[FW1]firewall zone untrust 
[FW1-zone-untrust]add int g1/0/0
[FW1-zone-untrust]quit
[FW1]ip route-static 0.0.0.0 0 11.1.1.2
```

**FW2基础配置：**

```
[FW2]int g1/0/0
[FW2-GigabitEthernet1/0/0]ip add 12.1.1.2 30
[FW2-GigabitEthernet1/0/0]quit
[FW2]int g1/0/1
[FW2-GigabitEthernet1/0/1]ip add 192.168.20.254 24
[FW2-GigabitEthernet1/0/1]quit	
[FW2]firewall zone trust 
[FW2-zone-trust]add int g1/0/1
[FW2-zone-trust]quit	
[FW2]firewall zone untrust 
[FW2-zone-untrust]add int g1/0/0
[FW2-zone-untrust]quit	
[FW2]ip route-static 0.0.0.0 0 12.1.1.1
```

**AR1基础配置：**

```
[AR1]int g0/0/0
[AR1-GigabitEthernet0/0/0]ip add 11.1.1.2 30
[AR1-GigabitEthernet0/0/0]quit
[AR1]int g0/0/1
[AR1-GigabitEthernet0/0/1]ip add 12.1.1.1 30
[AR1-GigabitEthernet0/0/1]quit
[AR1]int loo0
[AR1-LoopBack0]ip add 100.100.100.100 32
[AR1-LoopBack0]quit
```

**FW1 NAT配置：**

```
[FW1]nat-policy 
[FW1-policy-nat]rule name easy_ip	
[FW1-policy-nat-rule-easy_ip]action source-nat easy-ip 
[FW1-policy-nat-rule-easy_ip]quit
[FW1-policy-nat]quit	
[FW1]security-policy 
[FW1-policy-security]rule name easy_ip	
[FW1-policy-security-rule-easy_ip]source-zone trust 	
[FW1-policy-security-rule-easy_ip]destination-zone untrust 	
[FW1-policy-security-rule-easy_ip]source-address 192.168.10.0 24
[FW1-policy-security-rule-easy_ip]action permit
[FW1-policy-security-rule-easy_ip]quit
[FW1-policy-security]quit
```

**FW2 NAT配置：**

```
[FW2]nat-policy 
[FW2-policy-nat]rule name easy_ip	
[FW2-policy-nat-rule-easy_ip]action source-nat easy-ip 
[FW2-policy-nat-rule-easy_ip]quit
[FW2-policy-nat]quit	
[FW2]security-policy 
[FW2-policy-security]rule name easy_ip	
[FW2-policy-security-rule-easy_ip]source-zone trust 	
[FW2-policy-security-rule-easy_ip]destination-zone untrust 	
[FW2-policy-security-rule-easy_ip]source-address 192.168.20.0 24
[FW2-policy-security-rule-easy_ip]action permit
[FW2-policy-security-rule-easy_ip]quit
[FW2-policy-security]quit
```

------

###### 3.4.1.3.IPsec 配置演示

**FW1 安全策略：**

```
[FW1]security-policy 
[FW1-policy-security]rule name PC_to_PC	# 两个园区内部的PC互访策略
[FW1-policy-security-rule-PC_to_PC]source-zone trust untrust 	
[FW1-policy-security-rule-PC_to_PC]destination-zone untrust trust 
[FW1-policy-security-rule-PC_to_PC]source-address 192.168.10.0 24
[FW1-policy-security-rule-PC_to_PC]source-address 192.168.20.0 24
[FW1-policy-security-rule-PC_to_PC]destination-address 192.168.10.0 24
[FW1-policy-security-rule-PC_to_PC]destination-address 192.168.20.0 24	
[FW1-policy-security-rule-PC_to_PC]action permit
[FW1-policy-security-rule-PC_to_PC]quit

[FW1-policy-security]rule name IPsec	# IPsec的安全策略
[FW1-policy-security-rule-IPsec]source-zone local untrust 	
[FW1-policy-security-rule-IPsec]destination-zone local untrust 	
[FW1-policy-security-rule-IPsec]source-address 11.1.1.1 32	
[FW1-policy-security-rule-IPsec]source-address 12.1.1.2 32	
[FW1-policy-security-rule-IPsec]destination-address 11.1.1.1 32
[FW1-policy-security-rule-IPsec]destination-address 12.1.1.2 32
[FW1-policy-security-rule-IPsec]action permit
[FW1-policy-security-rule-IPsec]quit
[FW1-policy-security]quit
```

**FW2 安全策略：**

```
[FW2]security-policy 
[FW2-policy-security]rule name PC_to_PC	# 两个园区内部的PC互访策略
[FW2-policy-security-rule-PC_to_PC]source-zone trust untrust 	
[FW2-policy-security-rule-PC_to_PC]destination-zone untrust trust 
[FW2-policy-security-rule-PC_to_PC]source-address 192.168.10.0 24
[FW2-policy-security-rule-PC_to_PC]source-address 192.168.20.0 24
[FW2-policy-security-rule-PC_to_PC]destination-address 192.168.10.0 24
[FW2-policy-security-rule-PC_to_PC]destination-address 192.168.20.0 24	
[FW2-policy-security-rule-PC_to_PC]action permit
[FW2-policy-security-rule-PC_to_PC]quit

[FW2-policy-security]rule name IPsec	
[FW2-policy-security-rule-IPsec]source-zone local untrust 	
[FW2-policy-security-rule-IPsec]destination-zone local untrust 	
[FW2-policy-security-rule-IPsec]source-address 11.1.1.1 32	
[FW2-policy-security-rule-IPsec]source-address 12.1.1.2 32	
[FW2-policy-security-rule-IPsec]destination-address 11.1.1.1 32
[FW2-policy-security-rule-IPsec]destination-address 12.1.1.2 32
[FW2-policy-security-rule-IPsec]action permit
[FW2-policy-security-rule-IPsec]quit
[FW2-policy-security]quit
```

**配置感兴趣流：**

```
[FW1]acl 3000
[FW1-acl-adv-3000]rule permit ip source 192.168.10.0 0.0.0.255 destination 192.1
68.20.0 0.0.0.255
[FW1-acl-adv-3000]quit

[FW2]acl 3000	
[FW2-acl-adv-3000]rule permit ip source 192.168.20.0 0.0.0.255 destination 192.1
68.10.0 0.0.0.255
[FW2-acl-adv-3000]quit
```

**配置IPsec安全提议：**

```
[FW1]ipsec proposal tran1	
[FW1-ipsec-proposal-tran1]esp authentication-algorithm sha2-256 
[FW1-ipsec-proposal-tran1]esp encryption-algorithm aes-256
[FW1-ipsec-proposal-tran1]quit
# 可选：
[FW2-ipsec-proposal-1]transform ?
  ah      AH protocol defined in RFC2402
  ah-esp  ESP protocol first, then AH protocol
  esp     ESP protocol defined in RFC2406
[FW2-ipsec-proposal-1]encapsulation-mode ?
  auto       Specify automatic mode. The responder can accept negotiations in
             transport or tunnel mode. The initiator initiates negotiations in
             tunnel mode
  transport  Only the payload of IP packet is protected(transport mode)
  tunnel     The entire IP packet is protected(tunnel mode)

[FW2]ipsec proposal tran1	
[FW2-ipsec-proposal-tran1]esp authentication-algorithm sha2-256 
[FW2-ipsec-proposal-tran1]esp encryption-algorithm aes-256
[FW2-ipsec-proposal-tran1]quit
```

**配置IKE安全提议：**

```
[FW1]ike proposal 10	
[FW1-ike-proposal-10]authentication-method pre-share 	# 设置模式为预共享密钥
[FW1-ike-proposal-10]prf hmac-sha2-256                  # 设置伪随机函数   
[FW1-ike-proposal-10]encryption-algorithm aes-256		# 设置加密算法
[FW1-ike-proposal-10]dh group14							# 设置密钥交换组
[FW1-ike-proposal-10]integrity-algorithm hmac-sha2-256 	# 设置完整性校验算法，哈希
[FW1-ike-proposal-10]quit

[FW2]ike proposal 10	
[FW2-ike-proposal-10]authentication-method pre-share 	
[FW2-ike-proposal-10]prf hmac-sha2-256                               
[FW2-ike-proposal-10]encryption-algorithm aes-256	
[FW2-ike-proposal-10]dh group14
[FW2-ike-proposal-10]integrity-algorithm hmac-sha2-256 
[FW2-ike-proposal-10]quit
```

**配置IKE Peer：**

```
[FW1]ike peer ike
[FW1-ike-peer-ike]ike-proposal 10	
[FW1-ike-peer-ike]remote-address 12.1.1.2
[FW1-ike-peer-ike]pre-shared-key Huawei@123
[FW1-ike-peer-ike]quit

[FW2]ike peer ike	
[FW2-ike-peer-ike]ike-proposal 10	
[FW2-ike-peer-ike]remote-address 11.1.1.1	
[FW2-ike-peer-ike]pre-shared-key Huawei@123
[FW2-ike-peer-ike]quit
```

**配置IPsec策略：**

```
[FW1]ipsec policy map1 10 isakmp 	
[FW1-ipsec-policy-isakmp-map1-10]security acl 3000	
[FW1-ipsec-policy-isakmp-map1-10]proposal tran1	
[FW1-ipsec-policy-isakmp-map1-10]ike-peer ike
[FW1-ipsec-policy-isakmp-map1-10]quit

[FW2]ipsec policy map1 10 isakmp 	
[FW2-ipsec-policy-isakmp-map1-10]security acl 3000	
[FW2-ipsec-policy-isakmp-map1-10]proposal tran1	
[FW2-ipsec-policy-isakmp-map1-10]ike-peer ike
[FW2-ipsec-policy-isakmp-map1-10]quit
```

**在外接口应用IPsec策略组：**

```
[FW1]interface g1/0/0	
[FW1-GigabitEthernet1/0/0]ipsec policy map1
[FW1-GigabitEthernet1/0/0]quit

[FW2]interface g1/0/0
[FW2-GigabitEthernet1/0/0]ipsec policy map1
[FW2-GigabitEthernet1/0/0]quit
```

------

###### 3.4.1.4.修改NAT配置

到此，你在尝试测试两端通信时你会发现完全无法通信，甚至会话表和`SA`都完全没有创建，这是因为该数据报文被`NAT`匹配到了。

```
[FW1]interface g1/0/0
[FW1-GigabitEthernet1/0/0]ipsec po	
[FW1-GigabitEthernet1/0/0]ipsec policy map1
[FW1-GigabitEthernet1/0/0]quit
```

需要在防火墙的`NAT`部分做如下修改：

```
[FW1]nat-policy
[FW1-policy-nat]rule name no_ipsec	
[FW1-policy-nat-rule-no_ipsec]source-zone trust 	
[FW1-policy-nat-rule-no_ipsec]destination-zone untrust 
[FW1-policy-nat-rule-no_ipsec]source-address 192.168.10.0 24	
[FW1-policy-nat-rule-no_ipsec]destination-address 192.168.20.0 24
[FW1-policy-nat-rule-no_ipsec]action no-nat
[FW1-policy-nat-rule-no_ipsec]quit
[FW1-policy-nat]rule move no_ipsec top

[FW2]nat-policy 
[FW2-policy-nat]rule name no_ipsec
[FW2-policy-nat-rule-no_ipsec]source-zone trust 
[FW2-policy-nat-rule-no_ipsec]destination-zone untrust 	
[FW2-policy-nat-rule-no_ipsec]source-address 192.168.20.0 24	
[FW2-policy-nat-rule-no_ipsec]destination-address 192.168.10.0 24	
[FW2-policy-nat-rule-no_ipsec]action no-nat
[FW2-policy-nat-rule-no_ipsec]quit
[FW2-policy-nat]rule move no_ipsec top
```

------

###### 3.4.1.5.验证

**ping测试：**

![image-20251005224226525](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005224226630.png)

**抓包：**

![image-20251005224211676](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005224211797.png)

**IKE SA：**

![image-20251005224319238](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005224319365.png)

![image-20251005224333886](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251005224334008.png)

**为什么是两个IKE SA呢？**

- 因为`SA`是单向通道，一个方向上就要建立一个`SA`，那么来回正好两个。

**IPsec SA：默认是V2**

```
[FW1]display ipsec sa 
2025-10-05 14:44:30.430 

ipsec sa information:

===============================
Interface: GigabitEthernet1/0/0
===============================

  -----------------------------
  IPSec policy name: "map1"
  Sequence number  : 10
  Acl group        : 3000
  Acl rule         : 5
  Mode             : ISAKMP
  -----------------------------
    Connection ID     : 4
    Encapsulation mode: Tunnel
    Holding time      : 0d 0h 2m 51s
    Tunnel local      : 11.1.1.1:500
    Tunnel remote     : 12.1.1.2:500
    Flow source       : 192.168.10.0/255.255.255.0 0/0-65535
    Flow destination  : 192.168.20.0/255.255.255.0 0/0-65535

    [Outbound ESP SAs] 
      SPI: 190425385 (0xb59a929)
      Proposal: ESP-ENCRYPT-AES-256 ESP-AUTH-SHA2-256-128
      SA remaining key duration (kilobytes/sec): 10485760/3429
      Max sent sequence-number: 5
      UDP encapsulation used for NAT traversal: N
      SA encrypted packets (number/bytes): 4/240

    [Inbound ESP SAs] 
      SPI: 192130047 (0xb73abff)
      Proposal: ESP-ENCRYPT-AES-256 ESP-AUTH-SHA2-256-128
      SA remaining key duration (kilobytes/sec): 10485760/3429
      Max received sequence-number: 1
      UDP encapsulation used for NAT traversal: N
      SA decrypted packets (number/bytes): 4/240
      Anti-replay : Enable
      Anti-replay window size: 1024

<FW2>display ipsec sa 
2025-10-05 14:46:26.310 

ipsec sa information:

===============================
Interface: GigabitEthernet1/0/0
===============================

  -----------------------------
  IPSec policy name: "map1"
  Sequence number  : 10
  Acl group        : 3000
  Acl rule         : 5
  Mode             : ISAKMP
  -----------------------------
    Connection ID     : 3
    Encapsulation mode: Tunnel
    Holding time      : 0d 0h 4m 47s
    Tunnel local      : 12.1.1.2:500
    Tunnel remote     : 11.1.1.1:500
    Flow source       : 192.168.20.0/255.255.255.0 0/0-65535
    Flow destination  : 192.168.10.0/255.255.255.0 0/0-65535

    [Outbound ESP SAs] 
      SPI: 192130047 (0xb73abff)
      Proposal: ESP-ENCRYPT-AES-256 ESP-AUTH-SHA2-256-128
      SA remaining key duration (kilobytes/sec): 10485760/3313
      Max sent sequence-number: 5
      UDP encapsulation used for NAT traversal: N
      SA encrypted packets (number/bytes): 4/240

    [Inbound ESP SAs] 
      SPI: 190425385 (0xb59a929)
      Proposal: ESP-ENCRYPT-AES-256 ESP-AUTH-SHA2-256-128
      SA remaining key duration (kilobytes/sec): 10485760/3313
      Max received sequence-number: 1
      UDP encapsulation used for NAT traversal: N
      SA decrypted packets (number/bytes): 4/240
      Anti-replay : Enable
      Anti-replay window size: 1024
```

- 两端的`Inbound SPI`和`Outbound SPI`正好是反着的，可以通过这个来判断是否是一组`IPsec SA`。

**会话表：**

```
[FW1]display firewall session table 
2025-10-05 14:47:40.800 
 Current Total Sessions : 6
 icmp  VPN: public --> public  192.168.20.1:901[192.168.10.254:2048] --> 192.168
.10.1:2048
 esp  VPN: public --> public  12.1.1.2:0 --> 11.1.1.1:0
 icmp  VPN: public --> public  192.168.20.1:1669[192.168.10.254:2051] --> 192.16
8.10.1:2048
 icmp  VPN: public --> public  192.168.20.1:1157[192.168.10.254:2049] --> 192.16
8.10.1:2048
 icmp  VPN: public --> public  192.168.20.1:1925[192.168.10.254:2052] --> 192.16
8.10.1:2048
 icmp  VPN: public --> public  192.168.20.1:1413[192.168.10.254:2050] --> 192.16
8.10.1:2048

<FW2>display firewall session table 
2025-10-05 14:47:35.700 
 Current Total Sessions : 6
 icmp  VPN: public --> public  192.168.20.1:901 --> 192.168.10.1:2048
 icmp  VPN: public --> public  192.168.20.1:1669 --> 192.168.10.1:2048
 esp  VPN: public --> public  11.1.1.1:0 --> 12.1.1.2:0
 icmp  VPN: public --> public  192.168.20.1:1157 --> 192.168.10.1:2048
 icmp  VPN: public --> public  192.168.20.1:1925 --> 192.168.10.1:2048
 icmp  VPN: public --> public  192.168.20.1:1413 --> 192.168.10.1:2048
```

------

##### 3.4.2.实验二：IPsec点到点 Tunnel模式

![image-20251006212550816](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251006212550941.png)

###### 3.4.2.1.实验需求：

两端`IPsec`设备通过`Tunnel`接口建立`IPsec`隧道，通过路由的方式将数据引入到隧道中。此时不需要配置感兴趣流，也不需要修改`NAT`。

###### 3.4.2.2.ipsec配置演示：

**ipsec proposal**

````
[FW1]ipsec proposal tran1
[FW1-ipsec-proposal-tran1]esp authentication-algorithm sha2-256
[FW1-ipsec-proposal-tran1]esp encryption-algorithm aes-128
[FW1-ipsec-proposal-tran1]quit

[FW2]ipsec proposal tran1	
[FW2-ipsec-proposal-tran1]esp authentication-algorithm sha2-256 
[FW2-ipsec-proposal-tran1]esp encryption-algorithm aes-128
[FW2-ipsec-proposal-tran1]quit
````

**IKE proposal**

```
[FW1]ike proposal 5
[FW1-ike-proposal-5]authentication-algorithm sha2-256 
[FW1-ike-proposal-5]encryption-algorithm aes-128
[FW1-ike-proposal-5]dh group14
[FW1-ike-proposal-5]quit

[FW2]ike proposal 5
[FW2-ike-proposal-5]authentication-algorithm sha2-256
[FW2-ike-proposal-5]encryption-algorithm aes-128
[FW2-ike-proposal-5]dh group14
[FW2-ike-proposal-5]quit
```

**IKE Peer**

```
[FW1]ike peer ike
[FW1-ike-peer-ike]ike-proposal 5
[FW1-ike-peer-ike]pre-shared-key Huawei@123
[FW1-ike-peer-ike]quit

[FW2]ike peer ike	
[FW2-ike-peer-ike]ike-proposal 5	
[FW2-ike-peer-ike]pre-shared-key Huawei@123
[FW2-ike-peer-ike]quit
```

**IPsec profile**

```
[FW1]ipsec profile profile1
[FW1-ipsec-profile-profile1]proposal tran1
[FW1-ipsec-profile-profile1]ike-peer ike
[FW1-ipsec-profile-profile1]quit

[FW2]ipsec profile profile1
[FW2-ipsec-profile-profile1]proposal tran1
[FW2-ipsec-profile-profile1]ike-peer ike
[FW2-ipsec-profile-profile1]quit
```

**Tunnel**

```
[FW1]interface Tunnel 0
[FW1-Tunnel0]ip add 10.10.10.1 24
[FW1-Tunnel0]tunnel-protocol ipsec	
[FW1-Tunnel0]source 11.1.1.1	
[FW1-Tunnel0]destination 12.1.1.2	
[FW1-Tunnel0]ipsec profile profile1 
[FW1-Tunnel0]quit

[FW2]interface Tunnel 0
[FW2-Tunnel0]ip add 10.10.10.2 24
[FW2-Tunnel0]tunnel-protocol ipsec	
[FW2-Tunnel0]source 12.1.1.2	
[FW2-Tunnel0]destination 11.1.1.1	
[FW2-Tunnel0]ipsec profile profile1
[FW2-Tunnel0]quit
```

**策略**

```
[FW1]security-policy 
[FW1-policy-security]rule name ipsec
[FW1-policy-security-rule-ipsec]source-zone local 
[FW1-policy-security-rule-ipsec]source-zone untrust 	
[FW1-policy-security-rule-ipsec]destination-zone local untrust 
[FW1-policy-security-rule-ipsec]action permit
[FW1-policy-security-rule-ipsec]quit
[FW1-policy-security]quit

[FW2]security-policy 
[FW2-policy-security]rule name ipsec
[FW2-policy-security-rule-ipsec]source-zone untrust local 
[FW2-policy-security-rule-ipsec]destination-zone untrust local 
[FW2-policy-security-rule-ipsec]action permit
[FW2-policy-security-rule-ipsec]quit
[FW2-policy-security]quit
```

**安全区域与路由**

```
[FW1]firewall zone untrust 	
[FW1-zone-untrust]add int Tunnel 0
[FW1-zone-untrust]quit
[FW1]ip route-static 192.168.20.0 24 Tunnel 0

[FW2]firewall zone untrust 
[FW2-zone-untrust]add int tu 0
[FW2-zone-untrust]quit
[FW2]ip route-static 192.168.10.0 24 Tunnel 0
```

------

###### 3.4.2.3.验证

此时，`PC1`和`PC2`无法成功`ping`通，但是`FW1`和`FW2`上已经成功建立好`IPsec SA、IKE SA`。通过抓包可以很明显的发现问题：

![image-20251006222033650](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251006222033766.png)

以上`10`个报文是在公网接口抓包`PC1 --> PC2`和`PC2 --> PC1`的。

此时通过内网抓包（这是成功了我才抓的）你会发现去往对端的报文没啥问题，但是对端发往本端的报文源目地址是网关和`PC`，所以需要添加以下安全策略：

![image-20251006222214110](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251006222214234.png)

```
[FW1-policy-security]rule name test
[FW1-policy-security-rule-test]source-zone trust local 	
[FW1-policy-security-rule-test]destination-zone trust local 	
[FW1-policy-security-rule-test]action permit
[FW1-policy-security-rule-test]quit
```

------

###### 3.4.2.4.流量走向顺序

**发送：**

1. `PC1`发出目的地址为`PC2`的数据包，将被转发给网关`FW1`。

2. `FW1`收到该数据包后，通过路由表将数据包引导至`Tunnel`接口。
3. 由于`Tunnel`接口绑定了`ipsec profile`，所以一切走向`Tunnel`接口的流量都会被`IPsec`保护并发给对端。
   - 经过`IPsec`封装时，因为是`ESP`模式，所以在原有报头前增加新的`IP`头。该`IP`头的源目地址就是这个`Tunnel`接口的实际源目地址。
4. 封装完成后进行第二次路由查询（对端公网地址），从公网口将数据包发出。

```
原始数据包 -> 路由查询 -> 进入Tunnel接口 -> 触发IPSec加密封装 -> 产生新IP头 -> 第二次路由查询 -> 从物理接口发出
```

**接收：**

1. `FW2`接收到目的地址为自己公网地址的数据包后进行解封装，检查协议号后发现是`ESP`，交给`IPsec`处理。
2. 通过加密算法和验证算法，检查数据包是否被篡改并解密，暴露出该数据包的原貌。
3. 进行路由查询将数据包转发至`PC2`。

------

###### 3.4.2.5.为什么不用配置IKE Peer地址？

首先，我们先需要确定为什么之前需要配置`Peer`地址呢？第一个原因是在`IKE`建立的过程中需要有`IP`地址进行身份验证。第二个重要的原因是你将`IPsec Policy`或`IPsec Profile`应用在公网口上，`IPsec`是无法通过接口来得知`IPsec`隧道的目标的。

那现在我们通过`Tunnel`接口的方式建立`IPsec`隧道，把`IPsec Profile`应用在`Tunnel`接口，这个`Tunnel`接口中已经明确告知`destination`地址了，所以不需要再配置`IKE Peer`了。

------

###### 3.4.2.6.IPsec Profile？

`ipsec profile`和`ipsec policy`是用来建立`IPsec`隧道的两种不同方法，对应了两种不同的`IPsec VPN`架构：

- `IPsec Policy` --> **策略隧道**（`Policy-Based VPN`）
- `IPsec Profile` --> **接口隧道/路由隧道**（`Route-Based VPN`） 

- **`ipsec policy`** 需要**ACL（访问控制列表）** 来定义“哪些流量需要被IPsec保护”。
- **`ipsec profile`** **不需要ACL**，它只定义“如何保护”，而“哪些流量需要被保护”则由**路由**来决定（即所有被路由到绑定了该`Profile`的`Tunnel`接口的流量）。

| 特性             | IPsec Policy (策略)                                          | IPsec Profile (配置文件)                                     |
| :--------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **核心原理**     | **策略驱动**：通过ACL定义流量特征和对端地址。                | **路由驱动**：通过路由表将流量引向虚拟隧道接口。             |
| **配置位置**     | 应用在**物理接口**上（如GigabitEthernet0/0/1）。             | 应用在**虚拟隧道接口**上（如Tunnel0/0/1）。                  |
| **流量识别**     | 使用**ACL**（`acl number 3000`）精确匹配源/目IP、协议等。    | **无需ACL**。所有进入Tunnel接口的流量都被保护。              |
| **对端地址指定** | 在 `ike peer`或 `ipsec policy`中通过 `remote-address`和 `tunnel remote`指定。 | 在 **Tunnel接口** 下通过 `destination`命令指定。             |
| **灵活性**       | 较差。每对新的流量（新子网）都可能需要配置新的ACL和策略。    | **极高**。只需添加一条路由，即可保护新的网段，无需改动IPsec配置。 |
| **适用场景**     | 简单的点对点网络，需要加密的流量非常固定和明确。             | 复杂的Hub-Spoke网络、需要运行动态路由协议（如OSPF over IPsec）、有大量或动态变化的子网。 |

------

#### 3.5.GRE Over IPsec

##### 3.5.1为什么需要？

我们已经系统化的学习了`GRE`和`IPsec`这两个非常厉害的协议，但它们各自都有一些缺点：

1. `GRE`隧道缺少**加密**、**身份认证**、**防篡改**等保护机制。
2. `ipsec`无法传输组播报文、无法运行动态路由协议。

![](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251006230603791.png)

`GRE Over IPsec`结合了`GRE`和`IPsec`的优势，通过`GRE`将组播、广播和非`IP`报文封装成普通的`IP`报文，通过`IPsec`为封装后的`IP`报文提供安全通信。进而可以提供在总部和分支之间安全地传输广播、组播地业务，例如视频会议或动态路由协议等。

当网关之间采用`GRE over IPSec`连接时，先进行`GRE`封装，再进行`IPSec`封装。`GRE over IPSec`使用的封装模式为可以是隧道模式也可以是传输模式。采用AH协议的`GRE over IPSec`报文封装过程如下：

![image-20251006230719521](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251006230719654.png)



**传输模式：**

传输不会改变`GRE`封装后的报文头，`IPsec`隧道的源和目的地址就是`GRE`封装后的源和目的地址，不会再新增了。

![image-20251006230950500](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251006230950624.png)

**隧道模式：**

在隧道模式中，`AH`头或`ESP`头被插到新的`IP`头之前，另外再生成一个新的报文头放到`AH`头或`ESP`t头之前：

![image-20251006231049701](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251006231049824.png)

隧道模式使用新的`IPsec`报文头来封装经过`GRE`封装后的消息，封装后的消息共有三个报文头：原始报文头、`GRE`报文头和`IPsec`报文头，`Internet`上的设备根据最外层的`IPsec`报文头来转发该消息。

在`GRE Over IPsec`中，无论`IPsec`采用隧道模式还是传输模式，都可以保护两个网络之间通信的消息。但是隧道模式增加了新的`IPsec`报文头，导致报文长度更长，更容易导致分片。如果网络环境要求报文不能分片，推荐使用传输模式。

------

##### 3.5.2.思考

![image-20251006212550816](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251006232812111.png)

`GRE over IPsec`有两种配置方法：

- `ISAKMP`方式（`Policy`）
- 安全框架（`Profile`）

为什么这两种配置方式都可以实现`GRE over Ipsec`呢？有什么不同呢？

- 实际上精简的说它们不同点在于，应用的接口一个是`Tunnel`一个是物理接口。
- 更准确的讲是引流的方式一个是`ACL`一个是**路由**，由于引流方式不同所以它们的工作流程是不一样的。

###### 3.5.2.1.Policy

1. 原始数据 `[192.168.10.11 -> 192.168.20.1]`被路由到`GRE`隧道。
2. GRE封装：变成 `[11.1.1.1 -> 12.1.1.2][GRE头][原始数据]`。
3. 这个包从物理接口发出时，被 `ipsec policy`抓取（匹配`ACL 3000`），进行加密。
4. 最终发送到公网的是：`[11.1.1.1 -> 12.1.1.2][ESP头][加密的GRE包][ESP尾]`。

###### 3.5.2.2.Profile

1. 原始数据 `[192.168.10.1 -> 192.168.20.1]`被路由到`GRE`隧道。
2. 设备准备发送`GRE`包 `[11.1.1.1 -> 12.1.1.2][GRE头][原始数据]`。
3. 路由表查询：**“如何去往12.1.1.2？”**，静态路由回答：**“从Tunnel0/0/2（IPsec VTI）走”**。
4. 数据包进入`IPsec VTI`接口，触发加密。
5. 最终发送到公网的是：`[11.1.1.1 -> 12.1.1.2][ESP头][加密的GRE包][ESP尾]`。

------

##### 3.5.3.实验演示

使用`IPsec Profile`演示`Gre over IPsec`。如果使用`ACL`方式的话需要配置感兴趣流和`remote`，都是两端公网地址。

![image-20251006212550816](https://qyt-gujun.oss-cn-shanghai.aliyuncs.com/20251006233626872.png)

通过`GRE over ipsec`打通两个局域网，使用`OSPF`使其成功通信。使用`NAT`让`PC1`和`PC2`成功上网。基础配置忽略，不再演示。

###### 3.5.1.GRE隧道配置

```
[FW1]security-policy 
[FW1-policy-security]rule name gre	
[FW1-policy-security-rule-gre]source-zone local untrust 
[FW1-policy-security-rule-gre]destination-zone local untrust 
[FW1-policy-security-rule-gre]action permit
[FW1-policy-security-rule-gre]quit
[FW1-policy-security]rule name tunnel
[FW1-policy-security-rule-tunnel]source-zone trust dmz	
[FW1-policy-security-rule-tunnel]destination-zone trust dmz
[FW1-policy-security-rule-tunnel]action permit
[FW1-policy-security-rule-tunnel]quit
[FW1-policy-security]quit	
[FW1]interface Tunnel 0
[FW1-Tunnel0]tunnel-protocol gre
[FW1-Tunnel0]ip add 10.10.10.1 24	
[FW1-Tunnel0]source 11.1.1.1	
[FW1-Tunnel0]destination 12.1.1.2
[FW1-Tunnel0]service-manage ping permit
[FW1-Tunnel0]quit
[FW1]firewall zone dmz
[FW1-zone-dmz]add interface Tunnel 0
[FW1-zone-dmz]quit

[FW2]security-policy 
[FW2-policy-security]rule name gre	
[FW2-policy-security-rule-gre]source-zone local untrust 
[FW2-policy-security-rule-gre]destination-zone local untrust 
[FW2-policy-security-rule-gre]action permit
[FW2-policy-security-rule-gre]quit
[FW2-policy-security]rule name tunnel
[FW2-policy-security-rule-tunnel]source-zone trust dmz	
[FW2-policy-security-rule-tunnel]destination-zone trust dmz
[FW2-policy-security-rule-tunnel]action permit
[FW2-policy-security-rule-tunnel]quit
[FW2-policy-security]quit	
[FW2]interface Tunnel 0
[FW2-Tunnel0]tunnel-protocol gre
[FW2-Tunnel0]ip add 10.10.10.2 24	
[FW2-Tunnel0]source 12.1.1.2	
[FW2-Tunnel0]destination 11.1.1.1
[FW2-Tunnel0]service-manage ping permit
[FW2-Tunnel0]quit
[FW2]firewall zone dmz
[FW2-zone-dmz]add interface Tunnel 0
[FW2-zone-dmz]quit
```

###### 3.5.2.OSPF配置

```
[FW1]ospf 1
[FW1-ospf-1]area 0
[FW1-ospf-1-area-0.0.0.0]network 10.10.10.1 0.0.0.0
[FW1-ospf-1-area-0.0.0.0]network 192.168.10.0 0.0.0.255
[FW1-ospf-1-area-0.0.0.0]quit
[FW1-ospf-1]quit

[FW2]ospf 1
[FW2-ospf-1]area 0
[FW2-ospf-1-area-0.0.0.0]network 10.10.10.2 0.0.0.0
[FW2-ospf-1-area-0.0.0.0]network 192.168.20.0 0.0.0.255
[FW2-ospf-1-area-0.0.0.0]quit
[FW2-ospf-1]quit
```

###### 3.5.3.IPsec配置

**安全策略：**

```
[FW1]security-policy 
[FW1-policy-security]rule name ipsec
[FW1-policy-security-rule-ipsec]source-zone untrust local 
[FW1-policy-security-rule-ipsec]destination-zone untrust local 
[FW1-policy-security-rule-ipsec]action permit
[FW1-policy-security-rule-ipsec]quit
[FW1-policy-security]quit

[FW2]security-policy 
[FW2-policy-security]rule name ipsec
[FW2-policy-security-rule-ipsec]source-zone untrust local 
[FW2-policy-security-rule-ipsec]destination-zone untrust local 
[FW2-policy-security-rule-ipsec]action permit
[FW2-policy-security-rule-ipsec]quit
[FW2-policy-security]quit
```

**ipsec proposal：**

```
[FW1]ipsec proposal tran1
[FW1-ipsec-proposal-tran1]quit

[FW2]ipsec proposal tran1
[FW2-ipsec-proposal-tran1]quit
```

**ike proposal：**

```
[FW1]ike proposal 5	
[FW1-ike-proposal-5]authentication-method pre-share 
[FW1-ike-proposal-5]quit

[FW2]ike proposal 5	
[FW2-ike-proposal-5]authentication-method pre-share 
[FW2-ike-proposal-5]quit
```

**ike peer：**

```
[FW1]ike peer ike	
[FW1-ike-peer-ike]ike-proposal 5	
[FW1-ike-peer-ike]pre-shared-key Huawei@123
[FW1-ike-peer-ike]quit

[FW2]ike peer ike	
[FW2-ike-peer-ike]ike-proposal 5	
[FW2-ike-peer-ike]pre-shared-key Huawei@123
[FW2-ike-peer-ike]quit
```

**ipsec安全框架：**

```
[FW1]ipsec profile pro1
[FW1-ipsec-profile-pro1]proposal tran1
[FW1-ipsec-profile-pro1]ike-peer ike
[FW1-ipsec-profile-pro1]quit

[FW2]ipsec profile pro1
[FW2-ipsec-profile-pro1]proposal tran1
[FW2-ipsec-profile-pro1]ike-peer ike
[FW2-ipsec-profile-pro1]quit
```

**应用到tunnel：**

```
[FW1]interface Tunnel 0
[FW1-Tunnel0]ipsec profile pro1
[FW1-Tunnel0]quit

[FW2]interface Tunnel 0
[FW2-Tunnel0]ipsec profile pro1
[FW2-Tunnel0]quit
```

###### 3.5.4.验证

**ike sa：**

```
[FW1]display ike sa
2025-10-06 16:00:30.050 

IKE SA information :
 Conn-ID    Peer                                          VPN              Flag(
s)               Phase  RemoteType  RemoteID        
--------------------------------------------------------------------------------
----------------------------------------------------
 5          12.1.1.2:500                                                   RD|ST
|A               v2:2   IP          12.1.1.2        
 2          12.1.1.2:500                                                   RD|ST
|A               v2:1   IP          12.1.1.2        

  Number of IKE SA : 2
--------------------------------------------------------------------------------
----------------------------------------------------

 Flag Description:
 RD--READY   ST--STAYALIVE   RL--REPLACED   FD--FADING   TO--TIMEOUT
 HRT--HEARTBEAT   LKG--LAST KNOWN GOOD SEQ NO.   BCK--BACKED UP
 M--ACTIVE   S--STANDBY   A--ALONE  NEG--NEGOTIATING
```

**ipsec sa:**

```
[FW1]display ipsec sa 
2025-10-06 16:00:50.110 

ipsec sa information:

===============================
Interface: Tunnel0
===============================

  -----------------------------
  IPSec profile name: "pro1"
  Mode              : PROF-ISAKMP
  -----------------------------
    Connection ID     : 5
    Encapsulation mode: Tunnel
    Holding time      : 0d 0h 1m 42s
    Tunnel local      : 11.1.1.1:500
    Tunnel remote     : 12.1.1.2:500
    Flow source       : 11.1.1.1/255.255.255.255 47/0-65535
    Flow destination  : 12.1.1.2/255.255.255.255 47/0-65535

    [Outbound ESP SAs] 
      SPI: 197285103 (0xbc254ef)
      Proposal: ESP-ENCRYPT-AES-256 ESP-AUTH-SHA2-256-128
      SA remaining key duration (kilobytes/sec): 10485759/3503
      Max sent sequence-number: 13
      UDP encapsulation used for NAT traversal: N
      SA encrypted packets (number/bytes): 12/1088

    [Inbound ESP SAs] 
      SPI: 191185145 (0xb6540f9)
      Proposal: ESP-ENCRYPT-AES-256 ESP-AUTH-SHA2-256-128
      SA remaining key duration (kilobytes/sec): 10485759/3503
      Max received sequence-number: 1
      UDP encapsulation used for NAT traversal: N
      SA decrypted packets (number/bytes): 13/1180
      Anti-replay : Enable
      Anti-replay window size: 1024
```

**会话表：**

```
[FW1]display firewall session table 
2025-10-06 16:01:08.720 
 Current Total Sessions : 3
 udp  VPN: public --> public  11.1.1.1:500 --> 12.1.1.2:500
 gre  VPN: public --> public  12.1.1.2:0 --> 11.1.1.1:0
 esp  VPN: public --> public  12.1.1.2:0 --> 11.1.1.1:0
```

**ipsec配置：**

```
[FW1]display ike proposal 
2025-10-06 16:01:39.250 

Number of IKE Proposals: 2

-------------------------------------------
 IKE Proposal: 5
   Authentication Method      : PRE_SHARED
   Authentication Algorithm   : SHA2-256 
   Encryption Algorithm       : AES-256 
   Diffie-Hellman Group       : MODP-2048 
   SA Duration(Seconds)       : 86400
   Integrity Algorithm        : HMAC-SHA2-256 
   Prf Algorithm              : HMAC-SHA2-256 
-------------------------------------------

-------------------------------------------
 IKE Proposal: Default
   Authentication Method      : PRE_SHARED
   Authentication Algorithm   : SHA2-512 SHA2-384 SHA2-256 
   Encryption Algorithm       : AES-256 AES-192 AES-128 
   Diffie-Hellman Group       : MODP-2048 
   SA Duration(Seconds)       : 86400
   Integrity Algorithm        : HMAC-SHA2-256 
   Prf Algorithm              : HMAC-SHA2-256 
-------------------------------------------
```

